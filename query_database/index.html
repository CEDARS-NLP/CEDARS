<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>Querying the Database - CEDARS</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../assets/_mkdocstrings.css" rel="stylesheet" />
        <link href="../style.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Querying the Database";
        var mkdocs_page_input_path = "query_database.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="..">
          <img src="../pics/cedar_G_centered.png" class="logo" alt="Logo"/>
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">Overview</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../ABOUT/">About</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../CEDARS_admin_manual/">Administrator Manual</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../CEDARS_annotator_manual/">Annotator Manual</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../TERMS_OF_USE/">Terms of Use</a>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">CEDARS</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">Querying the Database</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="querying-the-database">Querying the Database</h1>
<p>To search for medical events using CEDARS you will need to write a <a href="https://en.wikipedia.org/wiki/Regular_expression">regex</a> query. For more information regarding these queries, you can refer to the Basic Concepts section of the documentation. After you enter a query, click submit and the NLP algorithm will run on the database and save instances of the event when it is found. After the database has been searched, you will be redirected to the Adjudications page where you can view the search results.</p>
<h1 id="important-note">Important Note</h1>
<p>Keep in mind that entering a new query will erase all records of the prior query and so you are advised to download a copy of the results of prior queries before entering a new one.</p>
<h1 id="reference">Reference</h1>


<div class="doc doc-object doc-module">



<a id="cedars.app.ops.db"></a>
    <div class="doc doc-contents first">

        <p>This file contatins an abstract class for CEDARS to interact with mongodb.</p>








  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h2 id="cedars.app.ops.db.add_comment" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_comment</span><span class="p">(</span><span class="n">annotation_id</span><span class="p">,</span> <span class="n">comment</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Stores a new comment for a patient.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>annotation_id</code></b>
                  (<code>str) </code>)
              –
              <div class="doc-md-description">
                <p>Unique ID for the annotation.</p>
              </div>
            </li>
            <li>
              <b><code>comment</code></b>
                  (<code>str) </code>)
              –
              <div class="doc-md-description">
                <p>Text of the comment on this annotation.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>        <p>Returns:
    None</p>

            <details class="quote">
              <summary>Source code in <code>cedars/app/db.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1500</span>
<span class="normal">1501</span>
<span class="normal">1502</span>
<span class="normal">1503</span>
<span class="normal">1504</span>
<span class="normal">1505</span>
<span class="normal">1506</span>
<span class="normal">1507</span>
<span class="normal">1508</span>
<span class="normal">1509</span>
<span class="normal">1510</span>
<span class="normal">1511</span>
<span class="normal">1512</span>
<span class="normal">1513</span>
<span class="normal">1514</span>
<span class="normal">1515</span>
<span class="normal">1516</span>
<span class="normal">1517</span>
<span class="normal">1518</span>
<span class="normal">1519</span>
<span class="normal">1520</span>
<span class="normal">1521</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">add_comment</span><span class="p">(</span><span class="n">annotation_id</span><span class="p">,</span> <span class="n">comment</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Stores a new comment for a patient.</span>

<span class="sd">    Args:</span>
<span class="sd">        annotation_id (str) : Unique ID for the annotation.</span>
<span class="sd">        comment (str) : Text of the comment on this annotation.</span>
<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">comment</span> <span class="o">=</span> <span class="n">comment</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">comment</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Comment deleted on annotation # </span><span class="si">{</span><span class="n">annotation_id</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Adding comment to annotation #</span><span class="si">{</span><span class="n">annotation_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">patient_id</span> <span class="o">=</span> <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;ANNOTATIONS&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">find_one</span><span class="p">(</span>
        <span class="p">{</span><span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="n">ObjectId</span><span class="p">(</span><span class="n">annotation_id</span><span class="p">)})[</span><span class="s2">&quot;patient_id&quot;</span><span class="p">]</span>

    <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;PATIENTS&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update_one</span><span class="p">({</span><span class="s2">&quot;patient_id&quot;</span><span class="p">:</span> <span class="n">patient_id</span><span class="p">},</span>
                                    <span class="p">{</span><span class="s2">&quot;$set&quot;</span><span class="p">:</span>
                                     <span class="p">{</span><span class="s2">&quot;comments&quot;</span><span class="p">:</span> <span class="n">comment</span><span class="p">}</span>
                                     <span class="p">})</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="cedars.app.ops.db.add_task" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_task</span><span class="p">(</span><span class="n">task</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Launch a task and add it to Mongo if it doesn't already exist.</p>
<h3 id="cedars.app.ops.db.add_task--todo-insert-only-one">TODO: insert only one</h3>

            <details class="quote">
              <summary>Source code in <code>cedars/app/db.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1822</span>
<span class="normal">1823</span>
<span class="normal">1824</span>
<span class="normal">1825</span>
<span class="normal">1826</span>
<span class="normal">1827</span>
<span class="normal">1828</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">add_task</span><span class="p">(</span><span class="n">task</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Launch a task and add it to Mongo if it doesn&#39;t already exist.</span>
<span class="sd">    # TODO: insert only one</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">task_db</span> <span class="o">=</span> <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;TASK&quot;</span><span class="p">]</span>
    <span class="n">task_db</span><span class="o">.</span><span class="n">insert_one</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="cedars.app.ops.db.add_user" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_user</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">is_admin</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>This function is used to add a new user to the database.
All this data is kept in the USERS collection.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>username</code></b>
                  (<code>str) </code>)
              –
              <div class="doc-md-description">
                <p>The name of this user.</p>
              </div>
            </li>
            <li>
              <b><code>password</code></b>
                  (<code>str) </code>)
              –
              <div class="doc-md-description">
                <p>The password this user will need to login to the system.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>        <p>Returns:
    None</p>

            <details class="quote">
              <summary>Source code in <code>cedars/app/db.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">add_user</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">is_admin</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function is used to add a new user to the database.</span>
<span class="sd">    All this data is kept in the USERS collection.</span>

<span class="sd">    Args:</span>
<span class="sd">        username (str) : The name of this user.</span>
<span class="sd">        password (str) : The password this user will need to login to the system.</span>
<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">info</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;user&quot;</span><span class="p">:</span> <span class="n">username</span><span class="p">,</span>
        <span class="s2">&quot;password&quot;</span><span class="p">:</span> <span class="n">password</span><span class="p">,</span>
        <span class="s2">&quot;is_admin&quot;</span><span class="p">:</span> <span class="n">is_admin</span><span class="p">,</span>
        <span class="s2">&quot;date_created&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    <span class="p">}</span>
    <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;USERS&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">insert_one</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Added user </span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s2"> to database.&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="cedars.app.ops.db.bulk_upsert_patients" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">bulk_upsert_patients</span><span class="p">(</span><span class="n">patient_ids</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>This function will automatically create default enteries in the
PATIENTS and RESULTS collection for each patient. The order in which
the patients are uploaded will be maintained using an index_no field.</p>
<p>For compatibility with older versions of CEDARS without the index_no field,
mongodb will ignore the sorting step and the program will continue as normal.</p>


<details class="args-" open>
  <summary>Args</summary>
  <ul>
<li>patient_ids (list[str]) : List of all uploaded patient IDs in order.</li>
</ul>
</details>

<details class="returns-" open>
  <summary>Returns</summary>
  <ul>
<li>total patients and results uploaded</li>
</ul>
</details>
            <details class="quote">
              <summary>Source code in <code>cedars/app/db.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">bulk_upsert_patients</span><span class="p">(</span><span class="n">patient_ids</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This function will automatically create default enteries in the</span>
<span class="sd">    PATIENTS and RESULTS collection for each patient. The order in which</span>
<span class="sd">    the patients are uploaded will be maintained using an index_no field.</span>

<span class="sd">    For compatibility with older versions of CEDARS without the index_no field,</span>
<span class="sd">    mongodb will ignore the sorting step and the program will continue as normal.</span>

<span class="sd">    Args :</span>
<span class="sd">        - patient_ids (list[str]) : List of all uploaded patient IDs in order.</span>

<span class="sd">    Returns :</span>
<span class="sd">        - total patients and results uploaded</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">patients_collection</span> <span class="o">=</span> <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;PATIENTS&quot;</span><span class="p">]</span>
    <span class="n">results_collection</span> <span class="o">=</span> <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;RESULTS&quot;</span><span class="p">]</span>
    <span class="n">patient_operations</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">results_operations</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">number_of_patients_in_db</span> <span class="o">=</span> <span class="n">patients_collection</span><span class="o">.</span><span class="n">count_documents</span><span class="p">({})</span>

    <span class="c1"># get cached note summary for all patients where each patient is a key</span>
    <span class="n">notes_summary_dict</span> <span class="o">=</span> <span class="n">get_notes_summary</span><span class="p">()</span>


    <span class="k">for</span> <span class="n">index_no</span><span class="p">,</span> <span class="n">p_id</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">patient_ids</span><span class="p">):</span>
        <span class="c1"># Update the index in cases where a batch of patients</span>
        <span class="c1"># has been added after the initial batch.</span>

        <span class="n">index_no</span> <span class="o">+=</span> <span class="n">number_of_patients_in_db</span>
        <span class="n">p_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">p_id</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="n">patient_op</span> <span class="o">=</span> <span class="n">generate_patient_entry</span><span class="p">(</span><span class="n">p_id</span><span class="p">,</span> <span class="n">index_no</span><span class="p">)</span>
        <span class="n">patient_operations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">patient_op</span><span class="p">)</span>

        <span class="n">results_op</span> <span class="o">=</span> <span class="n">generate_results_entry</span><span class="p">(</span><span class="n">p_id</span><span class="p">,</span> <span class="n">index_no</span><span class="p">,</span> 
                                            <span class="n">first_note_date</span><span class="o">=</span><span class="n">notes_summary_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">p_id</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;first_note_date&quot;</span><span class="p">),</span>
                                            <span class="n">last_note_date</span><span class="o">=</span><span class="n">notes_summary_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">p_id</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;last_note_date&quot;</span><span class="p">),</span>
                                            <span class="n">num_notes</span><span class="o">=</span><span class="n">notes_summary_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">p_id</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;num_notes&quot;</span><span class="p">))</span>
        <span class="n">results_operations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">results_op</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        While we want to maintain the order in which patients are uploaded,</span>
<span class="sd">        we ensure this order using the index_no field. For this reason we can</span>
<span class="sd">        set ordered=False when performing a bulk write to maintain high speeds</span>
<span class="sd">        while maintaining the correct order when showing patients to the user.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># bulk write in chunks</span>
        <span class="n">chunk_size</span> <span class="o">=</span> <span class="mi">2000</span>
        <span class="n">total_uploaded_patients</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">total_uploaded_results</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">patient_operations</span><span class="p">),</span> <span class="n">chunk_size</span><span class="p">):</span>
            <span class="n">patients_update</span> <span class="o">=</span> <span class="n">patients_collection</span><span class="o">.</span><span class="n">bulk_write</span><span class="p">(</span><span class="n">patient_operations</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">chunk_size</span><span class="p">],</span>
                                                            <span class="n">ordered</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">total_uploaded_patients</span> <span class="o">+=</span> <span class="n">patients_update</span><span class="o">.</span><span class="n">upserted_count</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">results_operations</span><span class="p">),</span> <span class="n">chunk_size</span><span class="p">):</span>
            <span class="n">results_update</span> <span class="o">=</span> <span class="n">results_collection</span><span class="o">.</span><span class="n">bulk_write</span><span class="p">(</span><span class="n">results_operations</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">chunk_size</span><span class="p">],</span>
                                                            <span class="n">ordered</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">total_uploaded_results</span> <span class="o">+=</span> <span class="n">results_update</span><span class="o">.</span><span class="n">upserted_count</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Inserted </span><span class="si">{</span><span class="n">total_uploaded_patients</span><span class="si">}</span><span class="s2"> patients and </span><span class="si">{</span><span class="n">total_uploaded_results</span><span class="si">}</span><span class="s2"> results.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">total_uploaded_patients</span><span class="p">,</span> <span class="n">total_uploaded_results</span>
    <span class="k">except</span> <span class="n">BulkWriteError</span> <span class="k">as</span> <span class="n">bwe</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Bulk write error: </span><span class="si">{</span><span class="n">bwe</span><span class="o">.</span><span class="n">details</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="cedars.app.ops.db.check_password" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">check_password</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Checks if the password matches the password of that user from the database.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>username</code></b>
                  (<code>str) </code>)
              –
              <div class="doc-md-description">
                <p>The name of the new user</p>
              </div>
            </li>
            <li>
              <b><code>password</code></b>
                  (<code>str) </code>)
              –
              <div class="doc-md-description">
                <p>The password entered by the user.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              –
              <div class="doc-md-description">
                <p>(bool) : True if the password matches the password of that user from the database.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
            <details class="quote">
              <summary>Source code in <code>cedars/app/db.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1586</span>
<span class="normal">1587</span>
<span class="normal">1588</span>
<span class="normal">1589</span>
<span class="normal">1590</span>
<span class="normal">1591</span>
<span class="normal">1592</span>
<span class="normal">1593</span>
<span class="normal">1594</span>
<span class="normal">1595</span>
<span class="normal">1596</span>
<span class="normal">1597</span>
<span class="normal">1598</span>
<span class="normal">1599</span>
<span class="normal">1600</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">check_password</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Checks if the password matches the password of that user from the database.</span>

<span class="sd">    Args:</span>
<span class="sd">        username (str) : The name of the new user</span>
<span class="sd">        password (str) : The password entered by the user.</span>

<span class="sd">    Returns:</span>
<span class="sd">        (bool) : True if the password matches the password of that user from the database.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">user</span> <span class="o">=</span> <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;USERS&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">find_one</span><span class="p">({</span><span class="s2">&quot;user&quot;</span><span class="p">:</span> <span class="n">username</span><span class="p">})</span>

    <span class="k">return</span> <span class="s2">&quot;password&quot;</span> <span class="ow">in</span> <span class="n">user</span> <span class="ow">and</span> <span class="n">check_password_hash</span><span class="p">(</span><span class="n">user</span><span class="p">[</span><span class="s2">&quot;password&quot;</span><span class="p">],</span> <span class="n">password</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="cedars.app.ops.db.create_annotation_indices" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">create_annotation_indices</span><span class="p">()</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Creates indices for the ANNOTATIONS col in the db.
This is maintained as a seperate function as this collection
requires many more indices than the others and it is easier
to organise all of the commands in one place.</p>

            <details class="quote">
              <summary>Source code in <code>cedars/app/db.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">create_annotation_indices</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Creates indices for the ANNOTATIONS col in the db.</span>
<span class="sd">    This is maintained as a seperate function as this collection</span>
<span class="sd">    requires many more indices than the others and it is easier</span>
<span class="sd">    to organise all of the commands in one place.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Creating indexes for ANNOTATIONS.&quot;</span><span class="p">)</span>
    <span class="n">create_index</span><span class="p">(</span><span class="s2">&quot;ANNOTATIONS&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;patient_id&quot;</span><span class="p">,</span> <span class="s2">&quot;note_id&quot;</span><span class="p">])</span>
    <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;ANNOTATIONS&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">create_index</span><span class="p">([(</span><span class="s2">&quot;patient_id&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;isNegated&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                                        <span class="p">(</span><span class="s2">&quot;text_date&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;note_id&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;note_start_index&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="p">])</span>
    <span class="n">create_index</span><span class="p">(</span><span class="s2">&quot;ANNOTATIONS&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;patient_id&quot;</span><span class="p">,</span> <span class="s2">&quot;text_date&quot;</span><span class="p">,</span> <span class="s2">&quot;reviewed&quot;</span><span class="p">])</span>
    <span class="n">create_index</span><span class="p">(</span><span class="s2">&quot;ANNOTATIONS&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;note_id&quot;</span><span class="p">,</span> <span class="s2">&quot;reviewed&quot;</span><span class="p">])</span>
    <span class="n">create_index</span><span class="p">(</span><span class="s2">&quot;ANNOTATIONS&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;patient_id&quot;</span><span class="p">,</span> <span class="s2">&quot;reviewed&quot;</span><span class="p">])</span>

    <span class="c1"># Index for get_all_annotations_for_note</span>
    <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;ANNOTATIONS&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">create_index</span><span class="p">([(</span><span class="s2">&quot;note_id&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;isNegated&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                                        <span class="p">(</span><span class="s2">&quot;text_date&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;sentence_number&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)])</span>

    <span class="c1"># Index for get_all_annotations_for_sentence</span>
    <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;ANNOTATIONS&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">create_index</span><span class="p">([(</span><span class="s2">&quot;note_id&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;isNegated&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                                        <span class="p">(</span><span class="s2">&quot;text_date&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;sentence_number&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                                        <span class="p">(</span><span class="s2">&quot;note_start_index&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)])</span>

    <span class="c1"># Index for get_patient_annotation_ids</span>
    <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;ANNOTATIONS&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">create_index</span><span class="p">([(</span><span class="s2">&quot;patient_id&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;isNegated&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                                        <span class="p">(</span><span class="s2">&quot;reviewed&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;sentence_number&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                                        <span class="p">(</span><span class="s2">&quot;note_id&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;text_date&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)])</span>

    <span class="c1"># Index for get_annotations_post_event</span>
    <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;ANNOTATIONS&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">create_index</span><span class="p">([(</span><span class="s2">&quot;patient_id&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                                        <span class="p">(</span><span class="s2">&quot;reviewed&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;text_date&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)])</span>

    <span class="c1"># Index for get_annotated_notes_for_patient</span>
    <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;ANNOTATIONS&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">create_index</span><span class="p">([(</span><span class="s2">&quot;patient_id&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;note_start_index&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                                        <span class="p">(</span><span class="s2">&quot;note_id&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;text_date&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)])</span>

    <span class="c1"># Index for mark_annotation_reviewed (note reviewed lookup query)</span>
    <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;ANNOTATIONS&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">create_index</span><span class="p">([(</span><span class="s2">&quot;note_id&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;reviewed&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)])</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="cedars.app.ops.db.create_db_indices" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">create_db_indices</span><span class="p">()</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Creates indices for all of the cols in the db.</p>

            <details class="quote">
              <summary>Source code in <code>cedars/app/db.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">create_db_indices</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Creates indices for all of the cols in the db.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;All tasks completed.&quot;</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Creating indexes for NOTES.&quot;</span><span class="p">)</span>
    <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;NOTES&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">create_index</span><span class="p">([(</span><span class="s2">&quot;text_id&quot;</span><span class="p">,</span> <span class="mi">1</span> <span class="p">)],</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;NOTES&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">create_index</span><span class="p">([(</span><span class="s2">&quot;patient_id&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)])</span>
    <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;NOTES&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">create_index</span><span class="p">([(</span><span class="s2">&quot;patient_id&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;text_id&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)],</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Creating indexes for PATIENTS.&quot;</span><span class="p">)</span>
    <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;PATIENTS&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">create_index</span><span class="p">([(</span><span class="s2">&quot;patient_id&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)],</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">create_annotation_indices</span><span class="p">()</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Creating indexes for PINES.&quot;</span><span class="p">)</span>
    <span class="n">create_index</span><span class="p">(</span><span class="s2">&quot;PINES&quot;</span><span class="p">,</span> <span class="p">[(</span><span class="s2">&quot;text_id&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;unique&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})])</span>
    <span class="n">create_index</span><span class="p">(</span><span class="s2">&quot;PINES&quot;</span><span class="p">,</span> <span class="p">[(</span><span class="s2">&quot;patient_id&quot;</span><span class="p">)])</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Creating indexes for USERS.&quot;</span><span class="p">)</span>
    <span class="n">create_index</span><span class="p">(</span><span class="s2">&quot;USERS&quot;</span><span class="p">,</span> <span class="p">[(</span><span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;unique&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})])</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Creating indexes for RESULTS.&quot;</span><span class="p">)</span>
    <span class="n">create_index</span><span class="p">(</span><span class="s2">&quot;RESULTS&quot;</span><span class="p">,</span> <span class="p">[(</span><span class="s2">&quot;patient_id&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;unique&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})])</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Creating indexes for NOTES_SUMMARY.&quot;</span><span class="p">)</span>
    <span class="n">create_index</span><span class="p">(</span><span class="s2">&quot;NOTES_SUMMARY&quot;</span><span class="p">,</span> <span class="p">[(</span><span class="s2">&quot;patient_id&quot;</span><span class="p">)])</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Creating indexes for USERS.&quot;</span><span class="p">)</span>
    <span class="n">create_index</span><span class="p">(</span><span class="s2">&quot;USERS&quot;</span><span class="p">,</span> <span class="p">[(</span><span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;unique&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})])</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Creating indexes for TASK.&quot;</span><span class="p">)</span>
    <span class="n">create_index</span><span class="p">(</span><span class="s2">&quot;TASK&quot;</span><span class="p">,</span> <span class="p">[(</span><span class="s2">&quot;job_id&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;unique&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})])</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="cedars.app.ops.db.create_index" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">create_index</span><span class="p">(</span><span class="n">collection</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>This function is used to create an index in a collection
Add support for features such as unique=True etc</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>collection</code></b>
                  (<code>str) </code>)
              –
              <div class="doc-md-description">
                <p>The name of the collection to create the index in.</p>
              </div>
            </li>
            <li>
              <b><code>index</code></b>
                  (<code>str|tuple) </code>)
              –
              <div class="doc-md-description">
                <p>The name of the index to create or a tuple with the name and options.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
            <details class="quote">
              <summary>Source code in <code>cedars/app/db.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">create_index</span><span class="p">(</span><span class="n">collection</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function is used to create an index in a collection</span>
<span class="sd">    Add support for features such as unique=True etc</span>

<span class="sd">    Args:</span>
<span class="sd">        collection (str) : The name of the collection to create the index in.</span>
<span class="sd">        index (str|tuple) : The name of the index to create or a tuple with the name and options.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">index</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="n">collection</span><span class="p">]</span><span class="o">.</span><span class="n">create_index</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">**</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="n">collection</span><span class="p">]</span><span class="o">.</span><span class="n">create_index</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Created index </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> in collection </span><span class="si">{</span><span class="n">collection</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="cedars.app.ops.db.create_info_col" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">create_info_col</span><span class="p">(</span><span class="n">project_name</span><span class="p">,</span> <span class="n">project_id</span><span class="p">,</span> <span class="n">investigator_name</span><span class="p">,</span> <span class="n">cedars_version</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>This function creates the info collection in the mongodb database.
The info collection is used to store meta-data regarding the current project.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>project_name</code></b>
                  (<code>str) </code>)
              –
              <div class="doc-md-description">
                <p>Name of the research project</p>
              </div>
            </li>
            <li>
              <b><code>investigator_name</code></b>
                  (<code>str) </code>)
              –
              <div class="doc-md-description">
                <p>Name of the investigator on this project</p>
              </div>
            </li>
            <li>
              <b><code>cedars_version</code></b>
                  (<code>str) </code>)
              –
              <div class="doc-md-description">
                <p>Version of CEDARS used for this project</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>        <p>Returns:
    None</p>

            <details class="quote">
              <summary>Source code in <code>cedars/app/db.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span>
<span class="normal">94</span>
<span class="normal">95</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">create_info_col</span><span class="p">(</span><span class="n">project_name</span><span class="p">,</span>
                    <span class="n">project_id</span><span class="p">,</span>
                    <span class="n">investigator_name</span><span class="p">,</span>
                    <span class="n">cedars_version</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function creates the info collection in the mongodb database.</span>
<span class="sd">    The info collection is used to store meta-data regarding the current project.</span>

<span class="sd">    Args:</span>
<span class="sd">        project_name (str) : Name of the research project</span>
<span class="sd">        investigator_name (str) : Name of the investigator on this project</span>
<span class="sd">        cedars_version (str) : Version of CEDARS used for this project</span>
<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">collection</span> <span class="o">=</span> <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;INFO&quot;</span><span class="p">]</span>

    <span class="n">info</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;creation_time&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
            <span class="s2">&quot;project&quot;</span><span class="p">:</span> <span class="n">project_name</span><span class="p">,</span>
            <span class="s2">&quot;project_id&quot;</span><span class="p">:</span> <span class="n">project_id</span><span class="p">,</span>
            <span class="s2">&quot;investigator&quot;</span><span class="p">:</span> <span class="n">investigator_name</span><span class="p">,</span>
            <span class="s2">&quot;CEDARS_version&quot;</span><span class="p">:</span> <span class="n">cedars_version</span><span class="p">}</span>

    <span class="n">collection</span><span class="o">.</span><span class="n">insert_one</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Created INFO collection.&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="cedars.app.ops.db.create_pines_info" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">create_pines_info</span><span class="p">(</span><span class="n">pines_url</span><span class="p">,</span> <span class="n">is_url_from_api</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Retrives the PINES url from the relevant source and
    updates the INFO col with the information.</p>

            <details class="quote">
              <summary>Source code in <code>cedars/app/db.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">create_pines_info</span><span class="p">(</span><span class="n">pines_url</span><span class="p">,</span> <span class="n">is_url_from_api</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrives the PINES url from the relevant source and</span>
<span class="sd">        updates the INFO col with the information.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">update_pines_api_url</span><span class="p">(</span><span class="n">pines_url</span><span class="p">)</span>
    <span class="n">update_pines_api_status</span><span class="p">(</span><span class="n">is_url_from_api</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pines_url</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="cedars.app.ops.db.create_project" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">create_project</span><span class="p">(</span><span class="n">project_name</span><span class="p">,</span> <span class="n">investigator_name</span><span class="p">,</span> <span class="n">project_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cedars_version</span><span class="o">=</span><span class="s1">&#39;0.1.0&#39;</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>This function creates all the collections in the mongodb database for CEDARS.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>project_name</code></b>
                  (<code>str) </code>)
              –
              <div class="doc-md-description">
                <p>Name of the research project</p>
              </div>
            </li>
            <li>
              <b><code>investigator_name</code></b>
                  (<code>str) </code>)
              –
              <div class="doc-md-description">
                <p>Name of the investigator on this project</p>
              </div>
            </li>
            <li>
              <b><code>cedars_version</code></b>
                  (<code>str) </code>, default:
                      <code>&#39;0.1.0&#39;</code>
)
              –
              <div class="doc-md-description">
                <p>Version of CEDARS used for this project</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>        <p>Returns:
    None</p>

            <details class="quote">
              <summary>Source code in <code>cedars/app/db.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">create_project</span><span class="p">(</span><span class="n">project_name</span><span class="p">,</span>
                   <span class="n">investigator_name</span><span class="p">,</span>
                   <span class="n">project_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">cedars_version</span><span class="o">=</span><span class="s2">&quot;0.1.0&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function creates all the collections in the mongodb database for CEDARS.</span>

<span class="sd">    Args:</span>
<span class="sd">        project_name (str) : Name of the research project</span>
<span class="sd">        investigator_name (str) : Name of the investigator on this project</span>
<span class="sd">        cedars_version (str) : Version of CEDARS used for this project</span>
<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">create_db_indices</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;INFO&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">find_one</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Database already created.&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">if</span> <span class="n">project_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">project_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid4</span><span class="p">())</span>

    <span class="n">create_info_col</span><span class="p">(</span><span class="n">project_name</span><span class="o">=</span><span class="n">project_name</span><span class="p">,</span>
                    <span class="n">project_id</span><span class="o">=</span><span class="n">project_id</span><span class="p">,</span>
                    <span class="n">investigator_name</span><span class="o">=</span><span class="n">investigator_name</span><span class="p">,</span>
                    <span class="n">cedars_version</span><span class="o">=</span><span class="n">cedars_version</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Database creation successful!&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="cedars.app.ops.db.delete_event_annotation_id" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">delete_event_annotation_id</span><span class="p">(</span><span class="n">patient_id</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Deletes the ID for the annotation where 
        the event date for a patient was found.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>patient_id</code></b>
                  (<code>str) </code>)
              –
              <div class="doc-md-description">
                <p>Unique ID for the patient.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>        <p>Returns:
    None</p>

            <details class="quote">
              <summary>Source code in <code>cedars/app/db.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1436</span>
<span class="normal">1437</span>
<span class="normal">1438</span>
<span class="normal">1439</span>
<span class="normal">1440</span>
<span class="normal">1441</span>
<span class="normal">1442</span>
<span class="normal">1443</span>
<span class="normal">1444</span>
<span class="normal">1445</span>
<span class="normal">1446</span>
<span class="normal">1447</span>
<span class="normal">1448</span>
<span class="normal">1449</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">delete_event_annotation_id</span><span class="p">(</span><span class="n">patient_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Deletes the ID for the annotation where </span>
<span class="sd">            the event date for a patient was found.</span>

<span class="sd">    Args:</span>
<span class="sd">        patient_id (str) : Unique ID for the patient.</span>
<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Deleting event_annotation_id on patient #</span><span class="si">{</span><span class="n">patient_id</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

    <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;PATIENTS&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update_one</span><span class="p">({</span><span class="s2">&quot;patient_id&quot;</span><span class="p">:</span> <span class="n">patient_id</span><span class="p">},</span>
                                       <span class="p">{</span><span class="s2">&quot;$set&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;event_annotation_id&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}})</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="cedars.app.ops.db.delete_event_date" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">delete_event_date</span><span class="p">(</span><span class="n">patient_id</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Deletes the event date for a patient.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>patient_id</code></b>
                  (<code>str) </code>)
              –
              <div class="doc-md-description">
                <p>Unique ID for the patient.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>        <p>Returns:
    None</p>

            <details class="quote">
              <summary>Source code in <code>cedars/app/db.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1384</span>
<span class="normal">1385</span>
<span class="normal">1386</span>
<span class="normal">1387</span>
<span class="normal">1388</span>
<span class="normal">1389</span>
<span class="normal">1390</span>
<span class="normal">1391</span>
<span class="normal">1392</span>
<span class="normal">1393</span>
<span class="normal">1394</span>
<span class="normal">1395</span>
<span class="normal">1396</span>
<span class="normal">1397</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">delete_event_date</span><span class="p">(</span><span class="n">patient_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Deletes the event date for a patient.</span>

<span class="sd">    Args:</span>
<span class="sd">        patient_id (str) : Unique ID for the patient.</span>
<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Deleting date on patient #</span><span class="si">{</span><span class="n">patient_id</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

    <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;PATIENTS&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update_one</span><span class="p">({</span><span class="s2">&quot;patient_id&quot;</span><span class="p">:</span> <span class="n">patient_id</span><span class="p">},</span>
                                       <span class="p">{</span><span class="s2">&quot;$set&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;event_date&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}})</span>
    <span class="n">delete_event_annotation_id</span><span class="p">(</span><span class="n">patient_id</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="cedars.app.ops.db.download_annotations" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">download_annotations</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;annotations.csv&#39;</span><span class="p">,</span> <span class="n">get_sentences</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Download annotations from the database and stream them to MinIO.</p>

            <details class="quote">
              <summary>Source code in <code>cedars/app/db.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1935</span>
<span class="normal">1936</span>
<span class="normal">1937</span>
<span class="normal">1938</span>
<span class="normal">1939</span>
<span class="normal">1940</span>
<span class="normal">1941</span>
<span class="normal">1942</span>
<span class="normal">1943</span>
<span class="normal">1944</span>
<span class="normal">1945</span>
<span class="normal">1946</span>
<span class="normal">1947</span>
<span class="normal">1948</span>
<span class="normal">1949</span>
<span class="normal">1950</span>
<span class="normal">1951</span>
<span class="normal">1952</span>
<span class="normal">1953</span>
<span class="normal">1954</span>
<span class="normal">1955</span>
<span class="normal">1956</span>
<span class="normal">1957</span>
<span class="normal">1958</span>
<span class="normal">1959</span>
<span class="normal">1960</span>
<span class="normal">1961</span>
<span class="normal">1962</span>
<span class="normal">1963</span>
<span class="normal">1964</span>
<span class="normal">1965</span>
<span class="normal">1966</span>
<span class="normal">1967</span>
<span class="normal">1968</span>
<span class="normal">1969</span>
<span class="normal">1970</span>
<span class="normal">1971</span>
<span class="normal">1972</span>
<span class="normal">1973</span>
<span class="normal">1974</span>
<span class="normal">1975</span>
<span class="normal">1976</span>
<span class="normal">1977</span>
<span class="normal">1978</span>
<span class="normal">1979</span>
<span class="normal">1980</span>
<span class="normal">1981</span>
<span class="normal">1982</span>
<span class="normal">1983</span>
<span class="normal">1984</span>
<span class="normal">1985</span>
<span class="normal">1986</span>
<span class="normal">1987</span>
<span class="normal">1988</span>
<span class="normal">1989</span>
<span class="normal">1990</span>
<span class="normal">1991</span>
<span class="normal">1992</span>
<span class="normal">1993</span>
<span class="normal">1994</span>
<span class="normal">1995</span>
<span class="normal">1996</span>
<span class="normal">1997</span>
<span class="normal">1998</span>
<span class="normal">1999</span>
<span class="normal">2000</span>
<span class="normal">2001</span>
<span class="normal">2002</span>
<span class="normal">2003</span>
<span class="normal">2004</span>
<span class="normal">2005</span>
<span class="normal">2006</span>
<span class="normal">2007</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">download_annotations</span><span class="p">(</span><span class="n">filename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;annotations.csv&quot;</span><span class="p">,</span> <span class="n">get_sentences</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Download annotations from the database and stream them to MinIO.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">schema</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;patient_id&#39;</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Utf8</span><span class="p">,</span>
        <span class="s1">&#39;total_notes&#39;</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Int64</span><span class="p">,</span>
        <span class="s1">&#39;reviewed_notes&#39;</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Int64</span><span class="p">,</span>
        <span class="s1">&#39;total_sentences&#39;</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Int64</span><span class="p">,</span>
        <span class="s1">&#39;reviewed_sentences&#39;</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Int64</span><span class="p">,</span>
        <span class="s1">&#39;sentences&#39;</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Utf8</span><span class="p">,</span>
        <span class="s1">&#39;event_date&#39;</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Datetime</span><span class="p">,</span>
        <span class="s1">&#39;event_information&#39;</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Utf8</span><span class="p">,</span>
        <span class="s1">&#39;first_note_date&#39;</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Datetime</span><span class="p">,</span>
        <span class="s1">&#39;last_note_date&#39;</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Datetime</span><span class="p">,</span>
        <span class="s1">&#39;comments&#39;</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Utf8</span><span class="p">,</span>
        <span class="s1">&#39;reviewer&#39;</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Utf8</span><span class="p">,</span>
        <span class="s1">&#39;max_score_note_id&#39;</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Utf8</span><span class="p">,</span>
        <span class="s1">&#39;max_score_note_date&#39;</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Datetime</span><span class="p">,</span>
        <span class="s1">&#39;max_score&#39;</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Float64</span><span class="p">,</span>
        <span class="s1">&#39;predicted_notes&#39;</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Utf8</span><span class="p">,</span>
        <span class="s1">&#39;last_updated&#39;</span> <span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Datetime</span>
    <span class="p">}</span>

    <span class="k">if</span>  <span class="n">get_sentences</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">schema</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;sentences&#39;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Create an in-memory buffer for the CSV data</span>
        <span class="n">csv_buffer</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
        <span class="n">writer</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">schema</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">csv_buffer</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Write data in chunks and stream to MinIO</span>
        <span class="n">columns_to_retrive</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;_id&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>
        <span class="n">columns_to_retrive</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">column</span> <span class="p">:</span> <span class="kc">True</span> <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">schema</span><span class="o">.</span><span class="n">keys</span><span class="p">()})</span>

        <span class="c1"># Sorting results by index_no to maintain upload order</span>
        <span class="c1"># Mongodb will ignore this command if index_no does not exist.</span>
        <span class="c1"># This is improtant for backwards compatibility,</span>
        <span class="c1"># as the index_no will not be present in older CEDARS versions.</span>
        <span class="n">project_results</span> <span class="o">=</span> <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;RESULTS&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">({},</span>
                                                    <span class="n">columns_to_retrive</span><span class="p">)</span><span class="o">.</span><span class="n">sort</span><span class="p">([(</span><span class="s2">&quot;index_no&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)])</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">project_results</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s2">&quot;row&quot;</span><span class="p">,</span>
                                           <span class="n">schema</span><span class="o">=</span><span class="n">schema</span><span class="p">,</span>
                                           <span class="n">infer_schema_length</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="n">date_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;first_note_date&#39;</span><span class="p">,</span> <span class="s1">&#39;last_note_date&#39;</span><span class="p">,</span> <span class="s1">&#39;event_date&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">date_cols</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">col</span><span class="p">)</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">write_csv</span><span class="p">(</span><span class="n">include_header</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
            <span class="n">csv_buffer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>

        <span class="c1"># Move the cursor to the beginning of the buffer</span>
        <span class="n">csv_buffer</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">data_bytes</span> <span class="o">=</span> <span class="n">csv_buffer</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="n">data_stream</span> <span class="o">=</span> <span class="n">BytesIO</span><span class="p">(</span><span class="n">data_bytes</span><span class="p">)</span>

        <span class="c1"># Upload to MinIO</span>
        <span class="n">minio</span><span class="o">.</span><span class="n">put_object</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">bucket_name</span><span class="p">,</span>
                         <span class="sa">f</span><span class="s2">&quot;annotated_files/</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                         <span class="n">data_stream</span><span class="p">,</span>
                         <span class="n">length</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">data_bytes</span><span class="p">),</span>
                         <span class="n">content_type</span><span class="o">=</span><span class="s2">&quot;application/csv&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Uploaded annotations to s3: </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to upload annotations to s3: </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">, error: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="cedars.app.ops.db.drop_database" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">drop_database</span><span class="p">(</span><span class="n">name</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Clean Database</p>

            <details class="quote">
              <summary>Source code in <code>cedars/app/db.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1580</span>
<span class="normal">1581</span>
<span class="normal">1582</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">drop_database</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Clean Database&quot;&quot;&quot;</span>
    <span class="n">mongo</span><span class="o">.</span><span class="n">cx</span><span class="o">.</span><span class="n">drop_database</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="cedars.app.ops.db.empty_annotations" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">empty_annotations</span><span class="p">()</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Deletes all annotations from the database</p>

            <details class="quote">
              <summary>Source code in <code>cedars/app/db.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1566</span>
<span class="normal">1567</span>
<span class="normal">1568</span>
<span class="normal">1569</span>
<span class="normal">1570</span>
<span class="normal">1571</span>
<span class="normal">1572</span>
<span class="normal">1573</span>
<span class="normal">1574</span>
<span class="normal">1575</span>
<span class="normal">1576</span>
<span class="normal">1577</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">empty_annotations</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Deletes all annotations from the database</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Deleting all data in annotations collection.&quot;</span><span class="p">)</span>
    <span class="n">annotations</span> <span class="o">=</span> <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;ANNOTATIONS&quot;</span><span class="p">]</span>
    <span class="n">annotations</span><span class="o">.</span><span class="n">delete_many</span><span class="p">({})</span>

    <span class="c1"># also reset the queue</span>
    <span class="n">flask</span><span class="o">.</span><span class="n">current_app</span><span class="o">.</span><span class="n">task_queue</span><span class="o">.</span><span class="n">empty</span><span class="p">()</span>
    <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;TASK&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">delete_many</span><span class="p">({})</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="cedars.app.ops.db.generate_patient_entry" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">generate_patient_entry</span><span class="p">(</span><span class="n">p_id</span><span class="p">,</span> <span class="n">index_no</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Generates a blank entry for a new patient in the PATIENTS collection.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>-</code></b>
                  (<code>p_id(str)</code>)
              –
              <div class="doc-md-description">
                <p>Unique ID for the patient.</p>
              </div>
            </li>
            <li>
              <b><code>-</code></b>
                  (<code>index_no(int)</code>)
              –
              <div class="doc-md-description">
                <p>Order number for this patient.
                Follows the ordering in which patients are uploaded.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              –
              <div class="doc-md-description">
                <ul>
<li>operation (pymongo.UpdateOne) : Pymongo operation to insert the patient
                                into a collection.</li>
</ul>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
            <details class="quote">
              <summary>Source code in <code>cedars/app/db.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">generate_patient_entry</span><span class="p">(</span><span class="n">p_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">index_no</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Generates a blank entry for a new patient in the PATIENTS collection.</span>

<span class="sd">    Args:</span>
<span class="sd">        - p_id (str) : Unique ID for the patient.</span>
<span class="sd">        - index_no (int) : Order number for this patient.</span>
<span class="sd">                            Follows the ordering in which patients are uploaded.</span>

<span class="sd">    Returns:</span>
<span class="sd">        - operation (pymongo.UpdateOne) : Pymongo operation to insert the patient</span>
<span class="sd">                                            into a collection.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">patient_info</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;patient_id&quot;</span><span class="p">:</span> <span class="n">p_id</span><span class="p">,</span>
        <span class="s2">&quot;reviewed&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s2">&quot;locked&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s2">&quot;updated&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s2">&quot;comments&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;reviewed_by&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;event_annotation_id&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;event_date&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;admin_locked&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s2">&quot;index_no&quot;</span> <span class="p">:</span> <span class="n">index_no</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">UpdateOne</span><span class="p">(</span>
                <span class="p">{</span><span class="s2">&quot;patient_id&quot;</span><span class="p">:</span> <span class="n">p_id</span><span class="p">},</span>
                <span class="p">{</span><span class="s2">&quot;$setOnInsert&quot;</span><span class="p">:</span> <span class="n">patient_info</span><span class="p">},</span>
                <span class="n">upsert</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="cedars.app.ops.db.generate_results_entry" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">generate_results_entry</span><span class="p">(</span><span class="n">p_id</span><span class="p">,</span> <span class="n">index_no</span><span class="p">,</span> <span class="n">first_note_date</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">last_note_date</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">num_notes</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Generates a blank entry for a new patient in the RESULTS collection.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>-</code></b>
                  (<code>p_id(str)</code>)
              –
              <div class="doc-md-description">
                <p>Unique ID for the patient.</p>
              </div>
            </li>
            <li>
              <b><code>-</code></b>
                  (<code>index_no(int)</code>)
              –
              <div class="doc-md-description">
                <p>Order number for this patient.
                Follows the ordering in which patients are uploaded.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              –
              <div class="doc-md-description">
                <ul>
<li>operation (pymongo.UpdateOne) : Pymongo operation to insert the patient
                                into a collection.</li>
</ul>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
            <details class="quote">
              <summary>Source code in <code>cedars/app/db.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">generate_results_entry</span><span class="p">(</span><span class="n">p_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                           <span class="n">index_no</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                           <span class="n">first_note_date</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                           <span class="n">last_note_date</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                           <span class="n">num_notes</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Generates a blank entry for a new patient in the RESULTS collection.</span>

<span class="sd">    Args:</span>
<span class="sd">        - p_id (str) : Unique ID for the patient.</span>
<span class="sd">        - index_no (int) : Order number for this patient.</span>
<span class="sd">                            Follows the ordering in which patients are uploaded.</span>

<span class="sd">    Returns:</span>
<span class="sd">        - operation (pymongo.UpdateOne) : Pymongo operation to insert the patient</span>
<span class="sd">                                            into a collection.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">first_note_date</span> <span class="o">=</span> <span class="n">get_first_note_date_for_patient</span><span class="p">(</span><span class="n">p_id</span><span class="p">,</span> <span class="n">first_note_date</span><span class="p">)</span>
    <span class="n">last_note_date</span> <span class="o">=</span> <span class="n">get_last_note_date_for_patient</span><span class="p">(</span><span class="n">p_id</span><span class="p">,</span> <span class="n">last_note_date</span><span class="p">)</span>
    <span class="n">num_notes</span> <span class="o">=</span> <span class="n">get_num_patient_notes</span><span class="p">(</span><span class="n">p_id</span><span class="p">,</span> <span class="n">num_notes</span><span class="p">)</span>

    <span class="n">patient_results</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;patient_id&#39;</span> <span class="p">:</span> <span class="n">p_id</span><span class="p">,</span>
        <span class="s1">&#39;total_notes&#39;</span> <span class="p">:</span> <span class="n">num_notes</span><span class="p">,</span>
        <span class="s1">&#39;reviewed_notes&#39;</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">&#39;total_sentences&#39;</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">&#39;reviewed_sentences&#39;</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">&#39;sentences&#39;</span> <span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="s1">&#39;event_date&#39;</span> <span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;event_information&#39;</span> <span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;first_note_date&#39;</span> <span class="p">:</span> <span class="n">first_note_date</span><span class="p">,</span>
        <span class="s1">&#39;last_note_date&#39;</span> <span class="p">:</span> <span class="n">last_note_date</span><span class="p">,</span>
        <span class="s1">&#39;comments&#39;</span> <span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="s1">&#39;reviewer&#39;</span> <span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;max_score_note_id&#39;</span> <span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;max_score_note_date&#39;</span> <span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;max_score&#39;</span> <span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;predicted_notes&#39;</span> <span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;last_updated&#39;</span> <span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
        <span class="s1">&#39;index_no&#39;</span> <span class="p">:</span> <span class="n">index_no</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">UpdateOne</span><span class="p">(</span>
                <span class="p">{</span><span class="s2">&quot;patient_id&quot;</span><span class="p">:</span> <span class="n">p_id</span><span class="p">},</span>
                <span class="p">{</span><span class="s2">&quot;$setOnInsert&quot;</span><span class="p">:</span> <span class="n">patient_results</span><span class="p">},</span>
                <span class="n">upsert</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="cedars.app.ops.db.get_all_annotations" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_all_annotations</span><span class="p">()</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Returns a list of all annotations from the database.</p>
        <p>Returns:
    Annotations (list) : This is a list of all annotations from the database.</p>

            <details class="quote">
              <summary>Source code in <code>cedars/app/db.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1018</span>
<span class="normal">1019</span>
<span class="normal">1020</span>
<span class="normal">1021</span>
<span class="normal">1022</span>
<span class="normal">1023</span>
<span class="normal">1024</span>
<span class="normal">1025</span>
<span class="normal">1026</span>
<span class="normal">1027</span>
<span class="normal">1028</span>
<span class="normal">1029</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_all_annotations</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a list of all annotations from the database.</span>

<span class="sd">    Args:</span>
<span class="sd">        None</span>
<span class="sd">    Returns:</span>
<span class="sd">        Annotations (list) : This is a list of all annotations from the database.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">annotations</span> <span class="o">=</span> <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;ANNOTATIONS&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">()</span>

    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">annotations</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="cedars.app.ops.db.get_all_annotations_for_note" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_all_annotations_for_note</span><span class="p">(</span><span class="n">note_id</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>This function is used to get all the annotations for a particular note
after removing negated annotations.
Order of annotations -
    text_date (ascending)
    note_start_index (ascending)</p>

            <details class="quote">
              <summary>Source code in <code>cedars/app/db.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_all_annotations_for_note</span><span class="p">(</span><span class="n">note_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function is used to get all the annotations for a particular note</span>
<span class="sd">    after removing negated annotations.</span>
<span class="sd">    Order of annotations -</span>
<span class="sd">        text_date (ascending)</span>
<span class="sd">        note_start_index (ascending)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">annotations</span> <span class="o">=</span> <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;ANNOTATIONS&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">({</span><span class="s2">&quot;note_id&quot;</span><span class="p">:</span> <span class="n">note_id</span><span class="p">,</span>
                                                <span class="s2">&quot;isNegated&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">})</span><span class="o">.</span><span class="n">sort</span><span class="p">([(</span><span class="s2">&quot;text_date&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                                                                           <span class="p">(</span><span class="s2">&quot;sentence_number&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)])</span>
    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">annotations</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="cedars.app.ops.db.get_all_annotations_for_patient" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_all_annotations_for_patient</span><span class="p">(</span><span class="n">patient_id</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Retrives all annotations for a patient.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>patient_id</code></b>
                  (<code>str) </code>)
              –
              <div class="doc-md-description">
                <p>Unique ID for a patient.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>        <p>Returns:
    annotations (list) : A list of all annotations for that patient.</p>

            <details class="quote">
              <summary>Source code in <code>cedars/app/db.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">862</span>
<span class="normal">863</span>
<span class="normal">864</span>
<span class="normal">865</span>
<span class="normal">866</span>
<span class="normal">867</span>
<span class="normal">868</span>
<span class="normal">869</span>
<span class="normal">870</span>
<span class="normal">871</span>
<span class="normal">872</span>
<span class="normal">873</span>
<span class="normal">874</span>
<span class="normal">875</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_all_annotations_for_patient</span><span class="p">(</span><span class="n">patient_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrives all annotations for a patient.</span>

<span class="sd">    Args:</span>
<span class="sd">        patient_id (str) : Unique ID for a patient.</span>
<span class="sd">    Returns:</span>
<span class="sd">        annotations (list) : A list of all annotations for that patient.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">annotations</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;ANNOTATIONS&quot;</span><span class="p">]</span>
                       <span class="o">.</span><span class="n">find</span><span class="p">({</span><span class="s2">&quot;patient_id&quot;</span><span class="p">:</span> <span class="n">patient_id</span><span class="p">,</span> <span class="s2">&quot;isNegated&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">})</span>
                       <span class="o">.</span><span class="n">sort</span><span class="p">([(</span><span class="s2">&quot;text_date&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;note_id&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;note_start_index&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)]))</span>

    <span class="k">return</span> <span class="n">annotations</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="cedars.app.ops.db.get_all_annotations_for_sentence" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_all_annotations_for_sentence</span><span class="p">(</span><span class="n">note_id</span><span class="p">,</span> <span class="n">sentence_number</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>This function is used to get all the annotations for a particular sentence
    in a note after removing negated annotations.
Order of annotations -
    text_date (ascending)
    note_start_index (ascending)</p>

            <details class="quote">
              <summary>Source code in <code>cedars/app/db.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_all_annotations_for_sentence</span><span class="p">(</span><span class="n">note_id</span><span class="p">,</span> <span class="n">sentence_number</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function is used to get all the annotations for a particular sentence</span>
<span class="sd">        in a note after removing negated annotations.</span>
<span class="sd">    Order of annotations -</span>
<span class="sd">        text_date (ascending)</span>
<span class="sd">        note_start_index (ascending)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">annotations</span> <span class="o">=</span> <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;ANNOTATIONS&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">({</span><span class="s2">&quot;note_id&quot;</span><span class="p">:</span> <span class="n">note_id</span><span class="p">,</span>
                                                <span class="s2">&quot;sentence_number&quot;</span> <span class="p">:</span> <span class="n">sentence_number</span><span class="p">,</span>
                                                <span class="s2">&quot;isNegated&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">})</span><span class="o">.</span><span class="n">sort</span><span class="p">([(</span><span class="s2">&quot;text_date&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                                                                           <span class="p">(</span><span class="s2">&quot;note_start_index&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)])</span>
    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">annotations</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="cedars.app.ops.db.get_all_notes" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_all_notes</span><span class="p">(</span><span class="n">patient_id</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Returns all notes for that patient.</p>

            <details class="quote">
              <summary>Source code in <code>cedars/app/db.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1139</span>
<span class="normal">1140</span>
<span class="normal">1141</span>
<span class="normal">1142</span>
<span class="normal">1143</span>
<span class="normal">1144</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_all_notes</span><span class="p">(</span><span class="n">patient_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns all notes for that patient.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">notes</span> <span class="o">=</span> <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;NOTES&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">({</span><span class="s2">&quot;patient_id&quot;</span><span class="p">:</span> <span class="n">patient_id</span><span class="p">})</span>
    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">notes</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="cedars.app.ops.db.get_all_patient_ids" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_all_patient_ids</span><span class="p">()</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Returns all the patient IDs in this project.
The patients are returned in the order in which they were uploaded.</p>
        <p>Returns:
    patients (list) : List of all patients in this project</p>

            <details class="quote">
              <summary>Source code in <code>cedars/app/db.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1079</span>
<span class="normal">1080</span>
<span class="normal">1081</span>
<span class="normal">1082</span>
<span class="normal">1083</span>
<span class="normal">1084</span>
<span class="normal">1085</span>
<span class="normal">1086</span>
<span class="normal">1087</span>
<span class="normal">1088</span>
<span class="normal">1089</span>
<span class="normal">1090</span>
<span class="normal">1091</span>
<span class="normal">1092</span>
<span class="normal">1093</span>
<span class="normal">1094</span>
<span class="normal">1095</span>
<span class="normal">1096</span>
<span class="normal">1097</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_all_patient_ids</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns all the patient IDs in this project.</span>
<span class="sd">    The patients are returned in the order in which they were uploaded.</span>

<span class="sd">    Args:</span>
<span class="sd">        None</span>
<span class="sd">    Returns:</span>
<span class="sd">        patients (list) : List of all patients in this project</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Sort patients by index_no when presenting to the user to keep them in the</span>
    <span class="c1"># order in which they were uploaded.</span>
    <span class="c1"># Mongodb will ignore this command if index_no does not exist.</span>
    <span class="c1"># This is improtant for backwards compatibility,</span>
    <span class="c1"># as the index_no will not be present in older CEDARS versions.</span>
    <span class="n">patients</span> <span class="o">=</span> <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;PATIENTS&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">({},</span> <span class="p">{</span><span class="s1">&#39;patient_id&#39;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">})</span><span class="o">.</span><span class="n">sort</span><span class="p">([(</span><span class="s1">&#39;index_no&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)])</span>

    <span class="k">return</span> <span class="p">[</span><span class="n">patient</span><span class="p">[</span><span class="s2">&quot;patient_id&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">patient</span> <span class="ow">in</span> <span class="n">patients</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="cedars.app.ops.db.get_annotated_notes_for_patient" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_annotated_notes_for_patient</span><span class="p">(</span><span class="n">patient_id</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>For a given patient, list all note_ids which have matching keyword
annotations</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>patient_id</code></b>
                  (<code>int) </code>)
              –
              <div class="doc-md-description">
                <p>The patient_id for which we want to retrieve the
annotated notes</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
                  <code>list[str]</code>
              –
              <div class="doc-md-description">
                <p>notes (list[str]) : List of note_ids for the patient which have
matching keyword annotations</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
            <details class="quote">
              <summary>Source code in <code>cedars/app/db.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1191</span>
<span class="normal">1192</span>
<span class="normal">1193</span>
<span class="normal">1194</span>
<span class="normal">1195</span>
<span class="normal">1196</span>
<span class="normal">1197</span>
<span class="normal">1198</span>
<span class="normal">1199</span>
<span class="normal">1200</span>
<span class="normal">1201</span>
<span class="normal">1202</span>
<span class="normal">1203</span>
<span class="normal">1204</span>
<span class="normal">1205</span>
<span class="normal">1206</span>
<span class="normal">1207</span>
<span class="normal">1208</span>
<span class="normal">1209</span>
<span class="normal">1210</span>
<span class="normal">1211</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_annotated_notes_for_patient</span><span class="p">(</span><span class="n">patient_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    For a given patient, list all note_ids which have matching keyword</span>
<span class="sd">    annotations</span>

<span class="sd">    Args:</span>
<span class="sd">        patient_id (int) : The patient_id for which we want to retrieve the</span>
<span class="sd">            annotated notes</span>

<span class="sd">    Returns:</span>
<span class="sd">        notes (list[str]) : List of note_ids for the patient which have</span>
<span class="sd">            matching keyword annotations</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">annotations</span> <span class="o">=</span> <span class="p">(</span><span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;ANNOTATIONS&quot;</span><span class="p">]</span>
                   <span class="o">.</span><span class="n">find</span><span class="p">({</span><span class="s2">&quot;patient_id&quot;</span><span class="p">:</span> <span class="n">patient_id</span><span class="p">})</span>
                   <span class="o">.</span><span class="n">sort</span><span class="p">([(</span><span class="s2">&quot;text_date&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;note_id&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;note_start_index&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)]))</span>
    <span class="n">notes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">annotation</span> <span class="ow">in</span> <span class="n">annotations</span><span class="p">:</span>
        <span class="n">notes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">annotation</span><span class="p">[</span><span class="s2">&quot;note_id&quot;</span><span class="p">])</span>

    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">notes</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="cedars.app.ops.db.get_annotation" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_annotation</span><span class="p">(</span><span class="n">annotation_id</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Retrives annotation from mongodb.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>annotation_id</code></b>
                  (<code>str) </code>)
              –
              <div class="doc-md-description">
                <p>Unique ID for the annotation.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>        <p>Returns:
    annotation (dict) : Dictionary for an annotation from mongodb.
        The keys are the attribute names.
        The values are the values of the attribute in that record.</p>

            <details class="quote">
              <summary>Source code in <code>cedars/app/db.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_annotation</span><span class="p">(</span><span class="n">annotation_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrives annotation from mongodb.</span>

<span class="sd">    Args:</span>
<span class="sd">        annotation_id (str) : Unique ID for the annotation.</span>
<span class="sd">    Returns:</span>
<span class="sd">        annotation (dict) : Dictionary for an annotation from mongodb.</span>
<span class="sd">            The keys are the attribute names.</span>
<span class="sd">            The values are the values of the attribute in that record.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">annotation</span> <span class="o">=</span> <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;ANNOTATIONS&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">find_one</span><span class="p">({</span><span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="n">ObjectId</span><span class="p">(</span><span class="n">annotation_id</span><span class="p">)})</span>

    <span class="k">return</span> <span class="n">annotation</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="cedars.app.ops.db.get_annotation_note" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_annotation_note</span><span class="p">(</span><span class="n">annotation_id</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Retrives note linked to a paticular annotation.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>annotation_id</code></b>
                  (<code>str) </code>)
              –
              <div class="doc-md-description">
                <p>Unique ID for the annotation.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>        <p>Returns:
    note (dict) : Dictionary for a note from mongodb.
                  The keys are the attribute names.
                  The values are the values of the attribute in that record.</p>

            <details class="quote">
              <summary>Source code in <code>cedars/app/db.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_annotation_note</span><span class="p">(</span><span class="n">annotation_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrives note linked to a paticular annotation.</span>

<span class="sd">    Args:</span>
<span class="sd">        annotation_id (str) : Unique ID for the annotation.</span>
<span class="sd">    Returns:</span>
<span class="sd">        note (dict) : Dictionary for a note from mongodb.</span>
<span class="sd">                      The keys are the attribute names.</span>
<span class="sd">                      The values are the values of the attribute in that record.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Retriving annotation #</span><span class="si">{</span><span class="n">annotation_id</span><span class="si">}</span><span class="s2"> from database.&quot;</span><span class="p">)</span>
    <span class="n">annotation</span> <span class="o">=</span> <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;ANNOTATIONS&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">find_one</span><span class="p">({</span><span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="n">ObjectId</span><span class="p">(</span><span class="n">annotation_id</span><span class="p">)})</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">annotation</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">note</span> <span class="o">=</span> <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;NOTES&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">find_one</span><span class="p">({</span><span class="s2">&quot;text_id&quot;</span><span class="p">:</span> <span class="n">annotation</span><span class="p">[</span><span class="s2">&quot;note_id&quot;</span><span class="p">]})</span>

    <span class="k">return</span> <span class="n">note</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="cedars.app.ops.db.get_annotations_post_event" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_annotations_post_event</span><span class="p">(</span><span class="n">patient_id</span><span class="p">,</span> <span class="n">event_date</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Retirves the annotation IDs for unreviewed events on or
after the event date for a paticular patient.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>-</code></b>
                  (<code>patient_id(str)</code>)
              –
              <div class="doc-md-description">
                <p>ID for the patient</p>
              </div>
            </li>
            <li>
              <b><code>-</code></b>
                  (<code>event_date(Date)</code>)
              –
              <div class="doc-md-description">
                <p>Date on which the event was found</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              –
              <div class="doc-md-description">
                <ul>
<li>annotation_ids (list) : List of annotation ID for the unreviewed
                        annotations on or after that date.</li>
</ul>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
            <details class="quote">
              <summary>Source code in <code>cedars/app/db.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">906</span>
<span class="normal">907</span>
<span class="normal">908</span>
<span class="normal">909</span>
<span class="normal">910</span>
<span class="normal">911</span>
<span class="normal">912</span>
<span class="normal">913</span>
<span class="normal">914</span>
<span class="normal">915</span>
<span class="normal">916</span>
<span class="normal">917</span>
<span class="normal">918</span>
<span class="normal">919</span>
<span class="normal">920</span>
<span class="normal">921</span>
<span class="normal">922</span>
<span class="normal">923</span>
<span class="normal">924</span>
<span class="normal">925</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_annotations_post_event</span><span class="p">(</span><span class="n">patient_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">event_date</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Retirves the annotation IDs for unreviewed events on or</span>
<span class="sd">    after the event date for a paticular patient.</span>

<span class="sd">    Args:</span>
<span class="sd">        - patient_id (str) : ID for the patient</span>
<span class="sd">        - event_date(Date) : Date on which the event was found</span>

<span class="sd">    Returns:</span>
<span class="sd">        - annotation_ids (list) : List of annotation ID for the unreviewed</span>
<span class="sd">                                    annotations on or after that date.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">a_ids</span> <span class="o">=</span> <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;ANNOTATIONS&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">({</span> <span class="s1">&#39;patient_id&#39;</span> <span class="p">:</span> <span class="n">patient_id</span><span class="p">,</span>
                                        <span class="s1">&#39;text_date&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;$gte&#39;</span><span class="p">:</span> <span class="n">event_date</span><span class="p">},</span>
                                        <span class="s1">&#39;reviewed&#39;</span><span class="p">:</span> <span class="n">ReviewStatus</span><span class="o">.</span><span class="n">UNREVIEWED</span><span class="o">.</span><span class="n">value</span>
                                        <span class="p">})</span>

    <span class="k">return</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;_id&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">a_ids</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="cedars.app.ops.db.get_curr_stats" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_curr_stats</span><span class="p">()</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Returns basic statistics for the project</p>

            <details class="quote">
              <summary>Source code in <code>cedars/app/db.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1614</span>
<span class="normal">1615</span>
<span class="normal">1616</span>
<span class="normal">1617</span>
<span class="normal">1618</span>
<span class="normal">1619</span>
<span class="normal">1620</span>
<span class="normal">1621</span>
<span class="normal">1622</span>
<span class="normal">1623</span>
<span class="normal">1624</span>
<span class="normal">1625</span>
<span class="normal">1626</span>
<span class="normal">1627</span>
<span class="normal">1628</span>
<span class="normal">1629</span>
<span class="normal">1630</span>
<span class="normal">1631</span>
<span class="normal">1632</span>
<span class="normal">1633</span>
<span class="normal">1634</span>
<span class="normal">1635</span>
<span class="normal">1636</span>
<span class="normal">1637</span>
<span class="normal">1638</span>
<span class="normal">1639</span>
<span class="normal">1640</span>
<span class="normal">1641</span>
<span class="normal">1642</span>
<span class="normal">1643</span>
<span class="normal">1644</span>
<span class="normal">1645</span>
<span class="normal">1646</span>
<span class="normal">1647</span>
<span class="normal">1648</span>
<span class="normal">1649</span>
<span class="normal">1650</span>
<span class="normal">1651</span>
<span class="normal">1652</span>
<span class="normal">1653</span>
<span class="normal">1654</span>
<span class="normal">1655</span>
<span class="normal">1656</span>
<span class="normal">1657</span>
<span class="normal">1658</span>
<span class="normal">1659</span>
<span class="normal">1660</span>
<span class="normal">1661</span>
<span class="normal">1662</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_curr_stats</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns basic statistics for the project</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">stats</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1"># Aggregation pipeline to count unique patients</span>
    <span class="n">pipeline_unique_patients</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="s2">&quot;$group&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="s2">&quot;$patient_id&quot;</span><span class="p">}}</span>
    <span class="p">]</span>
    <span class="n">unique_patients</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">PATIENTS</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">pipeline_unique_patients</span><span class="p">))</span>
    <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;number_of_patients&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_patients</span><span class="p">)</span>

    <span class="n">pipeline_annotated_patients</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="s2">&quot;$match&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;isNegated&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}},</span>
        <span class="p">{</span><span class="s2">&quot;$group&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="s2">&quot;$patient_id&quot;</span><span class="p">}}</span>
    <span class="p">]</span>
    <span class="n">annotated_patients</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">ANNOTATIONS</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">pipeline_annotated_patients</span><span class="p">))</span>
    <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;number_of_annotated_patients&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">annotated_patients</span><span class="p">)</span>

    <span class="c1"># Aggregation pipeline to count reviewed annotations</span>
    <span class="n">pipeline_reviewed</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="s2">&quot;$match&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;reviewed&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}},</span>
        <span class="p">{</span><span class="s2">&quot;$group&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="s2">&quot;$patient_id&quot;</span><span class="p">}}</span>
    <span class="p">]</span>
    <span class="n">reviewed_annotations</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">PATIENTS</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">pipeline_reviewed</span><span class="p">))</span>
    <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;number_of_reviewed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">reviewed_annotations</span><span class="p">)</span>

    <span class="c1"># pipeline for notes and reviewed by user for notes with reviewed_by field</span>
    <span class="n">pipeline_patients</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="s2">&quot;$match&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;reviewed&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}},</span>
        <span class="p">{</span><span class="s2">&quot;$group&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="s2">&quot;$reviewed_by&quot;</span><span class="p">,</span> <span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$sum&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}}}</span>
    <span class="p">]</span>

    <span class="n">reviewed_notes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">PATIENTS</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">pipeline_patients</span><span class="p">))</span>
    <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;user_review_stats&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">doc</span><span class="p">[</span><span class="s2">&quot;_id&quot;</span><span class="p">]:</span> <span class="n">doc</span><span class="p">[</span><span class="s2">&quot;count&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">reviewed_notes</span><span class="p">}</span>
    <span class="c1"># Aggregation pipeline for lemma distribution</span>
    <span class="n">pipeline_lemma_dist</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="s2">&quot;$match&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;isNegated&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}},</span>
        <span class="p">{</span><span class="s2">&quot;$group&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="s2">&quot;$token&quot;</span><span class="p">,</span> <span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$sum&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}}},</span>
        <span class="p">{</span><span class="s2">&quot;$sort&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">}},</span>
        <span class="p">{</span><span class="s2">&quot;$limit&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">},</span>
        <span class="p">{</span><span class="s2">&quot;$project&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;token&quot;</span><span class="p">:</span> <span class="s2">&quot;$_id&quot;</span><span class="p">,</span> <span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}}</span>
    <span class="p">]</span>
    <span class="n">lemma_dist_results</span> <span class="o">=</span> <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">ANNOTATIONS</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">pipeline_lemma_dist</span><span class="p">)</span>
    <span class="n">total_tokens</span> <span class="o">=</span> <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">ANNOTATIONS</span><span class="o">.</span><span class="n">count_documents</span><span class="p">({</span><span class="s2">&quot;isNegated&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">})</span>
    <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;lemma_dist&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">doc</span><span class="p">[</span><span class="s1">&#39;token&#39;</span><span class="p">]:</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">doc</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">total_tokens</span> <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">lemma_dist_results</span><span class="p">}</span>

    <span class="k">return</span> <span class="n">stats</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="cedars.app.ops.db.get_curr_version" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_curr_version</span><span class="p">()</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Returns the name of the current project.</p>
        <p>Returns:
    proj_name (str) : The name of the current CEDARS project.</p>

            <details class="quote">
              <summary>Source code in <code>cedars/app/db.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1049</span>
<span class="normal">1050</span>
<span class="normal">1051</span>
<span class="normal">1052</span>
<span class="normal">1053</span>
<span class="normal">1054</span>
<span class="normal">1055</span>
<span class="normal">1056</span>
<span class="normal">1057</span>
<span class="normal">1058</span>
<span class="normal">1059</span>
<span class="normal">1060</span>
<span class="normal">1061</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_curr_version</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the name of the current project.</span>

<span class="sd">    Args:</span>
<span class="sd">        None</span>
<span class="sd">    Returns:</span>
<span class="sd">        proj_name (str) : The name of the current CEDARS project.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">proj_info</span> <span class="o">=</span> <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;INFO&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">find_one</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">proj_info</span><span class="p">[</span><span class="s2">&quot;CEDARS_version&quot;</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="cedars.app.ops.db.get_documents_to_annotate" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_documents_to_annotate</span><span class="p">(</span><span class="n">patient_id</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Retrives all documents that have not been annotated.</p>
<p>Returns: All matching notes from the database.</p>

            <details class="quote">
              <summary>Source code in <code>cedars/app/db.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">833</span>
<span class="normal">834</span>
<span class="normal">835</span>
<span class="normal">836</span>
<span class="normal">837</span>
<span class="normal">838</span>
<span class="normal">839</span>
<span class="normal">840</span>
<span class="normal">841</span>
<span class="normal">842</span>
<span class="normal">843</span>
<span class="normal">844</span>
<span class="normal">845</span>
<span class="normal">846</span>
<span class="normal">847</span>
<span class="normal">848</span>
<span class="normal">849</span>
<span class="normal">850</span>
<span class="normal">851</span>
<span class="normal">852</span>
<span class="normal">853</span>
<span class="normal">854</span>
<span class="normal">855</span>
<span class="normal">856</span>
<span class="normal">857</span>
<span class="normal">858</span>
<span class="normal">859</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_documents_to_annotate</span><span class="p">(</span><span class="n">patient_id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrives all documents that have not been annotated.</span>

<span class="sd">    Returns: All matching notes from the database.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Retriving all annotated documents from database.&quot;</span><span class="p">)</span>
    <span class="n">match_stage</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;annotations&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$eq&quot;</span><span class="p">:</span> <span class="p">[]},</span>
        <span class="s2">&quot;reviewed&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$ne&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="n">patient_id</span><span class="p">:</span>
        <span class="n">match_stage</span><span class="p">[</span><span class="s2">&quot;patient_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">patient_id</span>

    <span class="n">documents_to_annotate</span> <span class="o">=</span> <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;NOTES&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span>
        <span class="p">[{</span>
            <span class="s2">&quot;$lookup&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;from&quot;</span><span class="p">:</span> <span class="s2">&quot;ANNOTATIONS&quot;</span><span class="p">,</span>
                <span class="s2">&quot;localField&quot;</span><span class="p">:</span> <span class="s2">&quot;text_id&quot;</span><span class="p">,</span>
                <span class="s2">&quot;foreignField&quot;</span><span class="p">:</span> <span class="s2">&quot;note_id&quot;</span><span class="p">,</span>
                <span class="s2">&quot;as&quot;</span><span class="p">:</span> <span class="s2">&quot;annotations&quot;</span>
            <span class="p">}</span>
        <span class="p">},</span> <span class="p">{</span>
            <span class="s2">&quot;$match&quot;</span><span class="p">:</span> <span class="n">match_stage</span>
        <span class="p">}])</span>

    <span class="k">return</span> <span class="n">documents_to_annotate</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="cedars.app.ops.db.get_event_annotation_id" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_event_annotation_id</span><span class="p">(</span><span class="n">patient_id</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Retrives the ID for the annotation where 
        the event date for a patient was found.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>patient_id</code></b>
                  (<code>str) </code>)
              –
              <div class="doc-md-description">
                <p>Unique ID for the patient.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>        <p>Returns:
    None</p>

            <details class="quote">
              <summary>Source code in <code>cedars/app/db.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1400</span>
<span class="normal">1401</span>
<span class="normal">1402</span>
<span class="normal">1403</span>
<span class="normal">1404</span>
<span class="normal">1405</span>
<span class="normal">1406</span>
<span class="normal">1407</span>
<span class="normal">1408</span>
<span class="normal">1409</span>
<span class="normal">1410</span>
<span class="normal">1411</span>
<span class="normal">1412</span>
<span class="normal">1413</span>
<span class="normal">1414</span>
<span class="normal">1415</span>
<span class="normal">1416</span>
<span class="normal">1417</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_event_annotation_id</span><span class="p">(</span><span class="n">patient_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrives the ID for the annotation where </span>
<span class="sd">            the event date for a patient was found.</span>

<span class="sd">    Args:</span>
<span class="sd">        patient_id (str) : Unique ID for the patient.</span>
<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Retriving event_annotation_id for patient #</span><span class="si">{</span><span class="n">patient_id</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

    <span class="n">patient</span> <span class="o">=</span> <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;PATIENTS&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">find_one</span><span class="p">({</span><span class="s2">&quot;patient_id&quot;</span><span class="p">:</span> <span class="n">patient_id</span><span class="p">})</span>

    <span class="k">if</span> <span class="n">patient</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">patient</span><span class="p">[</span><span class="s2">&quot;event_annotation_id&quot;</span><span class="p">]</span>

    <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="cedars.app.ops.db.get_event_date" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_event_date</span><span class="p">(</span><span class="n">patient_id</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Find the event date for a patient.</p>

            <details class="quote">
              <summary>Source code in <code>cedars/app/db.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">927</span>
<span class="normal">928</span>
<span class="normal">929</span>
<span class="normal">930</span>
<span class="normal">931</span>
<span class="normal">932</span>
<span class="normal">933</span>
<span class="normal">934</span>
<span class="normal">935</span>
<span class="normal">936</span>
<span class="normal">937</span>
<span class="normal">938</span>
<span class="normal">939</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_event_date</span><span class="p">(</span><span class="n">patient_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Find the event date for a patient.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Retriving event date for patient #</span><span class="si">{</span><span class="n">patient_id</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
    <span class="n">patient</span> <span class="o">=</span> <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;PATIENTS&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">find_one</span><span class="p">({</span><span class="s2">&quot;patient_id&quot;</span><span class="p">:</span> <span class="n">patient_id</span><span class="p">})</span>

    <span class="k">if</span> <span class="n">patient</span> <span class="ow">and</span> <span class="n">patient</span><span class="p">[</span><span class="s1">&#39;event_date&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1">#date_format = &#39;%Y-%m-%d&#39;</span>
        <span class="c1">#event_date = datetime.strptime(patient[&#39;event_date&#39;], date_format)</span>
        <span class="k">return</span> <span class="n">patient</span><span class="p">[</span><span class="s1">&#39;event_date&#39;</span><span class="p">]</span>

    <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="cedars.app.ops.db.get_first_note_date_for_patient" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_first_note_date_for_patient</span><span class="p">(</span><span class="n">patient_id</span><span class="p">,</span> <span class="n">first_note_date</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Retrives the date of the first note for a patient.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>patient_id</code></b>
                  (<code>str) </code>)
              –
              <div class="doc-md-description">
                <p>Unique ID for a patient.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>        <p>Returns:
    note_date (datetime) : The date of the first note for the patient.</p>

            <details class="quote">
              <summary>Source code in <code>cedars/app/db.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">955</span>
<span class="normal">956</span>
<span class="normal">957</span>
<span class="normal">958</span>
<span class="normal">959</span>
<span class="normal">960</span>
<span class="normal">961</span>
<span class="normal">962</span>
<span class="normal">963</span>
<span class="normal">964</span>
<span class="normal">965</span>
<span class="normal">966</span>
<span class="normal">967</span>
<span class="normal">968</span>
<span class="normal">969</span>
<span class="normal">970</span>
<span class="normal">971</span>
<span class="normal">972</span>
<span class="normal">973</span>
<span class="normal">974</span>
<span class="normal">975</span>
<span class="normal">976</span>
<span class="normal">977</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_first_note_date_for_patient</span><span class="p">(</span><span class="n">patient_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">first_note_date</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrives the date of the first note for a patient.</span>

<span class="sd">    Args:</span>
<span class="sd">        patient_id (str) : Unique ID for a patient.</span>
<span class="sd">    Returns:</span>
<span class="sd">        note_date (datetime) : The date of the first note for the patient.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Retriving first note date for patient #</span><span class="si">{</span><span class="n">patient_id</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

    <span class="c1"># pass cached value if available</span>
    <span class="k">if</span> <span class="n">first_note_date</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">first_note_date</span>

    <span class="n">summary</span> <span class="o">=</span> <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;NOTES_SUMMARY&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">find_one</span><span class="p">(</span>
        <span class="p">{</span><span class="s2">&quot;patient_id&quot;</span><span class="p">:</span> <span class="n">patient_id</span><span class="p">},</span>
        <span class="p">{</span><span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;first_note_date&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>  <span class="c1"># Project only the first_note_date field</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">summary</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="n">summary</span><span class="p">[</span><span class="s2">&quot;first_note_date&quot;</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="cedars.app.ops.db.get_formatted_patient_predictions" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_formatted_patient_predictions</span><span class="p">(</span><span class="n">patient_id</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Checks if the results for this patient exist in the RESULTS collection.</p>


<details class="args-" open>
  <summary>Args</summary>
  <ul>
<li>patient_id (str) : ID of the patient.</li>
</ul>
</details>

<details class="returns-" open>
  <summary>Returns</summary>
  <ul>
<li>concat_patient_predictions (str) : A string with each predicted note
        as well as the prediction scores. 
        Each prediction is in the format {note_id:note_date:prediction_score} .
        Each prediction is seperated by a newline character.</li>
</ul>
</details>
            <details class="quote">
              <summary>Source code in <code>cedars/app/db.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span>
<span class="normal">799</span>
<span class="normal">800</span>
<span class="normal">801</span>
<span class="normal">802</span>
<span class="normal">803</span>
<span class="normal">804</span>
<span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span>
<span class="normal">812</span>
<span class="normal">813</span>
<span class="normal">814</span>
<span class="normal">815</span>
<span class="normal">816</span>
<span class="normal">817</span>
<span class="normal">818</span>
<span class="normal">819</span>
<span class="normal">820</span>
<span class="normal">821</span>
<span class="normal">822</span>
<span class="normal">823</span>
<span class="normal">824</span>
<span class="normal">825</span>
<span class="normal">826</span>
<span class="normal">827</span>
<span class="normal">828</span>
<span class="normal">829</span>
<span class="normal">830</span>
<span class="normal">831</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_formatted_patient_predictions</span><span class="p">(</span><span class="n">patient_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Checks if the results for this patient exist in the RESULTS collection.</span>

<span class="sd">    Args :</span>
<span class="sd">        - patient_id (str) : ID of the patient.</span>

<span class="sd">    Returns :</span>
<span class="sd">        - concat_patient_predictions (str) : A string with each predicted note</span>
<span class="sd">                as well as the prediction scores. </span>
<span class="sd">                Each prediction is in the format {note_id:note_date:prediction_score} .</span>
<span class="sd">                Each prediction is seperated by a newline character.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">match_stage</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;patient_id&#39;</span> <span class="p">:</span> <span class="n">patient_id</span><span class="p">,</span> <span class="s2">&quot;predicted_score&quot;</span><span class="p">:{</span><span class="s1">&#39;$ne&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">}}</span>

    <span class="n">group_stage</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;_id&#39;</span> <span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="s1">&#39;note_prediction&#39;</span><span class="p">:</span> <span class="p">{</span> <span class="s1">&#39;$push&#39;</span><span class="p">:</span> <span class="p">{</span> <span class="s1">&#39;$concat&#39;</span><span class="p">:</span> <span class="p">[</span> <span class="s2">&quot;$text_id&quot;</span><span class="p">,</span> <span class="s2">&quot;:&quot;</span><span class="p">,</span> 
                    <span class="p">{</span> <span class="s2">&quot;$dateToString&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;format&quot;</span><span class="p">:</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;date&quot;</span><span class="p">:</span> <span class="s2">&quot;$text_date&quot;</span> <span class="p">}</span> <span class="p">},</span>
                    <span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;$toString&#39;</span><span class="p">:</span> <span class="s2">&quot;$predicted_score&quot;</span><span class="p">}</span>  <span class="p">]</span> <span class="p">}</span> <span class="p">}</span>
                    <span class="p">}</span>

    <span class="n">concat_stage</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;concat_patient_predictions&#39;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;$reduce&#39;</span><span class="p">:</span> <span class="p">{</span>
                            <span class="s1">&#39;input&#39;</span><span class="p">:</span> <span class="s2">&quot;$note_prediction&quot;</span><span class="p">,</span>

                            <span class="s1">&#39;initialValue&#39;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                            <span class="s1">&#39;in&#39;</span><span class="p">:</span> <span class="p">{</span>
                                <span class="s1">&#39;$cond&#39;</span><span class="p">:</span> <span class="p">[</span> <span class="p">{</span> <span class="s2">&quot;$eq&quot;</span><span class="p">:</span> <span class="p">[</span> <span class="s2">&quot;$$value&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span> <span class="p">]</span> <span class="p">},</span>
                                <span class="s2">&quot;$$this&quot;</span><span class="p">,</span> <span class="p">{</span> <span class="s1">&#39;$concat&#39;</span><span class="p">:</span> <span class="p">[</span> <span class="s2">&quot;$$value&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;$$this&quot;</span> <span class="p">]</span> <span class="p">}</span> <span class="p">]</span>
                            <span class="p">}</span>
                        <span class="p">}}</span>
                    <span class="p">}</span>

    <span class="n">pipeline</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">pipeline</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;$match&#39;</span><span class="p">:</span> <span class="n">match_stage</span><span class="p">})</span>
    <span class="n">pipeline</span><span class="o">.</span><span class="n">append</span><span class="p">({</span> <span class="s1">&#39;$group&#39;</span> <span class="p">:</span> <span class="n">group_stage</span><span class="p">})</span>
    <span class="n">pipeline</span><span class="o">.</span><span class="n">append</span><span class="p">({</span> <span class="s1">&#39;$project&#39;</span> <span class="p">:</span> <span class="n">concat_stage</span><span class="p">})</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;PINES&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">pipeline</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;concat_patient_predictions&#39;</span><span class="p">]</span>

    <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="cedars.app.ops.db.get_info" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_info</span><span class="p">()</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>This function returns the info collection in the mongodb database.</p>

            <details class="quote">
              <summary>Source code in <code>cedars/app/db.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_info</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function returns the info collection in the mongodb database.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">info</span> <span class="o">=</span> <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;INFO&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">find_one</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">info</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">info</span>

    <span class="k">return</span> <span class="p">{}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="cedars.app.ops.db.get_last_note_date_for_patient" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_last_note_date_for_patient</span><span class="p">(</span><span class="n">patient_id</span><span class="p">,</span> <span class="n">last_note_date</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Retrives the date of the last note for a patient.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>patient_id</code></b>
                  (<code>str) </code>)
              –
              <div class="doc-md-description">
                <p>Unique ID for a patient.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>        <p>Returns:
    note_date (datetime) : The date of the last note for the patient.</p>

            <details class="quote">
              <summary>Source code in <code>cedars/app/db.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 994</span>
<span class="normal"> 995</span>
<span class="normal"> 996</span>
<span class="normal"> 997</span>
<span class="normal"> 998</span>
<span class="normal"> 999</span>
<span class="normal">1000</span>
<span class="normal">1001</span>
<span class="normal">1002</span>
<span class="normal">1003</span>
<span class="normal">1004</span>
<span class="normal">1005</span>
<span class="normal">1006</span>
<span class="normal">1007</span>
<span class="normal">1008</span>
<span class="normal">1009</span>
<span class="normal">1010</span>
<span class="normal">1011</span>
<span class="normal">1012</span>
<span class="normal">1013</span>
<span class="normal">1014</span>
<span class="normal">1015</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_last_note_date_for_patient</span><span class="p">(</span><span class="n">patient_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">last_note_date</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrives the date of the last note for a patient.</span>

<span class="sd">    Args:</span>
<span class="sd">        patient_id (str) : Unique ID for a patient.</span>
<span class="sd">    Returns:</span>
<span class="sd">        note_date (datetime) : The date of the last note for the patient.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Retriving first note date for patient #</span><span class="si">{</span><span class="n">patient_id</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
    <span class="c1"># pass cached value if available</span>
    <span class="k">if</span> <span class="n">last_note_date</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">last_note_date</span>

    <span class="n">summary</span> <span class="o">=</span> <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;NOTES_SUMMARY&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">find_one</span><span class="p">(</span>
        <span class="p">{</span><span class="s2">&quot;patient_id&quot;</span><span class="p">:</span> <span class="n">patient_id</span><span class="p">},</span>
        <span class="p">{</span><span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;last_note_date&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>  <span class="c1"># Project only the first_note_date field</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">summary</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="n">summary</span><span class="p">[</span><span class="s2">&quot;last_note_date&quot;</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="cedars.app.ops.db.get_max_prediction_score" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_max_prediction_score</span><span class="p">(</span><span class="n">patient_id</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Get the max predicted note score for a patient</p>

            <details class="quote">
              <summary>Source code in <code>cedars/app/db.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1696</span>
<span class="normal">1697</span>
<span class="normal">1698</span>
<span class="normal">1699</span>
<span class="normal">1700</span>
<span class="normal">1701</span>
<span class="normal">1702</span>
<span class="normal">1703</span>
<span class="normal">1704</span>
<span class="normal">1705</span>
<span class="normal">1706</span>
<span class="normal">1707</span>
<span class="normal">1708</span>
<span class="normal">1709</span>
<span class="normal">1710</span>
<span class="normal">1711</span>
<span class="normal">1712</span>
<span class="normal">1713</span>
<span class="normal">1714</span>
<span class="normal">1715</span>
<span class="normal">1716</span>
<span class="normal">1717</span>
<span class="normal">1718</span>
<span class="normal">1719</span>
<span class="normal">1720</span>
<span class="normal">1721</span>
<span class="normal">1722</span>
<span class="normal">1723</span>
<span class="normal">1724</span>
<span class="normal">1725</span>
<span class="normal">1726</span>
<span class="normal">1727</span>
<span class="normal">1728</span>
<span class="normal">1729</span>
<span class="normal">1730</span>
<span class="normal">1731</span>
<span class="normal">1732</span>
<span class="normal">1733</span>
<span class="normal">1734</span>
<span class="normal">1735</span>
<span class="normal">1736</span>
<span class="normal">1737</span>
<span class="normal">1738</span>
<span class="normal">1739</span>
<span class="normal">1740</span>
<span class="normal">1741</span>
<span class="normal">1742</span>
<span class="normal">1743</span>
<span class="normal">1744</span>
<span class="normal">1745</span>
<span class="normal">1746</span>
<span class="normal">1747</span>
<span class="normal">1748</span>
<span class="normal">1749</span>
<span class="normal">1750</span>
<span class="normal">1751</span>
<span class="normal">1752</span>
<span class="normal">1753</span>
<span class="normal">1754</span>
<span class="normal">1755</span>
<span class="normal">1756</span>
<span class="normal">1757</span>
<span class="normal">1758</span>
<span class="normal">1759</span>
<span class="normal">1760</span>
<span class="normal">1761</span>
<span class="normal">1762</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_max_prediction_score</span><span class="p">(</span><span class="n">patient_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the max predicted note score for a patient</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">PINES</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="p">{</span>
                <span class="s1">&#39;$match&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;patient_id&#39;</span><span class="p">:</span> <span class="n">patient_id</span>
                <span class="p">}</span>
            <span class="p">},</span> <span class="p">{</span>
                <span class="s1">&#39;$group&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;_id&#39;</span><span class="p">:</span> <span class="s1">&#39;$patient_id&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;max_score&#39;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;$max&#39;</span><span class="p">:</span> <span class="s1">&#39;$predicted_score&#39;</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">},</span> <span class="p">{</span>
                <span class="s1">&#39;$lookup&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;from&#39;</span><span class="p">:</span> <span class="s1">&#39;PINES&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;let&#39;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;patient_id&#39;</span><span class="p">:</span> <span class="s1">&#39;$_id&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;max_score&#39;</span><span class="p">:</span> <span class="s1">&#39;$max_score&#39;</span>
                    <span class="p">},</span>
                    <span class="s1">&#39;pipeline&#39;</span><span class="p">:</span> <span class="p">[</span>
                        <span class="p">{</span>
                            <span class="s1">&#39;$match&#39;</span><span class="p">:</span> <span class="p">{</span>
                                <span class="s1">&#39;$expr&#39;</span><span class="p">:</span> <span class="p">{</span>
                                    <span class="s1">&#39;$and&#39;</span><span class="p">:</span> <span class="p">[</span>
                                        <span class="p">{</span>
                                            <span class="s1">&#39;$eq&#39;</span><span class="p">:</span> <span class="p">[</span>
                                                <span class="s1">&#39;$patient_id&#39;</span><span class="p">,</span> <span class="s1">&#39;$$patient_id&#39;</span>
                                            <span class="p">]</span>
                                        <span class="p">},</span> <span class="p">{</span>
                                            <span class="s1">&#39;$eq&#39;</span><span class="p">:</span> <span class="p">[</span>
                                                <span class="s1">&#39;$predicted_score&#39;</span><span class="p">,</span> <span class="s1">&#39;$$max_score&#39;</span>
                                            <span class="p">]</span>
                                        <span class="p">}</span>
                                    <span class="p">]</span>
                                <span class="p">}</span>
                            <span class="p">}</span>
                        <span class="p">},</span> <span class="p">{</span>
                            <span class="s1">&#39;$project&#39;</span><span class="p">:</span> <span class="p">{</span>
                                <span class="s1">&#39;text_id&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                                <span class="s1">&#39;_id&#39;</span><span class="p">:</span> <span class="mi">0</span>
                            <span class="p">}</span>
                        <span class="p">}</span>
                    <span class="p">],</span>
                    <span class="s1">&#39;as&#39;</span><span class="p">:</span> <span class="s1">&#39;max_score_texts&#39;</span>
                <span class="p">}</span>
            <span class="p">},</span> <span class="p">{</span>
                <span class="s1">&#39;$addFields&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;text_id&#39;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;$arrayElemAt&#39;</span><span class="p">:</span> <span class="p">[</span>
                            <span class="s1">&#39;$max_score_texts.text_id&#39;</span><span class="p">,</span> <span class="mi">0</span>
                        <span class="p">]</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">},</span> <span class="p">{</span>
                <span class="s1">&#39;$project&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;_id&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="s1">&#39;max_score&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="s1">&#39;text_id&#39;</span><span class="p">:</span> <span class="mi">1</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">]</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="cedars.app.ops.db.get_note_date" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_note_date</span><span class="p">(</span><span class="n">note_id</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Retrives the date of a note.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>note_id</code></b>
                  (<code>str) </code>)
              –
              <div class="doc-md-description">
                <p>Unique ID for a note.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>        <p>Returns:
    note_date (datetime) : The date of the note.</p>

            <details class="quote">
              <summary>Source code in <code>cedars/app/db.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">941</span>
<span class="normal">942</span>
<span class="normal">943</span>
<span class="normal">944</span>
<span class="normal">945</span>
<span class="normal">946</span>
<span class="normal">947</span>
<span class="normal">948</span>
<span class="normal">949</span>
<span class="normal">950</span>
<span class="normal">951</span>
<span class="normal">952</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_note_date</span><span class="p">(</span><span class="n">note_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrives the date of a note.</span>

<span class="sd">    Args:</span>
<span class="sd">        note_id (str) : Unique ID for a note.</span>
<span class="sd">    Returns:</span>
<span class="sd">        note_date (datetime) : The date of the note.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Retriving date for note #</span><span class="si">{</span><span class="n">note_id</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
    <span class="n">note</span> <span class="o">=</span> <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;NOTES&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">find_one</span><span class="p">({</span><span class="s2">&quot;text_id&quot;</span><span class="p">:</span> <span class="n">note_id</span><span class="p">})</span>
    <span class="k">return</span> <span class="n">note</span><span class="p">[</span><span class="s2">&quot;text_date&quot;</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="cedars.app.ops.db.get_note_prediction_from_db" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_note_prediction_from_db</span><span class="p">(</span><span class="n">note_id</span><span class="p">,</span> <span class="n">pines_collection_name</span><span class="o">=</span><span class="s1">&#39;PINES&#39;</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Retrieve the prediction score for a given from the database</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>pines_collection_name</code></b>
                  (<code>str</code>, default:
                      <code>&#39;PINES&#39;</code>
)
              –
              <div class="doc-md-description">
                <p>The name of the collection in the database</p>
              </div>
            </li>
            <li>
              <b><code>note_id</code></b>
                  (<code>str</code>)
              –
              <div class="doc-md-description">
                <p>The note_id for which we want to retrieve the prediction</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
<b><code>float</code></b>(                  <code><span title="typing.Optional">Optional</span>[float]</code>
)              –
              <div class="doc-md-description">
                <p>The prediction score for the note</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
            <details class="quote">
              <summary>Source code in <code>cedars/app/db.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1765</span>
<span class="normal">1766</span>
<span class="normal">1767</span>
<span class="normal">1768</span>
<span class="normal">1769</span>
<span class="normal">1770</span>
<span class="normal">1771</span>
<span class="normal">1772</span>
<span class="normal">1773</span>
<span class="normal">1774</span>
<span class="normal">1775</span>
<span class="normal">1776</span>
<span class="normal">1777</span>
<span class="normal">1778</span>
<span class="normal">1779</span>
<span class="normal">1780</span>
<span class="normal">1781</span>
<span class="normal">1782</span>
<span class="normal">1783</span>
<span class="normal">1784</span>
<span class="normal">1785</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_note_prediction_from_db</span><span class="p">(</span><span class="n">note_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                                <span class="n">pines_collection_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;PINES&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrieve the prediction score for a given from the database</span>

<span class="sd">    Args:</span>
<span class="sd">        pines_collection_name (str): The name of the collection in the database</span>
<span class="sd">        note_id (str): The note_id for which we want to retrieve the prediction</span>

<span class="sd">    Returns:</span>
<span class="sd">        float: The prediction score for the note</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pines_collection</span> <span class="o">=</span> <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="n">pines_collection_name</span><span class="p">]</span>
    <span class="n">query</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;text_id&quot;</span><span class="p">:</span> <span class="n">note_id</span><span class="p">}</span>

    <span class="n">pines_pred</span> <span class="o">=</span> <span class="n">pines_collection</span><span class="o">.</span><span class="n">find_one</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">pines_pred</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found prediction in db for : </span><span class="si">{</span><span class="n">note_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">pines_pred</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;predicted_score&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">round</span><span class="p">(</span><span class="n">pines_pred</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;predicted_score&quot;</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Prediction not found in db for : </span><span class="si">{</span><span class="n">note_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="cedars.app.ops.db.get_notes_summary" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_notes_summary</span><span class="p">()</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Returns a dictionary of note summaries for all patients in the project.</p>
        <p>Returns:
    notes_summary (dict) : A dictionary of note summaries for all patients.</p>

            <details class="quote">
              <summary>Source code in <code>cedars/app/db.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">980</span>
<span class="normal">981</span>
<span class="normal">982</span>
<span class="normal">983</span>
<span class="normal">984</span>
<span class="normal">985</span>
<span class="normal">986</span>
<span class="normal">987</span>
<span class="normal">988</span>
<span class="normal">989</span>
<span class="normal">990</span>
<span class="normal">991</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_notes_summary</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a dictionary of note summaries for all patients in the project.</span>

<span class="sd">    Args:</span>
<span class="sd">        None</span>
<span class="sd">    Returns:</span>
<span class="sd">        notes_summary (dict) : A dictionary of note summaries for all patients.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">notes_summary</span> <span class="o">=</span> <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;NOTES_SUMMARY&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">()</span>

    <span class="k">return</span> <span class="p">{</span><span class="n">summary</span><span class="p">[</span><span class="s2">&quot;patient_id&quot;</span><span class="p">]:</span> <span class="n">summary</span> <span class="k">for</span> <span class="n">summary</span> <span class="ow">in</span> <span class="n">notes_summary</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="cedars.app.ops.db.get_num_patient_notes" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_num_patient_notes</span><span class="p">(</span><span class="n">patient_id</span><span class="p">,</span> <span class="n">num_notes</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Returns all notes for that patient.</p>

            <details class="quote">
              <summary>Source code in <code>cedars/app/db.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1146</span>
<span class="normal">1147</span>
<span class="normal">1148</span>
<span class="normal">1149</span>
<span class="normal">1150</span>
<span class="normal">1151</span>
<span class="normal">1152</span>
<span class="normal">1153</span>
<span class="normal">1154</span>
<span class="normal">1155</span>
<span class="normal">1156</span>
<span class="normal">1157</span>
<span class="normal">1158</span>
<span class="normal">1159</span>
<span class="normal">1160</span>
<span class="normal">1161</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_num_patient_notes</span><span class="p">(</span><span class="n">patient_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">num_notes</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns all notes for that patient.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Retriving number of notes for patient #</span><span class="si">{</span><span class="n">patient_id</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
    <span class="c1"># pass cached value if available</span>
    <span class="k">if</span> <span class="n">num_notes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">num_notes</span>

    <span class="n">summary</span> <span class="o">=</span> <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;NOTES_SUMMARY&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">find_one</span><span class="p">(</span>
        <span class="p">{</span><span class="s2">&quot;patient_id&quot;</span><span class="p">:</span> <span class="n">patient_id</span><span class="p">},</span>
        <span class="p">{</span><span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;num_notes&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>  <span class="c1"># Project only the num_notes field</span>
    <span class="p">)</span>

    <span class="c1"># Return the num_notes if available, otherwise return 0</span>
    <span class="k">return</span> <span class="n">summary</span><span class="p">[</span><span class="s2">&quot;num_notes&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">summary</span> <span class="k">else</span> <span class="mi">0</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="cedars.app.ops.db.get_patient" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_patient</span><span class="p">()</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Retrives a single patient ID who has not yet been reviewed and is not currently locked.
The chosen patient is the first one in the database that has not yet been reviewed. The
order in which un-reviewed patients are selected is based on the order in which they were
uploaded by the user.</p>
        <p>Returns:
    patient_id (int) : Unique ID for a patient.</p>

            <details class="quote">
              <summary>Source code in <code>cedars/app/db.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_patient</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrives a single patient ID who has not yet been reviewed and is not currently locked.</span>
<span class="sd">    The chosen patient is the first one in the database that has not yet been reviewed. The</span>
<span class="sd">    order in which un-reviewed patients are selected is based on the order in which they were</span>
<span class="sd">    uploaded by the user.</span>

<span class="sd">    Args:</span>
<span class="sd">        None</span>
<span class="sd">    Returns:</span>
<span class="sd">        patient_id (int) : Unique ID for a patient.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># todo: make sure it only get patients who have annotations atleast</span>
    <span class="c1"># while adjuticating</span>

    <span class="c1"># Sort patients by index_no to maintain order of upload</span>
    <span class="c1"># mongodb will ignore this command if index_no does not exist.</span>
    <span class="c1"># This is improtant for backwards compatibility,</span>
    <span class="c1"># as the index_no will not be present in older CEDARS versions.</span>
    <span class="n">patient</span> <span class="o">=</span> <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;PATIENTS&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">({</span><span class="s2">&quot;reviewed&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                                             <span class="s2">&quot;locked&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">})</span><span class="o">.</span><span class="n">sort</span><span class="p">([(</span><span class="s2">&quot;index_no&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)])</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Extract the first record as we only retrived one patient due to limit(1)</span>
    <span class="n">patient</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">patient</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>


    <span class="k">if</span> <span class="n">patient</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s2">&quot;patient_id&quot;</span> <span class="ow">in</span> <span class="n">patient</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Retriving patient #</span><span class="si">{</span><span class="n">patient</span><span class="p">[</span><span class="s1">&#39;patient_id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> from database.&quot;</span><span class="p">,</span> <span class="p">)</span>
        <span class="k">return</span> <span class="n">patient</span><span class="p">[</span><span class="s2">&quot;patient_id&quot;</span><span class="p">]</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Failed to retrive any further un-reviewed patients from the database.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="cedars.app.ops.db.get_patient_annotation_ids" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_patient_annotation_ids</span><span class="p">(</span><span class="n">p_id</span><span class="p">,</span> <span class="n">reviewed</span><span class="o">=</span><span class="n">ReviewStatus</span><span class="o">.</span><span class="n">UNREVIEWED</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;_id&#39;</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Retrives all annotation IDs for annotations linked to a patient.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>p_id</code></b>
                  (<code>str) </code>)
              –
              <div class="doc-md-description">
                <p>Unique ID for a patient.</p>
              </div>
            </li>
            <li>
              <b><code>reviewed</code></b>
                  (<code>ReviewStatus Enum) </code>, default:
                      <code><span title="cedars.app.cedars_enums.ReviewStatus.UNREVIEWED">UNREVIEWED</span></code>
)
              –
              <div class="doc-md-description">
                <p>The status of the annotation wrt being reviewed.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>        <p>Returns:
    annotations (list) : A list of all annotation IDs linked to that patient.</p>

            <details class="quote">
              <summary>Source code in <code>cedars/app/db.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">877</span>
<span class="normal">878</span>
<span class="normal">879</span>
<span class="normal">880</span>
<span class="normal">881</span>
<span class="normal">882</span>
<span class="normal">883</span>
<span class="normal">884</span>
<span class="normal">885</span>
<span class="normal">886</span>
<span class="normal">887</span>
<span class="normal">888</span>
<span class="normal">889</span>
<span class="normal">890</span>
<span class="normal">891</span>
<span class="normal">892</span>
<span class="normal">893</span>
<span class="normal">894</span>
<span class="normal">895</span>
<span class="normal">896</span>
<span class="normal">897</span>
<span class="normal">898</span>
<span class="normal">899</span>
<span class="normal">900</span>
<span class="normal">901</span>
<span class="normal">902</span>
<span class="normal">903</span>
<span class="normal">904</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_patient_annotation_ids</span><span class="p">(</span><span class="n">p_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">reviewed</span><span class="o">=</span><span class="n">ReviewStatus</span><span class="o">.</span><span class="n">UNREVIEWED</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;_id&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrives all annotation IDs for annotations linked to a patient.</span>

<span class="sd">    Args:</span>
<span class="sd">        p_id (str) : Unique ID for a patient.</span>
<span class="sd">        reviewed (ReviewStatus Enum) : The status of the annotation wrt being reviewed.</span>
<span class="sd">    Returns:</span>
<span class="sd">        annotations (list) : A list of all annotation IDs linked to that patient.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Retriving annotations for patient #</span><span class="si">{</span><span class="n">p_id</span><span class="si">}</span><span class="s2"> from database.&quot;</span><span class="p">)</span>
    <span class="n">query_filter</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;patient_id&quot;</span><span class="p">:</span> <span class="n">p_id</span><span class="p">,</span> <span class="s2">&quot;isNegated&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;reviewed&quot;</span><span class="p">:</span> <span class="n">reviewed</span><span class="o">.</span><span class="n">value</span><span class="p">}</span>

    <span class="n">annotation_ids</span> <span class="o">=</span> <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;ANNOTATIONS&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">(</span>
        <span class="n">query_filter</span><span class="p">)</span><span class="o">.</span><span class="n">sort</span><span class="p">([</span>
            <span class="p">(</span><span class="s2">&quot;note_id&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;text_date&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;sentence_number&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)])</span>

    <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;sentence&quot;</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">_id</span> <span class="ow">in</span> <span class="n">annotation_ids</span><span class="p">:</span>
            <span class="n">cleaned_sentence</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_id</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
            <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">_id</span><span class="p">[</span><span class="s2">&quot;note_id&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">_id</span><span class="p">[</span><span class="s2">&quot;text_date&quot;</span><span class="p">])[:</span><span class="mi">10</span><span class="p">]</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="n">cleaned_sentence</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">_id</span><span class="p">[</span><span class="n">key</span><span class="p">])</span> <span class="k">for</span> <span class="n">_id</span> <span class="ow">in</span> <span class="n">annotation_ids</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">res</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="cedars.app.ops.db.get_patient_by_id" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_patient_by_id</span><span class="p">(</span><span class="n">patient_id</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Retrives a single patient from mongodb.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>patient_id</code></b>
                  (<code>int) </code>)
              –
              <div class="doc-md-description">
                <p>Unique ID for a patient.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>        <p>Returns:
    patient (dict) : Dictionary for a patient from mongodb.
                     The keys are the attribute names.
                     The values are the values of the attribute in that record.</p>

            <details class="quote">
              <summary>Source code in <code>cedars/app/db.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_patient_by_id</span><span class="p">(</span><span class="n">patient_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrives a single patient from mongodb.</span>

<span class="sd">    Args:</span>
<span class="sd">        patient_id (int) : Unique ID for a patient.</span>
<span class="sd">    Returns:</span>
<span class="sd">        patient (dict) : Dictionary for a patient from mongodb.</span>
<span class="sd">                         The keys are the attribute names.</span>
<span class="sd">                         The values are the values of the attribute in that record.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Retriving patient #</span><span class="si">{</span><span class="n">patient_id</span><span class="si">}</span><span class="s2"> from database.&quot;</span><span class="p">)</span>
    <span class="n">patient</span> <span class="o">=</span> <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;PATIENTS&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">find_one</span><span class="p">({</span><span class="s2">&quot;patient_id&quot;</span><span class="p">:</span> <span class="n">patient_id</span><span class="p">})</span>

    <span class="k">return</span> <span class="n">patient</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="cedars.app.ops.db.get_patient_ids" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_patient_ids</span><span class="p">()</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Returns all the patient IDs in this project.
The patients are returned in the order in which they were uploaded.</p>
        <p>Returns:
    patient_ids (list) : List of all patient IDs in this project</p>

            <details class="quote">
              <summary>Source code in <code>cedars/app/db.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1100</span>
<span class="normal">1101</span>
<span class="normal">1102</span>
<span class="normal">1103</span>
<span class="normal">1104</span>
<span class="normal">1105</span>
<span class="normal">1106</span>
<span class="normal">1107</span>
<span class="normal">1108</span>
<span class="normal">1109</span>
<span class="normal">1110</span>
<span class="normal">1111</span>
<span class="normal">1112</span>
<span class="normal">1113</span>
<span class="normal">1114</span>
<span class="normal">1115</span>
<span class="normal">1116</span>
<span class="normal">1117</span>
<span class="normal">1118</span>
<span class="normal">1119</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_patient_ids</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns all the patient IDs in this project.</span>
<span class="sd">    The patients are returned in the order in which they were uploaded.</span>

<span class="sd">    Args:</span>
<span class="sd">        None</span>
<span class="sd">    Returns:</span>
<span class="sd">        patient_ids (list) : List of all patient IDs in this project</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Sorting patients by index_no to maintain upload order</span>
    <span class="c1"># Mongodb will ignore this command if index_no does not exist.</span>
    <span class="c1"># This is improtant for backwards compatibility,</span>
    <span class="c1"># as the index_no will not be present in older CEDARS versions.</span>
    <span class="n">patients</span> <span class="o">=</span> <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;PATIENTS&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">({</span><span class="s2">&quot;reviewed&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;locked&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">})</span><span class="o">.</span><span class="n">sort</span><span class="p">([(</span><span class="s1">&#39;index_no&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)])</span>

    <span class="n">res</span> <span class="o">=</span> <span class="p">[</span><span class="n">patient</span><span class="p">[</span><span class="s2">&quot;patient_id&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">patient</span> <span class="ow">in</span> <span class="n">patients</span><span class="p">]</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Retrived </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span><span class="si">}</span><span class="s2"> patient IDs from the database.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">res</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="cedars.app.ops.db.get_patient_lock_status" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_patient_lock_status</span><span class="p">(</span><span class="n">patient_id</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Updates the status of the patient to be locked or unlocked.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>patient_id</code></b>
                  (<code>int) </code>)
              –
              <div class="doc-md-description">
                <p>ID for the patient we are locking / unlocking</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>        <p>Returns:
    status (bool) : True if the patient is locked, False otherwise.
        If no such patient is found, we return None.</p>

            <details class="quote">
              <summary>Source code in <code>cedars/app/db.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1122</span>
<span class="normal">1123</span>
<span class="normal">1124</span>
<span class="normal">1125</span>
<span class="normal">1126</span>
<span class="normal">1127</span>
<span class="normal">1128</span>
<span class="normal">1129</span>
<span class="normal">1130</span>
<span class="normal">1131</span>
<span class="normal">1132</span>
<span class="normal">1133</span>
<span class="normal">1134</span>
<span class="normal">1135</span>
<span class="normal">1136</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_patient_lock_status</span><span class="p">(</span><span class="n">patient_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Updates the status of the patient to be locked or unlocked.</span>

<span class="sd">    Args:</span>
<span class="sd">        patient_id (int) : ID for the patient we are locking / unlocking</span>
<span class="sd">    Returns:</span>
<span class="sd">        status (bool) : True if the patient is locked, False otherwise.</span>
<span class="sd">            If no such patient is found, we return None.</span>

<span class="sd">    Raises:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">patient</span> <span class="o">=</span> <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;PATIENTS&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">find_one</span><span class="p">({</span><span class="s2">&quot;patient_id&quot;</span><span class="p">:</span> <span class="n">patient_id</span><span class="p">})</span>
    <span class="k">return</span> <span class="n">patient</span><span class="p">[</span><span class="s2">&quot;locked&quot;</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="cedars.app.ops.db.get_patient_notes" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_patient_notes</span><span class="p">(</span><span class="n">patient_id</span><span class="p">,</span> <span class="n">reviewed</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Returns all notes for that patient.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>patient_id</code></b>
                  (<code>str) </code>)
              –
              <div class="doc-md-description">
                <p>ID for the patient</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>        <p>Returns:
    notes: A list of all notes for that patient</p>

            <details class="quote">
              <summary>Source code in <code>cedars/app/db.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1164</span>
<span class="normal">1165</span>
<span class="normal">1166</span>
<span class="normal">1167</span>
<span class="normal">1168</span>
<span class="normal">1169</span>
<span class="normal">1170</span>
<span class="normal">1171</span>
<span class="normal">1172</span>
<span class="normal">1173</span>
<span class="normal">1174</span>
<span class="normal">1175</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_patient_notes</span><span class="p">(</span><span class="n">patient_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">reviewed</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns all notes for that patient.</span>

<span class="sd">    Args:</span>
<span class="sd">        patient_id (str) : ID for the patient</span>
<span class="sd">    Returns:</span>
<span class="sd">        notes: A list of all notes for that patient</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mongodb_search_query</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;patient_id&quot;</span><span class="p">:</span> <span class="n">patient_id</span><span class="p">,</span> <span class="s2">&quot;reviewed&quot;</span><span class="p">:</span> <span class="n">reviewed</span><span class="p">}</span>
    <span class="n">notes</span> <span class="o">=</span> <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;NOTES&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">mongodb_search_query</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">notes</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="cedars.app.ops.db.get_patient_reviewer" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_patient_reviewer</span><span class="p">(</span><span class="n">patient_id</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Updates the note's status to reviewed in the database.</p>

            <details class="quote">
              <summary>Source code in <code>cedars/app/db.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1902</span>
<span class="normal">1903</span>
<span class="normal">1904</span>
<span class="normal">1905</span>
<span class="normal">1906</span>
<span class="normal">1907</span>
<span class="normal">1908</span>
<span class="normal">1909</span>
<span class="normal">1910</span>
<span class="normal">1911</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_patient_reviewer</span><span class="p">(</span><span class="n">patient_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Updates the note&#39;s status to reviewed in the database.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">reviewed_by</span> <span class="o">=</span> <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;PATIENTS&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">find_one</span><span class="p">({</span><span class="s2">&quot;patient_id&quot;</span><span class="p">:</span> <span class="n">patient_id</span><span class="p">})[</span><span class="s2">&quot;reviewed_by&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">reviewed_by</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">reviewed_by</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="cedars.app.ops.db.get_patients_to_annotate" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_patients_to_annotate</span><span class="p">()</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Retrieves a patient that have not been reviewed</p>
        <p>Returns:
    patient_to_annotate: A single patient that needs to manually reviewed</p>

            <details class="quote">
              <summary>Source code in <code>cedars/app/db.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_patients_to_annotate</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrieves a patient that have not been reviewed</span>

<span class="sd">    Args:</span>
<span class="sd">        None</span>
<span class="sd">    Returns:</span>
<span class="sd">        patient_to_annotate: A single patient that needs to manually reviewed</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Retriving all un-reviewed patients from database.&quot;</span><span class="p">)</span>

    <span class="c1"># check is this patient has any unreviewed annotations</span>
    <span class="k">for</span> <span class="n">patient_id</span> <span class="ow">in</span> <span class="n">get_patient_ids</span><span class="p">():</span>
        <span class="n">annotations</span> <span class="o">=</span> <span class="n">get_patient_annotation_ids</span><span class="p">(</span><span class="n">patient_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">annotations</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">patient_id</span>

    <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="cedars.app.ops.db.get_pines_url" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_pines_url</span><span class="p">()</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Retrives PINES url from INFO col.</p>

            <details class="quote">
              <summary>Source code in <code>cedars/app/db.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1913</span>
<span class="normal">1914</span>
<span class="normal">1915</span>
<span class="normal">1916</span>
<span class="normal">1917</span>
<span class="normal">1918</span>
<span class="normal">1919</span>
<span class="normal">1920</span>
<span class="normal">1921</span>
<span class="normal">1922</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_pines_url</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Retrives PINES url from INFO col.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">info_col</span> <span class="o">=</span> <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;INFO&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">find_one</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">info_col</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">info_col</span><span class="p">[</span><span class="s2">&quot;pines_url&quot;</span><span class="p">]</span>

    <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="cedars.app.ops.db.get_prediction" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_prediction</span><span class="p">(</span><span class="n">note</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <h6 id="cedars.app.ops.db.get_prediction--pines-predictions">PINES predictions</h6>
<p>Get prediction from endpoint. Text goes in the POST request.</p>

            <details class="quote">
              <summary>Source code in <code>cedars/app/db.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1666</span>
<span class="normal">1667</span>
<span class="normal">1668</span>
<span class="normal">1669</span>
<span class="normal">1670</span>
<span class="normal">1671</span>
<span class="normal">1672</span>
<span class="normal">1673</span>
<span class="normal">1674</span>
<span class="normal">1675</span>
<span class="normal">1676</span>
<span class="normal">1677</span>
<span class="normal">1678</span>
<span class="normal">1679</span>
<span class="normal">1680</span>
<span class="normal">1681</span>
<span class="normal">1682</span>
<span class="normal">1683</span>
<span class="normal">1684</span>
<span class="normal">1685</span>
<span class="normal">1686</span>
<span class="normal">1687</span>
<span class="normal">1688</span>
<span class="normal">1689</span>
<span class="normal">1690</span>
<span class="normal">1691</span>
<span class="normal">1692</span>
<span class="normal">1693</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_prediction</span><span class="p">(</span><span class="n">note</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ##### PINES predictions</span>

<span class="sd">    Get prediction from endpoint. Text goes in the POST request.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">pines_api_url</span> <span class="o">=</span> <span class="n">get_pines_url</span><span class="p">()</span>

    <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">pines_api_url</span><span class="si">}</span><span class="s1">/predict&#39;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="n">note</span><span class="p">}</span>
    <span class="n">log_notes</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">3600</span><span class="p">)</span>
        <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s2">&quot;prediction&quot;</span><span class="p">]</span>
        <span class="n">score</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;score&quot;</span><span class="p">)</span>
        <span class="n">label</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;label&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">score</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">score</span> <span class="k">if</span> <span class="s2">&quot;0&quot;</span> <span class="ow">in</span> <span class="n">label</span> <span class="k">else</span> <span class="n">score</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">score</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">score</span> <span class="k">if</span> <span class="n">label</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">score</span>
        <span class="n">log_notes</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\d&#39;</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">note</span><span class="p">[:</span><span class="mi">20</span><span class="p">])</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Got prediction for note: </span><span class="si">{</span><span class="n">log_notes</span><span class="si">}</span><span class="s2"> with score: </span><span class="si">{</span><span class="n">score</span><span class="si">}</span><span class="s2"> and label: </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">score</span>
    <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">RequestException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to get prediction for note: </span><span class="si">{</span><span class="n">log_notes</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">e</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="cedars.app.ops.db.get_proj_name" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_proj_name</span><span class="p">()</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Returns the name of the current project.</p>
        <p>Returns:
    proj_name (str) : The name of the current CEDARS project.</p>

            <details class="quote">
              <summary>Source code in <code>cedars/app/db.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1032</span>
<span class="normal">1033</span>
<span class="normal">1034</span>
<span class="normal">1035</span>
<span class="normal">1036</span>
<span class="normal">1037</span>
<span class="normal">1038</span>
<span class="normal">1039</span>
<span class="normal">1040</span>
<span class="normal">1041</span>
<span class="normal">1042</span>
<span class="normal">1043</span>
<span class="normal">1044</span>
<span class="normal">1045</span>
<span class="normal">1046</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_proj_name</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the name of the current project.</span>

<span class="sd">    Args:</span>
<span class="sd">        None</span>
<span class="sd">    Returns:</span>
<span class="sd">        proj_name (str) : The name of the current CEDARS project.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">proj_info</span> <span class="o">=</span> <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;INFO&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">find_one</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">proj_info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">proj_name</span> <span class="o">=</span> <span class="n">proj_info</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">proj_name</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="cedars.app.ops.db.get_project_users" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_project_users</span><span class="p">()</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Returns all the usernames for approved users (including the admin) for this project</p>
        <p>Returns:
    usernames (list) : List of all usernames for approved users
                       (including the admin) for this project</p>

            <details class="quote">
              <summary>Source code in <code>cedars/app/db.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1064</span>
<span class="normal">1065</span>
<span class="normal">1066</span>
<span class="normal">1067</span>
<span class="normal">1068</span>
<span class="normal">1069</span>
<span class="normal">1070</span>
<span class="normal">1071</span>
<span class="normal">1072</span>
<span class="normal">1073</span>
<span class="normal">1074</span>
<span class="normal">1075</span>
<span class="normal">1076</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_project_users</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns all the usernames for approved users (including the admin) for this project</span>

<span class="sd">    Args:</span>
<span class="sd">        None</span>
<span class="sd">    Returns:</span>
<span class="sd">        usernames (list) : List of all usernames for approved users</span>
<span class="sd">                           (including the admin) for this project</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">users</span> <span class="o">=</span> <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;USERS&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">({})</span>

    <span class="k">return</span> <span class="p">[</span><span class="n">user</span><span class="p">[</span><span class="s2">&quot;user&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">users</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="cedars.app.ops.db.get_search_query" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_search_query</span><span class="p">(</span><span class="n">query_key</span><span class="o">=</span><span class="s1">&#39;query&#39;</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>This function is used to get the current search query from the database.
All this data is kept in the QUERY collection.</p>

            <details class="quote">
              <summary>Source code in <code>cedars/app/db.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_search_query</span><span class="p">(</span><span class="n">query_key</span><span class="o">=</span><span class="s2">&quot;query&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function is used to get the current search query from the database.</span>
<span class="sd">    All this data is kept in the QUERY collection.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;QUERY&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">find_one</span><span class="p">({</span><span class="s2">&quot;current&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>

    <span class="k">if</span> <span class="n">query</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">query</span><span class="p">[</span><span class="n">query_key</span><span class="p">]</span>

    <span class="k">return</span> <span class="s2">&quot;&quot;</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="cedars.app.ops.db.get_search_query_details" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_search_query_details</span><span class="p">()</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>This function is used to get the current search query details
from the database.</p>

            <details class="quote">
              <summary>Source code in <code>cedars/app/db.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_search_query_details</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function is used to get the current search query details</span>
<span class="sd">    from the database.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;QUERY&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">find_one</span><span class="p">({</span><span class="s2">&quot;current&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>

    <span class="k">if</span> <span class="n">query</span><span class="p">:</span>
        <span class="n">query</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;_id&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">query</span>

    <span class="k">return</span> <span class="p">{}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="cedars.app.ops.db.get_task" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_task</span><span class="p">(</span><span class="n">task_id</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Returns the task with this ID, regardless of it's completion status.</p>

            <details class="quote">
              <summary>Source code in <code>cedars/app/db.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1848</span>
<span class="normal">1849</span>
<span class="normal">1850</span>
<span class="normal">1851</span>
<span class="normal">1852</span>
<span class="normal">1853</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_task</span><span class="p">(</span><span class="n">task_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the task with this ID, regardless of it&#39;s completion status.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">task_db</span> <span class="o">=</span> <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;TASK&quot;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">task_db</span><span class="o">.</span><span class="n">find_one</span><span class="p">({</span><span class="s2">&quot;job_id&quot;</span><span class="p">:</span> <span class="n">task_id</span><span class="p">})</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="cedars.app.ops.db.get_task_in_progress" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_task_in_progress</span><span class="p">(</span><span class="n">task_id</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Returns the task with this ID, if it has not been completed.</p>

            <details class="quote">
              <summary>Source code in <code>cedars/app/db.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1839</span>
<span class="normal">1840</span>
<span class="normal">1841</span>
<span class="normal">1842</span>
<span class="normal">1843</span>
<span class="normal">1844</span>
<span class="normal">1845</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_task_in_progress</span><span class="p">(</span><span class="n">task_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the task with this ID, if it has not been completed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">task_db</span> <span class="o">=</span> <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;TASK&quot;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">task_db</span><span class="o">.</span><span class="n">find_one</span><span class="p">({</span><span class="s2">&quot;job_id&quot;</span><span class="p">:</span> <span class="n">task_id</span><span class="p">,</span>
                             <span class="s2">&quot;complete&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">})</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="cedars.app.ops.db.get_tasks_in_progress" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_tasks_in_progress</span><span class="p">()</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Returns tasks that have not been completed yet.</p>

            <details class="quote">
              <summary>Source code in <code>cedars/app/db.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1831</span>
<span class="normal">1832</span>
<span class="normal">1833</span>
<span class="normal">1834</span>
<span class="normal">1835</span>
<span class="normal">1836</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_tasks_in_progress</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns tasks that have not been completed yet.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">task_db</span> <span class="o">=</span> <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;TASK&quot;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">task_db</span><span class="o">.</span><span class="n">find</span><span class="p">({</span><span class="s2">&quot;complete&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">})</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="cedars.app.ops.db.get_total_counts" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_total_counts</span><span class="p">(</span><span class="n">collection_name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Returns the total number of documents in a collection.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>collection_name</code></b>
                  (<code>str) </code>)
              –
              <div class="doc-md-description">
                <p>The name of the collection to search.</p>
              </div>
            </li>
            <li>
              <b><code>**kwargs</code></b>
              –
              <div class="doc-md-description">
                <p>Additional arguments to pass to the find</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>        <p>Returns:
    count (int) : The number of documents in the collection.</p>

            <details class="quote">
              <summary>Source code in <code>cedars/app/db.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1178</span>
<span class="normal">1179</span>
<span class="normal">1180</span>
<span class="normal">1181</span>
<span class="normal">1182</span>
<span class="normal">1183</span>
<span class="normal">1184</span>
<span class="normal">1185</span>
<span class="normal">1186</span>
<span class="normal">1187</span>
<span class="normal">1188</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_total_counts</span><span class="p">(</span><span class="n">collection_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the total number of documents in a collection.</span>

<span class="sd">    Args:</span>
<span class="sd">        collection_name (str) : The name of the collection to search.</span>
<span class="sd">        **kwargs : Additional arguments to pass to the find</span>
<span class="sd">    Returns:</span>
<span class="sd">        count (int) : The number of documents in the collection.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="n">collection_name</span><span class="p">]</span><span class="o">.</span><span class="n">count_documents</span><span class="p">({</span><span class="o">**</span><span class="n">kwargs</span><span class="p">})</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="cedars.app.ops.db.get_user" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_user</span><span class="p">(</span><span class="n">username</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>This function is used to get a user from the database.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>username</code></b>
                  (<code>str) </code>)
              –
              <div class="doc-md-description">
                <p>The name of the user to get.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>        <p>Returns:
    user (dict) : The user object from the database.</p>

            <details class="quote">
              <summary>Source code in <code>cedars/app/db.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_user</span><span class="p">(</span><span class="n">username</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function is used to get a user from the database.</span>

<span class="sd">    Args:</span>
<span class="sd">        username (str) : The name of the user to get.</span>
<span class="sd">    Returns:</span>
<span class="sd">        user (dict) : The user object from the database.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;USERS&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">find_one</span><span class="p">({</span><span class="s2">&quot;user&quot;</span><span class="p">:</span> <span class="n">username</span><span class="p">})</span>
    <span class="k">return</span> <span class="n">user</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="cedars.app.ops.db.insert_one_annotation" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">insert_one_annotation</span><span class="p">(</span><span class="n">annotation</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Adds an annotation to the database.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>annotation</code></b>
                  (<code>dict) </code>)
              –
              <div class="doc-md-description">
                <p>The annotation we are inserting</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>        <p>Returns:
    None</p>

            <details class="quote">
              <summary>Source code in <code>cedars/app/db.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">insert_one_annotation</span><span class="p">(</span><span class="n">annotation</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Adds an annotation to the database.</span>

<span class="sd">    Args:</span>
<span class="sd">        annotation (dict) : The annotation we are inserting</span>
<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">annotations_collection</span> <span class="o">=</span> <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;ANNOTATIONS&quot;</span><span class="p">]</span>

    <span class="n">annotations_collection</span><span class="o">.</span><span class="n">insert_one</span><span class="p">(</span><span class="n">annotation</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="cedars.app.ops.db.is_admin_user" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">is_admin_user</span><span class="p">(</span><span class="n">username</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>check if the user is admin</p>

            <details class="quote">
              <summary>Source code in <code>cedars/app/db.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1603</span>
<span class="normal">1604</span>
<span class="normal">1605</span>
<span class="normal">1606</span>
<span class="normal">1607</span>
<span class="normal">1608</span>
<span class="normal">1609</span>
<span class="normal">1610</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">is_admin_user</span><span class="p">(</span><span class="n">username</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;check if the user is admin&quot;&quot;&quot;</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;USERS&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">find_one</span><span class="p">({</span><span class="s1">&#39;user&#39;</span><span class="p">:</span> <span class="n">username</span><span class="p">})</span>

    <span class="k">if</span> <span class="n">user</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">user</span><span class="p">[</span><span class="s2">&quot;is_admin&quot;</span><span class="p">]:</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">return</span> <span class="kc">False</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="cedars.app.ops.db.is_pines_api_running" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">is_pines_api_running</span><span class="p">()</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Returns True if a SuperBIO PINES API server is running.</p>

            <details class="quote">
              <summary>Source code in <code>cedars/app/db.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1924</span>
<span class="normal">1925</span>
<span class="normal">1926</span>
<span class="normal">1927</span>
<span class="normal">1928</span>
<span class="normal">1929</span>
<span class="normal">1930</span>
<span class="normal">1931</span>
<span class="normal">1932</span>
<span class="normal">1933</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">is_pines_api_running</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Returns True if a SuperBIO PINES API server is running.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">info_col</span> <span class="o">=</span> <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;INFO&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">find_one</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">info_col</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">info_col</span><span class="p">[</span><span class="s2">&quot;is_pines_server_enabled&quot;</span><span class="p">]</span>

    <span class="k">return</span> <span class="kc">False</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="cedars.app.ops.db.mark_annotation_reviewed" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">mark_annotation_reviewed</span><span class="p">(</span><span class="n">annotation_id</span><span class="p">,</span> <span class="n">reviewed_by</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Updates the annotation in the database to mark it as reviewed.
Also updates the note it belongs to as reviewed if all annotations that
belong to it are also reviewed.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>-</code></b>
                  (<code>annotation_id(str)</code>)
              –
              <div class="doc-md-description">
                <p>Unique ID for the annotation.</p>
              </div>
            </li>
            <li>
              <b><code>-</code></b>
                  (<code>reviewed_by(str)</code>)
              –
              <div class="doc-md-description">
                <p>The name of the user who reviewed this annotation.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              –
              <div class="doc-md-description">
                <p>None</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
            <details class="quote">
              <summary>Source code in <code>cedars/app/db.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1257</span>
<span class="normal">1258</span>
<span class="normal">1259</span>
<span class="normal">1260</span>
<span class="normal">1261</span>
<span class="normal">1262</span>
<span class="normal">1263</span>
<span class="normal">1264</span>
<span class="normal">1265</span>
<span class="normal">1266</span>
<span class="normal">1267</span>
<span class="normal">1268</span>
<span class="normal">1269</span>
<span class="normal">1270</span>
<span class="normal">1271</span>
<span class="normal">1272</span>
<span class="normal">1273</span>
<span class="normal">1274</span>
<span class="normal">1275</span>
<span class="normal">1276</span>
<span class="normal">1277</span>
<span class="normal">1278</span>
<span class="normal">1279</span>
<span class="normal">1280</span>
<span class="normal">1281</span>
<span class="normal">1282</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">mark_annotation_reviewed</span><span class="p">(</span><span class="n">annotation_id</span><span class="p">,</span> <span class="n">reviewed_by</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Updates the annotation in the database to mark it as reviewed.</span>
<span class="sd">    Also updates the note it belongs to as reviewed if all annotations that</span>
<span class="sd">    belong to it are also reviewed.</span>

<span class="sd">    Args:</span>
<span class="sd">        - annotation_id (str) : Unique ID for the annotation.</span>
<span class="sd">        - reviewed_by (str) : The name of the user who reviewed this annotation.</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Marking annotation #</span><span class="si">{</span><span class="n">annotation_id</span><span class="si">}</span><span class="s2"> as reviewed.&quot;</span><span class="p">)</span>
    <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;ANNOTATIONS&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update_one</span><span class="p">({</span><span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="n">ObjectId</span><span class="p">(</span><span class="n">annotation_id</span><span class="p">)},</span>
                                       <span class="p">{</span><span class="s2">&quot;$set&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;reviewed&quot;</span><span class="p">:</span> <span class="n">ReviewStatus</span><span class="o">.</span><span class="n">REVIEWED</span><span class="o">.</span><span class="n">value</span><span class="p">}})</span>

    <span class="n">annotation_data</span> <span class="o">=</span> <span class="n">get_annotation</span><span class="p">(</span><span class="n">annotation_id</span><span class="p">)</span>
    <span class="n">note_id</span> <span class="o">=</span> <span class="n">annotation_data</span><span class="p">[</span><span class="s1">&#39;note_id&#39;</span><span class="p">]</span>

    <span class="c1"># Get the number of unreviewed annotations for the note this annotation belongs to</span>
    <span class="n">num_unreviewed_annos</span> <span class="o">=</span> <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;ANNOTATIONS&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">count_documents</span><span class="p">({</span><span class="s1">&#39;note_id&#39;</span> <span class="p">:</span> <span class="n">note_id</span><span class="p">,</span>
                                  <span class="s1">&#39;reviewed&#39;</span> <span class="p">:</span> <span class="n">ReviewStatus</span><span class="o">.</span><span class="n">UNREVIEWED</span><span class="o">.</span><span class="n">value</span><span class="p">})</span>

    <span class="k">if</span> <span class="n">num_unreviewed_annos</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">mark_note_reviewed</span><span class="p">(</span><span class="n">note_id</span><span class="p">,</span> <span class="n">reviewed_by</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="cedars.app.ops.db.mark_annotations_post_event" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">mark_annotations_post_event</span><span class="p">(</span><span class="n">patient_id</span><span class="p">,</span> <span class="n">event_date</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Marks the annotation for unreviewed events on or
after the event date for a paticular patient as skipped. We
mark them as skipped as annotations after an event date may be ignorged
and do not need manual review.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>-</code></b>
                  (<code>patient_id(str)</code>)
              –
              <div class="doc-md-description">
                <p>ID for the patient</p>
              </div>
            </li>
            <li>
              <b><code>-</code></b>
                  (<code>event_date(Date)</code>)
              –
              <div class="doc-md-description">
                <p>Date on which the event was found</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              –
              <div class="doc-md-description">
                <ul>
<li>None</li>
</ul>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
            <details class="quote">
              <summary>Source code in <code>cedars/app/db.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1324</span>
<span class="normal">1325</span>
<span class="normal">1326</span>
<span class="normal">1327</span>
<span class="normal">1328</span>
<span class="normal">1329</span>
<span class="normal">1330</span>
<span class="normal">1331</span>
<span class="normal">1332</span>
<span class="normal">1333</span>
<span class="normal">1334</span>
<span class="normal">1335</span>
<span class="normal">1336</span>
<span class="normal">1337</span>
<span class="normal">1338</span>
<span class="normal">1339</span>
<span class="normal">1340</span>
<span class="normal">1341</span>
<span class="normal">1342</span>
<span class="normal">1343</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">mark_annotations_post_event</span><span class="p">(</span><span class="n">patient_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">event_date</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Marks the annotation for unreviewed events on or</span>
<span class="sd">    after the event date for a paticular patient as skipped. We</span>
<span class="sd">    mark them as skipped as annotations after an event date may be ignorged</span>
<span class="sd">    and do not need manual review.</span>

<span class="sd">    Args:</span>
<span class="sd">        - patient_id (str) : ID for the patient</span>
<span class="sd">        - event_date(Date) : Date on which the event was found</span>

<span class="sd">    Returns:</span>
<span class="sd">        - None</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping future annotations for patient </span><span class="si">{</span><span class="n">patient_id</span><span class="si">}</span><span class="s2"> after </span><span class="si">{</span><span class="n">event_date</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
    <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;ANNOTATIONS&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update_many</span><span class="p">({</span> <span class="s1">&#39;patient_id&#39;</span> <span class="p">:</span> <span class="n">patient_id</span><span class="p">,</span>
                                          <span class="s1">&#39;text_date&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;$gte&#39;</span><span class="p">:</span> <span class="n">event_date</span><span class="p">},</span>
                                          <span class="s1">&#39;reviewed&#39;</span><span class="p">:</span> <span class="n">ReviewStatus</span><span class="o">.</span><span class="n">UNREVIEWED</span><span class="o">.</span><span class="n">value</span>
                                        <span class="p">},</span>
                                        <span class="p">{</span><span class="s2">&quot;$set&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;reviewed&quot;</span><span class="p">:</span> <span class="n">ReviewStatus</span><span class="o">.</span><span class="n">SKIPPED</span><span class="o">.</span><span class="n">value</span><span class="p">}})</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="cedars.app.ops.db.mark_note_reviewed" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">mark_note_reviewed</span><span class="p">(</span><span class="n">note_id</span><span class="p">,</span> <span class="n">reviewed_by</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Updates the note's status to reviewed in the database.</p>
<p>Args:
    patient_id (int) : Unique ID for a patient.
    reviewed_by (str) : The name of the user who reviewed the note.</p>

            <details class="quote">
              <summary>Source code in <code>cedars/app/db.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1472</span>
<span class="normal">1473</span>
<span class="normal">1474</span>
<span class="normal">1475</span>
<span class="normal">1476</span>
<span class="normal">1477</span>
<span class="normal">1478</span>
<span class="normal">1479</span>
<span class="normal">1480</span>
<span class="normal">1481</span>
<span class="normal">1482</span>
<span class="normal">1483</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">mark_note_reviewed</span><span class="p">(</span><span class="n">note_id</span><span class="p">,</span> <span class="n">reviewed_by</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Updates the note&#39;s status to reviewed in the database.</span>

<span class="sd">     Args:</span>
<span class="sd">        patient_id (int) : Unique ID for a patient.</span>
<span class="sd">        reviewed_by (str) : The name of the user who reviewed the note.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Marking note #</span><span class="si">{</span><span class="n">note_id</span><span class="si">}</span><span class="s2"> as reviewed.&quot;</span><span class="p">)</span>
    <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;NOTES&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update_one</span><span class="p">({</span><span class="s2">&quot;text_id&quot;</span><span class="p">:</span> <span class="n">note_id</span><span class="p">},</span>
                                 <span class="p">{</span><span class="s2">&quot;$set&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;reviewed&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                                           <span class="s2">&quot;reviewed_by&quot;</span><span class="p">:</span> <span class="n">reviewed_by</span><span class="p">}})</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="cedars.app.ops.db.mark_patient_reviewed" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">mark_patient_reviewed</span><span class="p">(</span><span class="n">patient_id</span><span class="p">,</span> <span class="n">reviewed_by</span><span class="p">,</span> <span class="n">is_reviewed</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Updates the patient's status to reviewed in the database.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>patient_id</code></b>
                  (<code>int) </code>)
              –
              <div class="doc-md-description">
                <p>Unique ID for a patient.</p>
              </div>
            </li>
            <li>
              <b><code>reviewed_by</code></b>
                  (<code>str) </code>)
              –
              <div class="doc-md-description">
                <p>The name of the user who reviewed the patient.</p>
              </div>
            </li>
            <li>
              <b><code>is_reviewed</code></b>
                  (<code>bool) </code>, default:
                      <code>True</code>
)
              –
              <div class="doc-md-description">
                <p>True if patient's annotations have been reviewed.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>        <p>Returns:
    None</p>

            <details class="quote">
              <summary>Source code in <code>cedars/app/db.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1452</span>
<span class="normal">1453</span>
<span class="normal">1454</span>
<span class="normal">1455</span>
<span class="normal">1456</span>
<span class="normal">1457</span>
<span class="normal">1458</span>
<span class="normal">1459</span>
<span class="normal">1460</span>
<span class="normal">1461</span>
<span class="normal">1462</span>
<span class="normal">1463</span>
<span class="normal">1464</span>
<span class="normal">1465</span>
<span class="normal">1466</span>
<span class="normal">1467</span>
<span class="normal">1468</span>
<span class="normal">1469</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">mark_patient_reviewed</span><span class="p">(</span><span class="n">patient_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">reviewed_by</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">is_reviewed</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Updates the patient&#39;s status to reviewed in the database.</span>

<span class="sd">    Args:</span>
<span class="sd">        patient_id (int) : Unique ID for a patient.</span>
<span class="sd">        reviewed_by (str) : The name of the user who reviewed the patient.</span>
<span class="sd">        is_reviewed (bool) : True if patient&#39;s annotations have been reviewed.</span>
<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Marking patient #</span><span class="si">{</span><span class="n">patient_id</span><span class="si">}</span><span class="s2"> as reviewed.&quot;</span><span class="p">)</span>
    <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;PATIENTS&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update_one</span><span class="p">({</span><span class="s2">&quot;patient_id&quot;</span><span class="p">:</span> <span class="n">patient_id</span><span class="p">},</span>
                                    <span class="p">{</span><span class="s2">&quot;$set&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;reviewed&quot;</span><span class="p">:</span> <span class="n">is_reviewed</span><span class="p">,</span>
                                              <span class="s2">&quot;reviewed_by&quot;</span><span class="p">:</span> <span class="n">reviewed_by</span><span class="p">}})</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Storing results for patient #</span><span class="si">{</span><span class="n">patient_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">upsert_patient_records</span><span class="p">(</span><span class="n">patient_id</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="cedars.app.ops.db.patient_results_exist" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">patient_results_exist</span><span class="p">(</span><span class="n">patient_id</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Checks if the results for this patient exist in the RESULTS collection.</p>


<details class="args-" open>
  <summary>Args</summary>
  <ul>
<li>patient_id (str) : ID of the patient.</li>
</ul>
</details>

<details class="returns-" open>
  <summary>Returns</summary>
  <ul>
<li>has_result (bool) : True if this patient has a stored result.</li>
</ul>
</details>
            <details class="quote">
              <summary>Source code in <code>cedars/app/db.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">patient_results_exist</span><span class="p">(</span><span class="n">patient_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Checks if the results for this patient exist in the RESULTS collection.</span>

<span class="sd">    Args :</span>
<span class="sd">        - patient_id (str) : ID of the patient.</span>

<span class="sd">    Returns :</span>
<span class="sd">        - has_result (bool) : True if this patient has a stored result.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">stored_results</span> <span class="o">=</span> <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;RESULTS&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">find_one</span><span class="p">({</span><span class="s2">&quot;patient_id&quot;</span><span class="p">:</span> <span class="n">patient_id</span><span class="p">})</span>

    <span class="k">if</span> <span class="n">stored_results</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="kc">True</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="cedars.app.ops.db.predict_and_save" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">predict_and_save</span><span class="p">(</span><span class="n">text_ids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">note_collection_name</span><span class="o">=</span><span class="s1">&#39;NOTES&#39;</span><span class="p">,</span> <span class="n">pines_collection_name</span><span class="o">=</span><span class="s1">&#39;PINES&#39;</span><span class="p">,</span> <span class="n">force_update</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <h6 id="cedars.app.ops.db.predict_and_save--save-pines-predictions">Save PINES predictions</h6>
<p>Predict and save the predictions for the given text_ids.</p>

            <details class="quote">
              <summary>Source code in <code>cedars/app/db.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1788</span>
<span class="normal">1789</span>
<span class="normal">1790</span>
<span class="normal">1791</span>
<span class="normal">1792</span>
<span class="normal">1793</span>
<span class="normal">1794</span>
<span class="normal">1795</span>
<span class="normal">1796</span>
<span class="normal">1797</span>
<span class="normal">1798</span>
<span class="normal">1799</span>
<span class="normal">1800</span>
<span class="normal">1801</span>
<span class="normal">1802</span>
<span class="normal">1803</span>
<span class="normal">1804</span>
<span class="normal">1805</span>
<span class="normal">1806</span>
<span class="normal">1807</span>
<span class="normal">1808</span>
<span class="normal">1809</span>
<span class="normal">1810</span>
<span class="normal">1811</span>
<span class="normal">1812</span>
<span class="normal">1813</span>
<span class="normal">1814</span>
<span class="normal">1815</span>
<span class="normal">1816</span>
<span class="normal">1817</span>
<span class="normal">1818</span>
<span class="normal">1819</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">predict_and_save</span><span class="p">(</span><span class="n">text_ids</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                     <span class="n">note_collection_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;NOTES&quot;</span><span class="p">,</span>
                     <span class="n">pines_collection_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;PINES&quot;</span><span class="p">,</span>
                     <span class="n">force_update</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ##### Save PINES predictions</span>

<span class="sd">    Predict and save the predictions for the given text_ids.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">notes_collection</span> <span class="o">=</span> <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="n">note_collection_name</span><span class="p">]</span>
    <span class="n">pines_collection</span> <span class="o">=</span> <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="n">pines_collection_name</span><span class="p">]</span>
    <span class="n">query</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">text_ids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">query</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;text_id&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$in&quot;</span><span class="p">:</span> <span class="n">text_ids</span><span class="p">}}</span>

    <span class="n">cedars_notes</span> <span class="o">=</span> <span class="n">notes_collection</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">note</span> <span class="ow">in</span> <span class="n">cedars_notes</span><span class="p">:</span>
        <span class="n">note_id</span> <span class="o">=</span> <span class="n">note</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;text_id&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">force_update</span> <span class="ow">or</span> <span class="n">get_note_prediction_from_db</span><span class="p">(</span><span class="n">note_id</span><span class="p">,</span> <span class="n">pines_collection_name</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Predicting for note: </span><span class="si">{</span><span class="n">note_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">prediction</span> <span class="o">=</span> <span class="n">get_prediction</span><span class="p">(</span><span class="n">note</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">))</span>
            <span class="n">pines_collection</span><span class="o">.</span><span class="n">insert_one</span><span class="p">({</span>
                <span class="s2">&quot;text_id&quot;</span><span class="p">:</span> <span class="n">note_id</span><span class="p">,</span>
                <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">note</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">),</span>
                <span class="s2">&quot;text_date&quot;</span> <span class="p">:</span> <span class="n">note</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;text_date&quot;</span><span class="p">),</span>
                <span class="s2">&quot;patient_id&quot;</span><span class="p">:</span> <span class="n">note</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;patient_id&quot;</span><span class="p">),</span>
                <span class="s2">&quot;predicted_score&quot;</span><span class="p">:</span> <span class="n">prediction</span><span class="p">,</span>
                <span class="s2">&quot;report_type&quot;</span><span class="p">:</span> <span class="n">note</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;text_tag_3&quot;</span><span class="p">),</span>
                <span class="s2">&quot;document_type&quot;</span><span class="p">:</span> <span class="n">note</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;text_tag_1&quot;</span><span class="p">)</span>
                <span class="p">})</span>
        <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="cedars.app.ops.db.remove_all_locked" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">remove_all_locked</span><span class="p">()</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Sets the locked status of all patients to False.
This is done when the server is shutting down.</p>

            <details class="quote">
              <summary>Source code in <code>cedars/app/db.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1540</span>
<span class="normal">1541</span>
<span class="normal">1542</span>
<span class="normal">1543</span>
<span class="normal">1544</span>
<span class="normal">1545</span>
<span class="normal">1546</span>
<span class="normal">1547</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">remove_all_locked</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sets the locked status of all patients to False.</span>
<span class="sd">    This is done when the server is shutting down.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">patients_collection</span> <span class="o">=</span> <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;PATIENTS&quot;</span><span class="p">]</span>
    <span class="n">patients_collection</span><span class="o">.</span><span class="n">update_many</span><span class="p">({},</span>
                                    <span class="p">{</span><span class="s2">&quot;$set&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;locked&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}})</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="cedars.app.ops.db.report_failure" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">report_failure</span><span class="p">(</span><span class="n">job</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Saves the data associated with a job that failed to complete.
This will also automatically check for the completion of all current tasks.
If the tasks are completed will then create all required indices and shutdown
the PINES server if it is running via a SUPERBIO api.</p>

            <details class="quote">
              <summary>Source code in <code>cedars/app/db.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1891</span>
<span class="normal">1892</span>
<span class="normal">1893</span>
<span class="normal">1894</span>
<span class="normal">1895</span>
<span class="normal">1896</span>
<span class="normal">1897</span>
<span class="normal">1898</span>
<span class="normal">1899</span>
<span class="normal">1900</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">report_failure</span><span class="p">(</span><span class="n">job</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Saves the data associated with a job that failed to complete.</span>
<span class="sd">    This will also automatically check for the completion of all current tasks.</span>
<span class="sd">    If the tasks are completed will then create all required indices and shutdown</span>
<span class="sd">    the PINES server if it is running via a SUPERBIO api.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">job</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;progress&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">job</span><span class="o">.</span><span class="n">save_meta</span><span class="p">()</span>
    <span class="n">update_db_task_progress</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">get_id</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="cedars.app.ops.db.report_success" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">report_success</span><span class="p">(</span><span class="n">job</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Saves the data associated with a successful job after completion.
This will also automatically check for the completion of all current tasks.
If the tasks are completed will then create all required indices and shutdown
the PINES server if it is running via a SUPERBIO api.</p>

            <details class="quote">
              <summary>Source code in <code>cedars/app/db.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1878</span>
<span class="normal">1879</span>
<span class="normal">1880</span>
<span class="normal">1881</span>
<span class="normal">1882</span>
<span class="normal">1883</span>
<span class="normal">1884</span>
<span class="normal">1885</span>
<span class="normal">1886</span>
<span class="normal">1887</span>
<span class="normal">1888</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">report_success</span><span class="p">(</span><span class="n">job</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Saves the data associated with a successful job after completion.</span>
<span class="sd">    This will also automatically check for the completion of all current tasks.</span>
<span class="sd">    If the tasks are completed will then create all required indices and shutdown</span>
<span class="sd">    the PINES server if it is running via a SUPERBIO api.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">job</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;progress&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="n">job</span><span class="o">.</span><span class="n">save_meta</span><span class="p">()</span>

    <span class="n">update_db_task_progress</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">get_id</span><span class="p">(),</span> <span class="mi">100</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="cedars.app.ops.db.reset_patient_reviewed" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">reset_patient_reviewed</span><span class="p">()</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Update all patients, notes to be un-reviewed.</p>

            <details class="quote">
              <summary>Source code in <code>cedars/app/db.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1486</span>
<span class="normal">1487</span>
<span class="normal">1488</span>
<span class="normal">1489</span>
<span class="normal">1490</span>
<span class="normal">1491</span>
<span class="normal">1492</span>
<span class="normal">1493</span>
<span class="normal">1494</span>
<span class="normal">1495</span>
<span class="normal">1496</span>
<span class="normal">1497</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">reset_patient_reviewed</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Update all patients, notes to be un-reviewed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;PATIENTS&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update_many</span><span class="p">({},</span>
                                     <span class="p">{</span><span class="s2">&quot;$set&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;reviewed&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                                               <span class="s2">&quot;reviewed_by&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                                               <span class="s2">&quot;event_annotation_id&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                               <span class="s2">&quot;event_date&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                               <span class="s2">&quot;comments&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">}})</span>
    <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;NOTES&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update_many</span><span class="p">({},</span> <span class="p">{</span><span class="s2">&quot;$set&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;reviewed&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                                                <span class="s2">&quot;reviewed_by&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">}})</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="cedars.app.ops.db.revert_annotation_reviewed" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">revert_annotation_reviewed</span><span class="p">(</span><span class="n">annotation_id</span><span class="p">,</span> <span class="n">reviewed_by</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Reverts a reviewed annotation to be marked unreviewed in the case
where the event date for that patient is deleted on the current annotation.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>-</code></b>
                  (<code>annotation_id(str)</code>)
              –
              <div class="doc-md-description">
                <p>Unique ID for the annotation.</p>
              </div>
            </li>
            <li>
              <b><code>-</code></b>
                  (<code>reviewed_by(str)</code>)
              –
              <div class="doc-md-description">
                <p>The name of the user who deleted the event_date.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              –
              <div class="doc-md-description">
                <p>None</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
            <details class="quote">
              <summary>Source code in <code>cedars/app/db.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1285</span>
<span class="normal">1286</span>
<span class="normal">1287</span>
<span class="normal">1288</span>
<span class="normal">1289</span>
<span class="normal">1290</span>
<span class="normal">1291</span>
<span class="normal">1292</span>
<span class="normal">1293</span>
<span class="normal">1294</span>
<span class="normal">1295</span>
<span class="normal">1296</span>
<span class="normal">1297</span>
<span class="normal">1298</span>
<span class="normal">1299</span>
<span class="normal">1300</span>
<span class="normal">1301</span>
<span class="normal">1302</span>
<span class="normal">1303</span>
<span class="normal">1304</span>
<span class="normal">1305</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">revert_annotation_reviewed</span><span class="p">(</span><span class="n">annotation_id</span><span class="p">,</span> <span class="n">reviewed_by</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Reverts a reviewed annotation to be marked unreviewed in the case</span>
<span class="sd">    where the event date for that patient is deleted on the current annotation.</span>

<span class="sd">    Args:</span>
<span class="sd">        - annotation_id (str) : Unique ID for the annotation.</span>
<span class="sd">        - reviewed_by (str) : The name of the user who deleted the event_date.</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Marking annotation #</span><span class="si">{</span><span class="n">annotation_id</span><span class="si">}</span><span class="s2"> as un-reviewed.&quot;</span><span class="p">)</span>
    <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;ANNOTATIONS&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update_one</span><span class="p">({</span><span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="n">ObjectId</span><span class="p">(</span><span class="n">annotation_id</span><span class="p">)},</span>
                                       <span class="p">{</span><span class="s2">&quot;$set&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;reviewed&quot;</span><span class="p">:</span> <span class="n">ReviewStatus</span><span class="o">.</span><span class="n">UNREVIEWED</span><span class="o">.</span><span class="n">value</span><span class="p">}})</span>

    <span class="n">annotation_data</span> <span class="o">=</span> <span class="n">get_annotation</span><span class="p">(</span><span class="n">annotation_id</span><span class="p">)</span>
    <span class="n">note_id</span> <span class="o">=</span> <span class="n">annotation_data</span><span class="p">[</span><span class="s1">&#39;note_id&#39;</span><span class="p">]</span>

    <span class="c1"># Mark the note this annotation belongs to as un-reviewed</span>
    <span class="n">revert_note_reviewed</span><span class="p">(</span><span class="n">note_id</span><span class="p">,</span> <span class="n">reviewed_by</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="cedars.app.ops.db.revert_note_reviewed" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">revert_note_reviewed</span><span class="p">(</span><span class="n">note_id</span><span class="p">,</span> <span class="n">reviewed_by</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Updates the note's status to un-reviewed in the database.
This occurs when an event_date for the patient is deleted and
one of the annotations from this note is then marked un-reviewed.</p>
<p>Args:
    patient_id (int) : Unique ID for a patient.
    reviewed_by (str) : The name of the user who deleted the event_date
                        causing this note to be marked un-reviewed.</p>

            <details class="quote">
              <summary>Source code in <code>cedars/app/db.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1307</span>
<span class="normal">1308</span>
<span class="normal">1309</span>
<span class="normal">1310</span>
<span class="normal">1311</span>
<span class="normal">1312</span>
<span class="normal">1313</span>
<span class="normal">1314</span>
<span class="normal">1315</span>
<span class="normal">1316</span>
<span class="normal">1317</span>
<span class="normal">1318</span>
<span class="normal">1319</span>
<span class="normal">1320</span>
<span class="normal">1321</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">revert_note_reviewed</span><span class="p">(</span><span class="n">note_id</span><span class="p">,</span> <span class="n">reviewed_by</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Updates the note&#39;s status to un-reviewed in the database.</span>
<span class="sd">    This occurs when an event_date for the patient is deleted and</span>
<span class="sd">    one of the annotations from this note is then marked un-reviewed.</span>

<span class="sd">     Args:</span>
<span class="sd">        patient_id (int) : Unique ID for a patient.</span>
<span class="sd">        reviewed_by (str) : The name of the user who deleted the event_date</span>
<span class="sd">                            causing this note to be marked un-reviewed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Marking note #</span><span class="si">{</span><span class="n">note_id</span><span class="si">}</span><span class="s2"> as un-reviewed.&quot;</span><span class="p">)</span>
    <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;NOTES&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update_one</span><span class="p">({</span><span class="s2">&quot;text_id&quot;</span><span class="p">:</span> <span class="n">note_id</span><span class="p">},</span>
                                 <span class="p">{</span><span class="s2">&quot;$set&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;reviewed&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                                           <span class="s2">&quot;reviewed_by&quot;</span><span class="p">:</span> <span class="n">reviewed_by</span><span class="p">}})</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="cedars.app.ops.db.revert_skipped_annotations" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">revert_skipped_annotations</span><span class="p">(</span><span class="n">patient_id</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Reverts the skiped annotations for unreviewed events on or
after the event date for a paticular patient. This is done in the event of
a patient's event date being deleted.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>-</code></b>
                  (<code>patient_id(str)</code>)
              –
              <div class="doc-md-description">
                <p>ID for the patient</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              –
              <div class="doc-md-description">
                <ul>
<li>None</li>
</ul>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
            <details class="quote">
              <summary>Source code in <code>cedars/app/db.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1345</span>
<span class="normal">1346</span>
<span class="normal">1347</span>
<span class="normal">1348</span>
<span class="normal">1349</span>
<span class="normal">1350</span>
<span class="normal">1351</span>
<span class="normal">1352</span>
<span class="normal">1353</span>
<span class="normal">1354</span>
<span class="normal">1355</span>
<span class="normal">1356</span>
<span class="normal">1357</span>
<span class="normal">1358</span>
<span class="normal">1359</span>
<span class="normal">1360</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">revert_skipped_annotations</span><span class="p">(</span><span class="n">patient_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Reverts the skiped annotations for unreviewed events on or</span>
<span class="sd">    after the event date for a paticular patient. This is done in the event of</span>
<span class="sd">    a patient&#39;s event date being deleted.</span>

<span class="sd">    Args:</span>
<span class="sd">        - patient_id (str) : ID for the patient</span>

<span class="sd">    Returns:</span>
<span class="sd">        - None</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;ANNOTATIONS&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update_many</span><span class="p">({</span> <span class="s1">&#39;patient_id&#39;</span> <span class="p">:</span> <span class="n">patient_id</span><span class="p">,</span>
                                          <span class="s1">&#39;reviewed&#39;</span><span class="p">:</span> <span class="n">ReviewStatus</span><span class="o">.</span><span class="n">SKIPPED</span><span class="o">.</span><span class="n">value</span>
                                        <span class="p">},</span>
                                        <span class="p">{</span><span class="s2">&quot;$set&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;reviewed&quot;</span><span class="p">:</span> <span class="n">ReviewStatus</span><span class="o">.</span><span class="n">UNREVIEWED</span><span class="o">.</span><span class="n">value</span><span class="p">}})</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="cedars.app.ops.db.save_query" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">save_query</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">exclude_negated</span><span class="p">,</span> <span class="n">hide_duplicates</span><span class="p">,</span> <span class="n">skip_after_event</span><span class="p">,</span> <span class="n">tag_query</span><span class="p">,</span> <span class="n">date_min</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span> <span class="n">date_max</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>This function is used to save a regex query to the database.
All this data is kept in the QUERY collection.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>query</code></b>
                  (<code>str) </code>)
              –
              <div class="doc-md-description">
                <p>The regex query.</p>
              </div>
            </li>
            <li>
              <b><code>exclude_negated</code></b>
                  (<code>bool) </code>)
              –
              <div class="doc-md-description">
                <p>True if we want to exclude negated tokens.</p>
              </div>
            </li>
            <li>
              <b><code>hide_duplicates</code></b>
                  (<code>bool) </code>)
              –
              <div class="doc-md-description">
                <p>True if we want to restrict duplicate queries.</p>
              </div>
            </li>
            <li>
              <b><code>skip_after_event</code></b>
                  (<code>bool) </code>)
              –
              <div class="doc-md-description">
                <p>True if sentences occurring
                        after a recorded clinical event are to be skipped.</p>
              </div>
            </li>
            <li>
              <b><code>tag_query</code></b>
                  (<code>dict of mapping [str </code>)
              –
              <div class="doc-md-description">
                <p>list]) :
                        Key words to include or exclude in the search.</p>
              </div>
            </li>
            <li>
              <b><code>date_min</code></b>
                  (<code>str) </code>, default:
                      <code><span title="datetime.datetime.now">now</span>()</code>
)
              –
              <div class="doc-md-description">
                <p>Smallest date for valid query.</p>
              </div>
            </li>
            <li>
              <b><code>date_max</code></b>
                  (<code>str) </code>, default:
                      <code><span title="datetime.datetime.now">now</span>()</code>
)
              –
              <div class="doc-md-description">
                <p>Greatest date for valid query.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>        <p>Returns:
    Status (bool) : True if the query was saved,
                    False if query same quqery already exists.</p>

            <details class="quote">
              <summary>Source code in <code>cedars/app/db.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">save_query</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">exclude_negated</span><span class="p">,</span> <span class="n">hide_duplicates</span><span class="p">,</span>  <span class="c1"># pylint: disable=R0913</span>
               <span class="n">skip_after_event</span><span class="p">,</span> <span class="n">tag_query</span><span class="p">,</span> <span class="n">date_min</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
               <span class="n">date_max</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function is used to save a regex query to the database.</span>
<span class="sd">    All this data is kept in the QUERY collection.</span>

<span class="sd">    Args:</span>
<span class="sd">        query (str) : The regex query.</span>
<span class="sd">        exclude_negated (bool) : True if we want to exclude negated tokens.</span>
<span class="sd">        hide_duplicates (bool) : True if we want to restrict duplicate queries.</span>
<span class="sd">        skip_after_event (bool) : True if sentences occurring</span>
<span class="sd">                                    after a recorded clinical event are to be skipped.</span>
<span class="sd">        tag_query (dict of mapping [str : list]) :</span>
<span class="sd">                                    Key words to include or exclude in the search.</span>
<span class="sd">        date_min (str) : Smallest date for valid query.</span>
<span class="sd">        date_max (str) : Greatest date for valid query.</span>
<span class="sd">    Returns:</span>
<span class="sd">        Status (bool) : True if the query was saved,</span>
<span class="sd">                        False if query same quqery already exists.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">info</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">query</span><span class="p">,</span>
        <span class="s2">&quot;exclude_negated&quot;</span><span class="p">:</span> <span class="n">exclude_negated</span><span class="p">,</span>
        <span class="s2">&quot;hide_duplicates&quot;</span><span class="p">:</span> <span class="n">hide_duplicates</span><span class="p">,</span>
        <span class="s2">&quot;skip_after_event&quot;</span><span class="p">:</span> <span class="n">skip_after_event</span><span class="p">,</span>
        <span class="s2">&quot;tag_query&quot;</span><span class="p">:</span> <span class="n">tag_query</span><span class="p">,</span>
        <span class="s2">&quot;date_min&quot;</span><span class="p">:</span> <span class="n">date_min</span><span class="p">,</span>
        <span class="s2">&quot;date_max&quot;</span><span class="p">:</span> <span class="n">date_max</span>
    <span class="p">}</span>

    <span class="n">collection</span> <span class="o">=</span> <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;QUERY&quot;</span><span class="p">]</span>
    <span class="c1"># only one query is current at a time.</span>
    <span class="c1"># TODO: make a query history and enable multiple queries.</span>
    <span class="n">info</span><span class="p">[</span><span class="s2">&quot;current&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">query</span> <span class="o">==</span> <span class="n">get_search_query</span><span class="p">()</span> <span class="ow">and</span>
            <span class="n">skip_after_event</span> <span class="o">==</span> <span class="n">get_search_query</span><span class="p">(</span><span class="s2">&quot;skip_after_event&quot;</span><span class="p">)</span> <span class="ow">and</span>
            <span class="n">tag_query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;nlp_apply&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="o">==</span> <span class="n">get_search_query</span><span class="p">(</span><span class="s2">&quot;tag_query&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;nlp_apply&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Query already saved : </span><span class="si">{</span><span class="n">query</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="n">collection</span><span class="o">.</span><span class="n">update_one</span><span class="p">({</span><span class="s2">&quot;current&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span> <span class="p">{</span><span class="s2">&quot;$set&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;current&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}})</span>
    <span class="n">collection</span><span class="o">.</span><span class="n">insert_one</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved query : </span><span class="si">{</span><span class="n">query</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">True</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="cedars.app.ops.db.set_patient_lock_status" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">set_patient_lock_status</span><span class="p">(</span><span class="n">patient_id</span><span class="p">,</span> <span class="n">status</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Updates the status of the patient to be locked or unlocked.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>patient_id</code></b>
                  (<code>int) </code>)
              –
              <div class="doc-md-description">
                <p>ID for the patient we are locking / unlocking</p>
              </div>
            </li>
            <li>
              <b><code>status</code></b>
                  (<code>bool) </code>)
              –
              <div class="doc-md-description">
                <p>True if the patient is being locked, False otherwise.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              –
              <div class="doc-md-description">
                <p>None</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
            <details class="quote">
              <summary>Source code in <code>cedars/app/db.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1524</span>
<span class="normal">1525</span>
<span class="normal">1526</span>
<span class="normal">1527</span>
<span class="normal">1528</span>
<span class="normal">1529</span>
<span class="normal">1530</span>
<span class="normal">1531</span>
<span class="normal">1532</span>
<span class="normal">1533</span>
<span class="normal">1534</span>
<span class="normal">1535</span>
<span class="normal">1536</span>
<span class="normal">1537</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">set_patient_lock_status</span><span class="p">(</span><span class="n">patient_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">status</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Updates the status of the patient to be locked or unlocked.</span>

<span class="sd">    Args:</span>
<span class="sd">        patient_id (int) : ID for the patient we are locking / unlocking</span>
<span class="sd">        status (bool) : True if the patient is being locked, False otherwise.</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">patients_collection</span> <span class="o">=</span> <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;PATIENTS&quot;</span><span class="p">]</span>
    <span class="n">patients_collection</span><span class="o">.</span><span class="n">update_one</span><span class="p">({</span><span class="s2">&quot;patient_id&quot;</span><span class="p">:</span> <span class="n">patient_id</span><span class="p">},</span>
                                   <span class="p">{</span><span class="s2">&quot;$set&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;locked&quot;</span><span class="p">:</span> <span class="n">status</span><span class="p">}})</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="cedars.app.ops.db.terminate_project" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">terminate_project</span><span class="p">()</span></code>

</h2>


    <div class="doc doc-contents ">

        <h6 id="cedars.app.ops.db.terminate_project--terminate-the-project">Terminate the Project</h6>
<p>Reset the database to the initial state.</p>

            <details class="quote">
              <summary>Source code in <code>cedars/app/db.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2033</span>
<span class="normal">2034</span>
<span class="normal">2035</span>
<span class="normal">2036</span>
<span class="normal">2037</span>
<span class="normal">2038</span>
<span class="normal">2039</span>
<span class="normal">2040</span>
<span class="normal">2041</span>
<span class="normal">2042</span>
<span class="normal">2043</span>
<span class="normal">2044</span>
<span class="normal">2045</span>
<span class="normal">2046</span>
<span class="normal">2047</span>
<span class="normal">2048</span>
<span class="normal">2049</span>
<span class="normal">2050</span>
<span class="normal">2051</span>
<span class="normal">2052</span>
<span class="normal">2053</span>
<span class="normal">2054</span>
<span class="normal">2055</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">terminate_project</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ##### Terminate the Project</span>

<span class="sd">    Reset the database to the initial state.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Terminating project.&quot;</span><span class="p">)</span>
    <span class="c1"># Delete all mongo DB collections</span>
    <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">drop_collection</span><span class="p">(</span><span class="s2">&quot;ANNOTATIONS&quot;</span><span class="p">)</span>
    <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">drop_collection</span><span class="p">(</span><span class="s2">&quot;NOTES&quot;</span><span class="p">)</span>
    <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">drop_collection</span><span class="p">(</span><span class="s2">&quot;PATIENTS&quot;</span><span class="p">)</span>
    <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">drop_collection</span><span class="p">(</span><span class="s2">&quot;USERS&quot;</span><span class="p">)</span>
    <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">drop_collection</span><span class="p">(</span><span class="s2">&quot;QUERY&quot;</span><span class="p">)</span>
    <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">drop_collection</span><span class="p">(</span><span class="s2">&quot;PINES&quot;</span><span class="p">)</span>
    <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">drop_collection</span><span class="p">(</span><span class="s2">&quot;TASK&quot;</span><span class="p">)</span>
    <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">drop_collection</span><span class="p">(</span><span class="s2">&quot;RESULTS&quot;</span><span class="p">)</span>
    <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">drop_collection</span><span class="p">(</span><span class="s2">&quot;NOTES_SUMMARY&quot;</span><span class="p">)</span>

    <span class="n">project_id</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;PROJECT_ID&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="n">create_project</span><span class="p">(</span><span class="n">project_name</span><span class="o">=</span><span class="n">fake</span><span class="o">.</span><span class="n">slug</span><span class="p">(),</span>
                   <span class="n">investigator_name</span><span class="o">=</span><span class="n">fake</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span>
                   <span class="n">project_id</span> <span class="o">=</span> <span class="n">project_id</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="cedars.app.ops.db.update_annotation_reviewed" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">update_annotation_reviewed</span><span class="p">(</span><span class="n">note_id</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Mark all annotations for a note as reviewed.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>note_id</code></b>
                  (<code>str) </code>)
              –
              <div class="doc-md-description">
                <p>The note_id for which we want to mark all annotations as reviewed.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>        <p>Returns:
    count (int) : The number of annotations that were marked as reviewed.</p>

            <details class="quote">
              <summary>Source code in <code>cedars/app/db.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1550</span>
<span class="normal">1551</span>
<span class="normal">1552</span>
<span class="normal">1553</span>
<span class="normal">1554</span>
<span class="normal">1555</span>
<span class="normal">1556</span>
<span class="normal">1557</span>
<span class="normal">1558</span>
<span class="normal">1559</span>
<span class="normal">1560</span>
<span class="normal">1561</span>
<span class="normal">1562</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">update_annotation_reviewed</span><span class="p">(</span><span class="n">note_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Mark all annotations for a note as reviewed.</span>

<span class="sd">    Args:</span>
<span class="sd">        note_id (str) : The note_id for which we want to mark all annotations as reviewed.</span>
<span class="sd">    Returns:</span>
<span class="sd">        count (int) : The number of annotations that were marked as reviewed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">annotations_collection</span> <span class="o">=</span> <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;ANNOTATIONS&quot;</span><span class="p">]</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">annotations_collection</span><span class="o">.</span><span class="n">update_many</span><span class="p">({</span><span class="s2">&quot;note_id&quot;</span><span class="p">:</span> <span class="n">note_id</span><span class="p">},</span>
                                                <span class="p">{</span><span class="s2">&quot;$set&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;reviewed&quot;</span><span class="p">:</span> <span class="n">ReviewStatus</span><span class="o">.</span><span class="n">REVIEWED</span><span class="o">.</span><span class="n">value</span><span class="p">}})</span>
    <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">modified_count</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="cedars.app.ops.db.update_db_task_progress" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">update_db_task_progress</span><span class="p">(</span><span class="n">task_id</span><span class="p">,</span> <span class="n">progress</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Updates the progress of a task and checks if it has completed.
This function will also automatically unlock the patient after completion.</p>

            <details class="quote">
              <summary>Source code in <code>cedars/app/db.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1856</span>
<span class="normal">1857</span>
<span class="normal">1858</span>
<span class="normal">1859</span>
<span class="normal">1860</span>
<span class="normal">1861</span>
<span class="normal">1862</span>
<span class="normal">1863</span>
<span class="normal">1864</span>
<span class="normal">1865</span>
<span class="normal">1866</span>
<span class="normal">1867</span>
<span class="normal">1868</span>
<span class="normal">1869</span>
<span class="normal">1870</span>
<span class="normal">1871</span>
<span class="normal">1872</span>
<span class="normal">1873</span>
<span class="normal">1874</span>
<span class="normal">1875</span>
<span class="normal">1876</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">update_db_task_progress</span><span class="p">(</span><span class="n">task_id</span><span class="p">,</span> <span class="n">progress</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Updates the progress of a task and checks if it has completed.</span>
<span class="sd">    This function will also automatically unlock the patient after completion.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">task_db</span> <span class="o">=</span> <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;TASK&quot;</span><span class="p">]</span>
    <span class="n">task</span> <span class="o">=</span> <span class="n">task_db</span><span class="o">.</span><span class="n">find_one</span><span class="p">({</span><span class="s2">&quot;job_id&quot;</span><span class="p">:</span> <span class="n">task_id</span><span class="p">})</span>
    <span class="n">completed</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">task</span><span class="p">:</span>
        <span class="c1"># this might be the case if we have old messages</span>
        <span class="c1"># in the queue</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Task </span><span class="si">{</span><span class="n">task_id</span><span class="si">}</span><span class="s2"> not found in database.&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="n">progress</span> <span class="o">&gt;=</span> <span class="mi">100</span><span class="p">:</span>
        <span class="n">completed</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">task_db</span><span class="o">.</span><span class="n">update_one</span><span class="p">({</span><span class="s2">&quot;job_id&quot;</span><span class="p">:</span> <span class="n">task</span><span class="p">[</span><span class="s2">&quot;job_id&quot;</span><span class="p">]},</span>
                       <span class="p">{</span><span class="s2">&quot;$set&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;progress&quot;</span><span class="p">:</span> <span class="n">progress</span><span class="p">,</span>
                                 <span class="s2">&quot;complete&quot;</span><span class="p">:</span> <span class="n">completed</span><span class="p">}})</span>
    <span class="n">patient_id</span> <span class="o">=</span> <span class="p">(</span><span class="n">task_id</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="c1"># TODO: handle failed patients?</span>
    <span class="n">set_patient_lock_status</span><span class="p">(</span><span class="n">patient_id</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="cedars.app.ops.db.update_event_annotation_id" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">update_event_annotation_id</span><span class="p">(</span><span class="n">patient_id</span><span class="p">,</span> <span class="n">annotation_id</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Updates the ID for the annotation where 
        the event date for a patient was found.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>patient_id</code></b>
                  (<code>str) </code>)
              –
              <div class="doc-md-description">
                <p>Unique ID for the patient.</p>
              </div>
            </li>
            <li>
              <b><code>annotation_id</code></b>
                  (<code>str) </code>)
              –
              <div class="doc-md-description">
                <p>ID of the annotation where the
event date for this patient was entered.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>        <p>Returns:
    None</p>

            <details class="quote">
              <summary>Source code in <code>cedars/app/db.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1419</span>
<span class="normal">1420</span>
<span class="normal">1421</span>
<span class="normal">1422</span>
<span class="normal">1423</span>
<span class="normal">1424</span>
<span class="normal">1425</span>
<span class="normal">1426</span>
<span class="normal">1427</span>
<span class="normal">1428</span>
<span class="normal">1429</span>
<span class="normal">1430</span>
<span class="normal">1431</span>
<span class="normal">1432</span>
<span class="normal">1433</span>
<span class="normal">1434</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">update_event_annotation_id</span><span class="p">(</span><span class="n">patient_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">annotation_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Updates the ID for the annotation where </span>
<span class="sd">            the event date for a patient was found.</span>

<span class="sd">    Args:</span>
<span class="sd">        patient_id (str) : Unique ID for the patient.</span>
<span class="sd">        annotation_id (str) : ID of the annotation where the</span>
<span class="sd">            event date for this patient was entered.</span>
<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Updating event_annotation_id on patient #</span><span class="si">{</span><span class="n">patient_id</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

    <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;PATIENTS&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update_one</span><span class="p">({</span><span class="s2">&quot;patient_id&quot;</span><span class="p">:</span> <span class="n">patient_id</span><span class="p">},</span>
                                       <span class="p">{</span><span class="s2">&quot;$set&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;event_annotation_id&quot;</span><span class="p">:</span> <span class="n">annotation_id</span><span class="p">}})</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="cedars.app.ops.db.update_event_date" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">update_event_date</span><span class="p">(</span><span class="n">patient_id</span><span class="p">,</span> <span class="n">new_date</span><span class="p">,</span> <span class="n">annotation_id</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Enters a new event date for an patient.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>patient_id</code></b>
                  (<code>str) </code>)
              –
              <div class="doc-md-description">
                <p>Unique ID for the patient.</p>
              </div>
            </li>
            <li>
              <b><code>new_date</code></b>
                  (<code>Date / Datetime obj) </code>)
              –
              <div class="doc-md-description">
                <p>The new value to update the event date of the patient with.
Must be in the format YYYY-MM-DD.</p>
              </div>
            </li>
            <li>
              <b><code>annotation_id</code></b>
                  (<code>str) </code>)
              –
              <div class="doc-md-description">
                <p>ID for the annotation at which the new_date was marked.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>        <p>Returns:
    None</p>

            <details class="quote">
              <summary>Source code in <code>cedars/app/db.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1363</span>
<span class="normal">1364</span>
<span class="normal">1365</span>
<span class="normal">1366</span>
<span class="normal">1367</span>
<span class="normal">1368</span>
<span class="normal">1369</span>
<span class="normal">1370</span>
<span class="normal">1371</span>
<span class="normal">1372</span>
<span class="normal">1373</span>
<span class="normal">1374</span>
<span class="normal">1375</span>
<span class="normal">1376</span>
<span class="normal">1377</span>
<span class="normal">1378</span>
<span class="normal">1379</span>
<span class="normal">1380</span>
<span class="normal">1381</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">update_event_date</span><span class="p">(</span><span class="n">patient_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">new_date</span><span class="p">,</span> <span class="n">annotation_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Enters a new event date for an patient.</span>

<span class="sd">    Args:</span>
<span class="sd">        patient_id (str) : Unique ID for the patient.</span>
<span class="sd">        new_date (Date / Datetime obj) : The new value to update the event date of the patient with.</span>
<span class="sd">            Must be in the format YYYY-MM-DD.</span>
<span class="sd">        annotation_id (str) : ID for the annotation at which the new_date was marked.</span>
<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO: UTC dates</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Updating date on patient #</span><span class="si">{</span><span class="n">patient_id</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">new_date</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

    <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;PATIENTS&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update_one</span><span class="p">({</span><span class="s2">&quot;patient_id&quot;</span><span class="p">:</span> <span class="n">patient_id</span><span class="p">},</span>
                                       <span class="p">{</span><span class="s2">&quot;$set&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;event_date&quot;</span><span class="p">:</span> <span class="n">new_date</span><span class="p">}})</span>

    <span class="n">update_event_annotation_id</span><span class="p">(</span><span class="n">patient_id</span><span class="p">,</span> <span class="n">annotation_id</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="cedars.app.ops.db.update_notes_summary" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">update_notes_summary</span><span class="p">()</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Aggregates note summaries from the NOTES collection and saves them
to the NOTES_SUMMARY collection.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
<b><code>int</code></b>              –
              <div class="doc-md-description">
                <p>Number of summaries updated.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
            <details class="quote">
              <summary>Source code in <code>cedars/app/db.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">update_notes_summary</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Aggregates note summaries from the NOTES collection and saves them</span>
<span class="sd">    to the NOTES_SUMMARY collection.</span>

<span class="sd">    Returns:</span>
<span class="sd">        int: Number of summaries updated.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">notes_collection</span> <span class="o">=</span> <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;NOTES&quot;</span><span class="p">]</span>
    <span class="n">notes_summary_collection</span> <span class="o">=</span> <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;NOTES_SUMMARY&quot;</span><span class="p">]</span>

    <span class="c1"># Aggregation pipeline to compute summaries</span>
    <span class="n">pipeline</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s2">&quot;$group&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="s2">&quot;$patient_id&quot;</span><span class="p">,</span>  <span class="c1"># Group by patient_id</span>
                <span class="s2">&quot;num_notes&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$sum&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
                <span class="s2">&quot;first_note_date&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$min&quot;</span><span class="p">:</span> <span class="s2">&quot;$text_date&quot;</span><span class="p">},</span>
                <span class="s2">&quot;last_note_date&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$max&quot;</span><span class="p">:</span> <span class="s2">&quot;$text_date&quot;</span><span class="p">}</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;$project&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;patient_id&quot;</span><span class="p">:</span> <span class="s2">&quot;$_id&quot;</span><span class="p">,</span>
                <span class="s2">&quot;num_notes&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s2">&quot;first_note_date&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s2">&quot;last_note_date&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="mi">0</span>  <span class="c1"># Exclude the internal _id field</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">]</span>

    <span class="c1"># Perform aggregation</span>
    <span class="n">aggregated_results</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">notes_collection</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">pipeline</span><span class="p">))</span>

    <span class="c1"># Insert or update summaries in NOTES_SUMMARY</span>
    <span class="n">bulk_operations</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">summary</span> <span class="ow">in</span> <span class="n">aggregated_results</span><span class="p">:</span>
        <span class="n">bulk_operations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">UpdateOne</span><span class="p">(</span>
                <span class="p">{</span><span class="s2">&quot;patient_id&quot;</span><span class="p">:</span> <span class="n">summary</span><span class="p">[</span><span class="s2">&quot;patient_id&quot;</span><span class="p">]},</span>
                <span class="p">{</span>
                    <span class="s2">&quot;$set&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;num_notes&quot;</span><span class="p">:</span> <span class="n">summary</span><span class="p">[</span><span class="s2">&quot;num_notes&quot;</span><span class="p">],</span>
                        <span class="s2">&quot;first_note_date&quot;</span><span class="p">:</span> <span class="n">summary</span><span class="p">[</span><span class="s2">&quot;first_note_date&quot;</span><span class="p">],</span>
                        <span class="s2">&quot;last_note_date&quot;</span><span class="p">:</span> <span class="n">summary</span><span class="p">[</span><span class="s2">&quot;last_note_date&quot;</span><span class="p">],</span>
                    <span class="p">}</span>
                <span class="p">},</span>
                <span class="n">upsert</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">bulk_operations</span><span class="p">:</span>
        <span class="c1"># Perform bulk write to update or insert summaries</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">notes_summary_collection</span><span class="o">.</span><span class="n">bulk_write</span><span class="p">(</span><span class="n">bulk_operations</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">modified_count</span> <span class="o">+</span> <span class="n">result</span><span class="o">.</span><span class="n">upserted_count</span>

    <span class="k">return</span> <span class="mi">0</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="cedars.app.ops.db.update_patient_results" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">update_patient_results</span><span class="p">(</span><span class="n">update_existing_results</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Creates the results collection if it does not exist and
inserts data for patients that do not have any.
Optionally updates the data for all patients including
patients which already have results stored.</p>


<details class="args-" open>
  <summary>Args</summary>
  <ul>
<li>update_existing_results (bool) : True if data for patients
                                    that already have results must
                                    be updated.</li>
</ul>
</details>

<details class="returns-" open>
  <summary>Returns</summary>
  <ul>
<li>None</li>
</ul>
</details>
            <details class="quote">
              <summary>Source code in <code>cedars/app/db.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2009</span>
<span class="normal">2010</span>
<span class="normal">2011</span>
<span class="normal">2012</span>
<span class="normal">2013</span>
<span class="normal">2014</span>
<span class="normal">2015</span>
<span class="normal">2016</span>
<span class="normal">2017</span>
<span class="normal">2018</span>
<span class="normal">2019</span>
<span class="normal">2020</span>
<span class="normal">2021</span>
<span class="normal">2022</span>
<span class="normal">2023</span>
<span class="normal">2024</span>
<span class="normal">2025</span>
<span class="normal">2026</span>
<span class="normal">2027</span>
<span class="normal">2028</span>
<span class="normal">2029</span>
<span class="normal">2030</span>
<span class="normal">2031</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">update_patient_results</span><span class="p">(</span><span class="n">update_existing_results</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Creates the results collection if it does not exist and</span>
<span class="sd">    inserts data for patients that do not have any.</span>
<span class="sd">    Optionally updates the data for all patients including</span>
<span class="sd">    patients which already have results stored.</span>

<span class="sd">    Args :</span>
<span class="sd">        - update_existing_results (bool) : True if data for patients</span>
<span class="sd">                                            that already have results must</span>
<span class="sd">                                            be updated.</span>

<span class="sd">    Returns :</span>
<span class="sd">        - None</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="s2">&quot;RESULTS&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">list_collection_names</span><span class="p">():</span>
        <span class="c1"># Create results collection</span>
        <span class="n">populate_results</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">patient_id</span> <span class="ow">in</span> <span class="n">get_all_patient_ids</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">update_existing_results</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="n">patient_results_exist</span><span class="p">(</span><span class="n">patient_id</span><span class="p">)):</span>
            <span class="n">upsert_patient_records</span><span class="p">(</span><span class="n">patient_id</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="cedars.app.ops.db.update_pines_api_status" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">update_pines_api_status</span><span class="p">(</span><span class="n">new_status</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Updates the is_pines_server_enabled in the INFO collection of the database
    to reflect the status of the PINES server.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>new_status</code></b>
                  (<code>bool) </code>)
              –
              <div class="doc-md-description">
                <p>True if the PINES server is running.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>        <p>Returns:
    None</p>

            <details class="quote">
              <summary>Source code in <code>cedars/app/db.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1227</span>
<span class="normal">1228</span>
<span class="normal">1229</span>
<span class="normal">1230</span>
<span class="normal">1231</span>
<span class="normal">1232</span>
<span class="normal">1233</span>
<span class="normal">1234</span>
<span class="normal">1235</span>
<span class="normal">1236</span>
<span class="normal">1237</span>
<span class="normal">1238</span>
<span class="normal">1239</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">update_pines_api_status</span><span class="p">(</span><span class="n">new_status</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Updates the is_pines_server_enabled in the INFO collection of the database</span>
<span class="sd">        to reflect the status of the PINES server.</span>

<span class="sd">    Args:</span>
<span class="sd">        new_status (bool) : True if the PINES server is running.</span>
<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Setting PINES API status to </span><span class="si">{</span><span class="n">new_status</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;INFO&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update_one</span><span class="p">({},</span>
                                <span class="p">{</span><span class="s2">&quot;$set&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;is_pines_server_enabled&quot;</span><span class="p">:</span> <span class="n">new_status</span><span class="p">}})</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="cedars.app.ops.db.update_pines_api_url" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">update_pines_api_url</span><span class="p">(</span><span class="n">new_url</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Updates the PINES API url in the INFO collection of the database
    to reflect the address of the PINES server.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>new_url</code></b>
                  (<code>str) </code>)
              –
              <div class="doc-md-description">
                <p>The url of the PINES server's API.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>        <p>Returns:
    None</p>

            <details class="quote">
              <summary>Source code in <code>cedars/app/db.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1241</span>
<span class="normal">1242</span>
<span class="normal">1243</span>
<span class="normal">1244</span>
<span class="normal">1245</span>
<span class="normal">1246</span>
<span class="normal">1247</span>
<span class="normal">1248</span>
<span class="normal">1249</span>
<span class="normal">1250</span>
<span class="normal">1251</span>
<span class="normal">1252</span>
<span class="normal">1253</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">update_pines_api_url</span><span class="p">(</span><span class="n">new_url</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Updates the PINES API url in the INFO collection of the database</span>
<span class="sd">        to reflect the address of the PINES server.</span>

<span class="sd">    Args:</span>
<span class="sd">        new_url (str) : The url of the PINES server&#39;s API.</span>
<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Setting PINES API url to </span><span class="si">{</span><span class="n">new_url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;INFO&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update_one</span><span class="p">({},</span>
                                <span class="p">{</span><span class="s2">&quot;$set&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;pines_url&quot;</span><span class="p">:</span> <span class="n">new_url</span><span class="p">}})</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="cedars.app.ops.db.update_project_name" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">update_project_name</span><span class="p">(</span><span class="n">new_name</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Updates the project name in the INFO collection of the database.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>new_name</code></b>
                  (<code>str) </code>)
              –
              <div class="doc-md-description">
                <p>New name of the project.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>        <p>Returns:
    None</p>

            <details class="quote">
              <summary>Source code in <code>cedars/app/db.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1215</span>
<span class="normal">1216</span>
<span class="normal">1217</span>
<span class="normal">1218</span>
<span class="normal">1219</span>
<span class="normal">1220</span>
<span class="normal">1221</span>
<span class="normal">1222</span>
<span class="normal">1223</span>
<span class="normal">1224</span>
<span class="normal">1225</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">update_project_name</span><span class="p">(</span><span class="n">new_name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Updates the project name in the INFO collection of the database.</span>

<span class="sd">    Args:</span>
<span class="sd">        new_name (str) : New name of the project.</span>
<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Updating project name to #</span><span class="si">{</span><span class="n">new_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;INFO&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update_one</span><span class="p">({},</span> <span class="p">{</span><span class="s2">&quot;$set&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;project&quot;</span><span class="p">:</span> <span class="n">new_name</span><span class="p">}})</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="cedars.app.ops.db.upsert_patient_records" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">upsert_patient_records</span><span class="p">(</span><span class="n">patient_id</span><span class="p">,</span> <span class="n">insert_datetime</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">updated_by</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Updates records for a patient in the RESULTS collection.</p>


<details class="args-" open>
  <summary>Args</summary>
  <ul>
<li>patient_id (str) : ID of the patient who has been reviewed.</li>
</ul>
</details>

<details class="returns-" open>
  <summary>Returns</summary>
  <ul>
<li>None</li>
</ul>
</details>
            <details class="quote">
              <summary>Source code in <code>cedars/app/db.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">upsert_patient_records</span><span class="p">(</span><span class="n">patient_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">insert_datetime</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">updated_by</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Updates records for a patient in the RESULTS collection.</span>

<span class="sd">    Args :</span>
<span class="sd">        - patient_id (str) : ID of the patient who has been reviewed.</span>

<span class="sd">    Returns :</span>
<span class="sd">        - None</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">num_reviewed_notes</span> <span class="o">=</span> <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;NOTES&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">count_documents</span><span class="p">({</span><span class="s1">&#39;patient_id&#39;</span> <span class="p">:</span> <span class="n">patient_id</span><span class="p">,</span>
                                                        <span class="s1">&#39;reviewed&#39;</span> <span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
    <span class="n">all_note_details</span> <span class="o">=</span> <span class="n">get_formatted_patient_predictions</span><span class="p">(</span><span class="n">patient_id</span><span class="p">)</span>

    <span class="n">reviewed_sentences</span> <span class="o">=</span> <span class="n">get_patient_annotation_ids</span><span class="p">(</span><span class="n">patient_id</span><span class="p">,</span>
                                                                <span class="n">reviewed</span><span class="o">=</span><span class="n">ReviewStatus</span><span class="o">.</span><span class="n">REVIEWED</span><span class="p">,</span>
                                                                <span class="n">key</span><span class="o">=</span><span class="s2">&quot;sentence&quot;</span><span class="p">)</span>
    <span class="n">unreviewed_sentences</span> <span class="o">=</span> <span class="n">get_patient_annotation_ids</span><span class="p">(</span><span class="n">patient_id</span><span class="p">,</span>
                                                        <span class="n">reviewed</span><span class="o">=</span><span class="n">ReviewStatus</span><span class="o">.</span><span class="n">UNREVIEWED</span><span class="p">,</span>
                                                        <span class="n">key</span><span class="o">=</span><span class="s2">&quot;sentence&quot;</span><span class="p">)</span>
    <span class="n">sentences</span> <span class="o">=</span> <span class="n">reviewed_sentences</span> <span class="o">+</span> <span class="n">unreviewed_sentences</span>


    <span class="n">event_date</span> <span class="o">=</span> <span class="n">get_event_date</span><span class="p">(</span><span class="n">patient_id</span><span class="p">)</span>
    <span class="n">key_annotation_id</span> <span class="o">=</span> <span class="n">get_event_annotation_id</span><span class="p">(</span><span class="n">patient_id</span><span class="p">)</span>
    <span class="n">event_information</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="n">event_date</span> <span class="ow">and</span> <span class="n">key_annotation_id</span><span class="p">:</span>
        <span class="n">key_annotation</span> <span class="o">=</span> <span class="n">get_annotation</span><span class="p">(</span><span class="n">key_annotation_id</span><span class="p">)</span>
        <span class="n">event_information</span> <span class="o">=</span> <span class="n">key_annotation</span><span class="p">[</span><span class="s2">&quot;sentence&quot;</span><span class="p">]</span>
        <span class="n">key_note_id</span> <span class="o">=</span> <span class="n">key_annotation</span><span class="p">[</span><span class="s2">&quot;note_id&quot;</span><span class="p">]</span>
        <span class="n">event_information</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Note_id : </span><span class="si">{</span><span class="n">key_note_id</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="n">first_note_date</span> <span class="o">=</span> <span class="n">get_first_note_date_for_patient</span><span class="p">(</span><span class="n">patient_id</span><span class="p">)</span>
    <span class="n">last_note_date</span> <span class="o">=</span> <span class="n">get_last_note_date_for_patient</span><span class="p">(</span><span class="n">patient_id</span><span class="p">)</span>
    <span class="n">patient</span> <span class="o">=</span> <span class="n">get_patient_by_id</span><span class="p">(</span><span class="n">patient_id</span><span class="p">)</span>
    <span class="n">comments</span> <span class="o">=</span> <span class="n">patient</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;comments&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">updated_by</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">reviewer</span> <span class="o">=</span> <span class="n">updated_by</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">reviewer</span> <span class="o">=</span> <span class="n">get_patient_reviewer</span><span class="p">(</span><span class="n">patient_id</span><span class="p">)</span>

    <span class="n">max_score</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">max_score_note_id</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">max_score_note_date</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">get_max_prediction_score</span><span class="p">(</span><span class="n">patient_id</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">max_score</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;max_score&quot;</span><span class="p">]</span>
            <span class="n">max_score_note_id</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;text_id&quot;</span><span class="p">]</span>
            <span class="n">max_score_note_date</span> <span class="o">=</span> <span class="n">get_note_date</span><span class="p">(</span><span class="n">max_score_note_id</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;PINES results not available for patient: </span><span class="si">{</span><span class="n">patient_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">patient_results</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;patient_id&#39;</span> <span class="p">:</span> <span class="n">patient_id</span><span class="p">,</span>
        <span class="s1">&#39;total_notes&#39;</span> <span class="p">:</span> <span class="n">get_num_patient_notes</span><span class="p">(</span><span class="n">patient_id</span><span class="p">),</span>
        <span class="s1">&#39;reviewed_notes&#39;</span> <span class="p">:</span> <span class="n">num_reviewed_notes</span><span class="p">,</span>
        <span class="s1">&#39;total_sentences&#39;</span> <span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">sentences</span><span class="p">),</span>
        <span class="s1">&#39;reviewed_sentences&#39;</span> <span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">reviewed_sentences</span><span class="p">),</span>
        <span class="s1">&#39;sentences&#39;</span> <span class="p">:</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sentences</span><span class="p">),</span>
        <span class="s1">&#39;event_date&#39;</span> <span class="p">:</span> <span class="n">event_date</span><span class="p">,</span>
        <span class="s1">&#39;event_information&#39;</span> <span class="p">:</span> <span class="n">event_information</span><span class="p">,</span>
        <span class="s1">&#39;first_note_date&#39;</span> <span class="p">:</span> <span class="n">first_note_date</span><span class="p">,</span>
        <span class="s1">&#39;last_note_date&#39;</span> <span class="p">:</span> <span class="n">last_note_date</span><span class="p">,</span>
        <span class="s1">&#39;comments&#39;</span> <span class="p">:</span> <span class="n">comments</span><span class="p">,</span>
        <span class="s1">&#39;reviewer&#39;</span> <span class="p">:</span> <span class="n">reviewer</span><span class="p">,</span>
        <span class="s1">&#39;max_score_note_id&#39;</span> <span class="p">:</span> <span class="n">max_score_note_id</span><span class="p">,</span>
        <span class="s1">&#39;max_score_note_date&#39;</span> <span class="p">:</span> <span class="n">max_score_note_date</span><span class="p">,</span>
        <span class="s1">&#39;max_score&#39;</span> <span class="p">:</span> <span class="n">max_score</span><span class="p">,</span>
        <span class="s1">&#39;predicted_notes&#39;</span> <span class="p">:</span> <span class="n">all_note_details</span><span class="p">,</span>
        <span class="s1">&#39;last_updated&#39;</span> <span class="p">:</span> <span class="n">insert_datetime</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Updating results for patient #</span><span class="si">{</span><span class="n">patient_id</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
    <span class="n">patient_results</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;patient_id&quot;</span><span class="p">)</span>
    <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;RESULTS&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update_one</span><span class="p">({</span><span class="s2">&quot;patient_id&quot;</span><span class="p">:</span> <span class="n">patient_id</span><span class="p">},</span>
                                    <span class="p">{</span><span class="s2">&quot;$set&quot;</span><span class="p">:</span> <span class="n">patient_results</span><span class="p">})</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>
              
            </div>
          </div><footer>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
