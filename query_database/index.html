<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>Querying the Database - CEDARS</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../assets/_mkdocstrings.css" rel="stylesheet" />
        <link href="../style.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Querying the Database";
        var mkdocs_page_input_path = "query_database.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="..">
          <img src="../pics/cedar_G_centered.png" class="logo" alt="Logo"/>
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">Overview</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../ABOUT/">About</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../CEDARS_admin_manual/">Administrator Manual</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../CEDARS_annotator_manual/">Annotator Manual</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../TERMS_OF_USE/">Terms of Use</a>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">CEDARS</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">Querying the Database</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="querying-the-database">Querying the Database</h1>
<p>To search for medical events using CEDARS you will need to write a <a href="https://en.wikipedia.org/wiki/Regular_expression">regex</a> query. For more information regarding these queries, you can refer to the Basic Concepts section of the documentation. After you enter a query, click submit and the NLP algorithm will run on the database and save instances of the event when it is found. After the database has been searched, you will be redirected to the Adjudications page where you can view the search results.</p>
<h1 id="important-note">Important Note</h1>
<p>Keep in mind that entering a new query will erase all records of the prior query and so you are advised to download a copy of the results of prior queries before entering a new one.</p>
<h1 id="reference">Reference</h1>


<div class="doc doc-object doc-module">



<a id="cedars.app.ops.db"></a>
  <div class="doc doc-contents first">
  
      <p>This file contatins an abstract class for CEDARS to interact with mongodb.</p>

  

  <div class="doc doc-children">










<div class="doc doc-object doc-function">



<h2 id="cedars.app.ops.db.add_comment" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">add_comment</span><span class="p">(</span><span class="n">annotation_id</span><span class="p">,</span> <span class="n">comment</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Stores a new comment for a patient.</p>



<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>annotation_id</code></b>
                  (<code>str) </code>)
              –
              <div class="doc-md-description">
                <p>Unique ID for the annotation.</p>
              </div>
            </li>
            <li>
              <b><code>comment</code></b>
                  (<code>str) </code>)
              –
              <div class="doc-md-description">
                <p>Text of the comment on this annotation.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>      <p>Returns:
    None</p>

          <details class="quote">
            <summary>Source code in <code>cedars/app/db.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">add_comment</span><span class="p">(</span><span class="n">annotation_id</span><span class="p">,</span> <span class="n">comment</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Stores a new comment for a patient.</span>

<span class="sd">    Args:</span>
<span class="sd">        annotation_id (str) : Unique ID for the annotation.</span>
<span class="sd">        comment (str) : Text of the comment on this annotation.</span>
<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">comment</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No comment entered.&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Adding comment to annotation #</span><span class="si">{</span><span class="n">annotation_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">patient_id</span> <span class="o">=</span> <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;ANNOTATIONS&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">find_one</span><span class="p">({</span><span class="s2">&quot;_id&quot;</span> <span class="p">:</span> <span class="n">ObjectId</span><span class="p">(</span><span class="n">annotation_id</span><span class="p">)})[</span><span class="s2">&quot;patient_id&quot;</span><span class="p">]</span>
    <span class="n">patient</span> <span class="o">=</span> <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;PATIENTS&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">find_one</span><span class="p">({</span><span class="s2">&quot;patient_id&quot;</span> <span class="p">:</span> <span class="n">patient_id</span><span class="p">})</span>
    <span class="n">comments</span> <span class="o">=</span> <span class="n">patient</span><span class="p">[</span><span class="s2">&quot;comments&quot;</span><span class="p">]</span>
    <span class="n">comments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">comment</span><span class="p">)</span>
    <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;PATIENTS&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update_one</span><span class="p">({</span><span class="s2">&quot;patient_id&quot;</span> <span class="p">:</span> <span class="n">patient_id</span><span class="p">},</span>
                                       <span class="p">{</span> <span class="s2">&quot;$set&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;comments&quot;</span> <span class="p">:</span> <span class="n">comments</span> <span class="p">}</span> <span class="p">})</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="cedars.app.ops.db.add_project_user" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">add_project_user</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">is_admin</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Adds a new user to the project database.</p>



<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>username</code></b>
                  (<code>str)  </code>)
              –
              <div class="doc-md-description">
                <p>The name of the new user</p>
              </div>
            </li>
            <li>
              <b><code>password</code></b>
                  (<code>str)  </code>)
              –
              <div class="doc-md-description">
                <p>The user's password</p>
              </div>
            </li>
            <li>
              <b><code>is_admin</code></b>
                  (<code>bool) </code>, default:
                      <code>False</code>
)
              –
              <div class="doc-md-description">
                <p>True if the new user is the project admin
              (used when initializing the project)</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>      <p>Returns:
    None</p>

          <details class="quote">
            <summary>Source code in <code>cedars/app/db.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">add_project_user</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">is_admin</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Adds a new user to the project database.</span>

<span class="sd">    Args:</span>
<span class="sd">        username (str)  : The name of the new user</span>
<span class="sd">        password (str)  : The user&#39;s password</span>
<span class="sd">        is_admin (bool) : True if the new user is the project admin</span>
<span class="sd">                          (used when initializing the project)</span>
<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">password_hash</span> <span class="o">=</span> <span class="n">generate_password_hash</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;user&quot;</span> <span class="p">:</span> <span class="n">username</span><span class="p">,</span> <span class="s2">&quot;password&quot;</span> <span class="p">:</span> <span class="n">password_hash</span><span class="p">,</span> <span class="s2">&quot;admin&quot;</span> <span class="p">:</span> <span class="n">is_admin</span><span class="p">}</span>
    <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;USERS&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">insert_one</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="cedars.app.ops.db.add_user" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">add_user</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">is_admin</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>This function is used to add a new user to the database.
All this data is kept in the USERS collection.</p>



<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>username</code></b>
                  (<code>str) </code>)
              –
              <div class="doc-md-description">
                <p>The name of this user.</p>
              </div>
            </li>
            <li>
              <b><code>password</code></b>
                  (<code>str) </code>)
              –
              <div class="doc-md-description">
                <p>The password this user will need to login to the system.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>      <p>Returns:
    None</p>

          <details class="quote">
            <summary>Source code in <code>cedars/app/db.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">add_user</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">is_admin</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function is used to add a new user to the database.</span>
<span class="sd">    All this data is kept in the USERS collection.</span>

<span class="sd">    Args:</span>
<span class="sd">        username (str) : The name of this user.</span>
<span class="sd">        password (str) : The password this user will need to login to the system.</span>
<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">info</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;user&quot;</span> <span class="p">:</span> <span class="n">username</span><span class="p">,</span>
        <span class="s2">&quot;password&quot;</span> <span class="p">:</span> <span class="n">password</span><span class="p">,</span>
        <span class="s2">&quot;is_admin&quot;</span><span class="p">:</span> <span class="n">is_admin</span><span class="p">,</span>
        <span class="s2">&quot;date_created&quot;</span> <span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    <span class="p">}</span>
    <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;USERS&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">insert_one</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Added user </span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s2"> to database.&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="cedars.app.ops.db.check_password" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">check_password</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Checks if the password matches the password of that user from the database.</p>



<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>username</code></b>
                  (<code>str) </code>)
              –
              <div class="doc-md-description">
                <p>The name of the new user</p>
              </div>
            </li>
            <li>
              <b><code>password</code></b>
                  (<code>str) </code>)
              –
              <div class="doc-md-description">
                <p>The password entered by the user.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
    <th class="field-name">Returns:</th>
    <td class="field-body">
      <ul class="first simple">
          <li>
            –
            <div class="doc-md-description">
              <p>(bool) : True if the password matches the password of that user from the database.</p>
            </div>
          </li>
      </ul>
    </td>
    </tr>
  </tbody>
</table>
          <details class="quote">
            <summary>Source code in <code>cedars/app/db.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">821</span>
<span class="normal">822</span>
<span class="normal">823</span>
<span class="normal">824</span>
<span class="normal">825</span>
<span class="normal">826</span>
<span class="normal">827</span>
<span class="normal">828</span>
<span class="normal">829</span>
<span class="normal">830</span>
<span class="normal">831</span>
<span class="normal">832</span>
<span class="normal">833</span>
<span class="normal">834</span>
<span class="normal">835</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">check_password</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Checks if the password matches the password of that user from the database.</span>

<span class="sd">    Args:</span>
<span class="sd">        username (str) : The name of the new user</span>
<span class="sd">        password (str) : The password entered by the user.</span>

<span class="sd">    Returns:</span>
<span class="sd">        (bool) : True if the password matches the password of that user from the database.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">user</span> <span class="o">=</span> <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;USERS&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">find_one</span><span class="p">({</span><span class="s2">&quot;user&quot;</span> <span class="p">:</span> <span class="n">username</span><span class="p">})</span>

    <span class="k">return</span> <span class="s2">&quot;password&quot;</span> <span class="ow">in</span> <span class="n">user</span> <span class="ow">and</span> <span class="n">check_password_hash</span><span class="p">(</span><span class="n">user</span><span class="p">[</span><span class="s2">&quot;password&quot;</span><span class="p">],</span> <span class="n">password</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="cedars.app.ops.db.create_info_col" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">create_info_col</span><span class="p">(</span><span class="n">project_name</span><span class="p">,</span> <span class="n">investigator_name</span><span class="p">,</span> <span class="n">cedars_version</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>This function creates the info collection in the mongodb database.
The info collection is used to store meta-data regarding the current project.</p>



<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>project_name</code></b>
                  (<code>str) </code>)
              –
              <div class="doc-md-description">
                <p>Name of the research project</p>
              </div>
            </li>
            <li>
              <b><code>investigator_name</code></b>
                  (<code>str) </code>)
              –
              <div class="doc-md-description">
                <p>Name of the investigator on this project</p>
              </div>
            </li>
            <li>
              <b><code>cedars_version</code></b>
                  (<code>str) </code>)
              –
              <div class="doc-md-description">
                <p>Version of CEDARS used for this project</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>      <p>Returns:
    None</p>

          <details class="quote">
            <summary>Source code in <code>cedars/app/db.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">create_info_col</span><span class="p">(</span><span class="n">project_name</span><span class="p">,</span> <span class="n">investigator_name</span><span class="p">,</span> <span class="n">cedars_version</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function creates the info collection in the mongodb database.</span>
<span class="sd">    The info collection is used to store meta-data regarding the current project.</span>

<span class="sd">    Args:</span>
<span class="sd">        project_name (str) : Name of the research project</span>
<span class="sd">        investigator_name (str) : Name of the investigator on this project</span>
<span class="sd">        cedars_version (str) : Version of CEDARS used for this project</span>
<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">collection</span> <span class="o">=</span> <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;INFO&quot;</span><span class="p">]</span>
    <span class="n">info</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;creation_time&quot;</span> <span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
            <span class="s2">&quot;project&quot;</span> <span class="p">:</span> <span class="n">project_name</span><span class="p">,</span>
            <span class="s2">&quot;investigator&quot;</span> <span class="p">:</span> <span class="n">investigator_name</span><span class="p">,</span>
            <span class="s2">&quot;CEDARS_version&quot;</span> <span class="p">:</span> <span class="n">cedars_version</span><span class="p">}</span>

    <span class="n">collection</span><span class="o">.</span><span class="n">insert_one</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Created INFO collection.&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="cedars.app.ops.db.create_project" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">create_project</span><span class="p">(</span><span class="n">project_name</span><span class="p">,</span> <span class="n">investigator_name</span><span class="p">,</span> <span class="n">cedars_version</span><span class="o">=</span><span class="s1">&#39;0.1.0&#39;</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>This function creates all the collections in the mongodb database for CEDARS.</p>



<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>project_name</code></b>
                  (<code>str) </code>)
              –
              <div class="doc-md-description">
                <p>Name of the research project</p>
              </div>
            </li>
            <li>
              <b><code>investigator_name</code></b>
                  (<code>str) </code>)
              –
              <div class="doc-md-description">
                <p>Name of the investigator on this project</p>
              </div>
            </li>
            <li>
              <b><code>cedars_version</code></b>
                  (<code>str) </code>, default:
                      <code>&#39;0.1.0&#39;</code>
)
              –
              <div class="doc-md-description">
                <p>Version of CEDARS used for this project</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>      <p>Returns:
    None</p>

          <details class="quote">
            <summary>Source code in <code>cedars/app/db.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">create_project</span><span class="p">(</span><span class="n">project_name</span><span class="p">,</span> <span class="n">investigator_name</span><span class="p">,</span> <span class="n">cedars_version</span> <span class="o">=</span> <span class="s2">&quot;0.1.0&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function creates all the collections in the mongodb database for CEDARS.</span>

<span class="sd">    Args:</span>
<span class="sd">        project_name (str) : Name of the research project</span>
<span class="sd">        investigator_name (str) : Name of the investigator on this project</span>
<span class="sd">        cedars_version (str) : Version of CEDARS used for this project</span>
<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;INFO&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">find_one</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Database already created.&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="n">create_info_col</span><span class="p">(</span><span class="n">project_name</span><span class="p">,</span> <span class="n">investigator_name</span><span class="p">,</span> <span class="n">cedars_version</span><span class="p">)</span>

    <span class="n">populate_annotations</span><span class="p">()</span>
    <span class="n">populate_notes</span><span class="p">()</span>
    <span class="n">populate_users</span><span class="p">()</span>
    <span class="n">populate_query</span><span class="p">()</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Database creation successful!&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="cedars.app.ops.db.delete_annotation_date" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">delete_annotation_date</span><span class="p">(</span><span class="n">annotation_id</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Deletes the event date for an annotation.</p>



<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>annotation_id</code></b>
                  (<code>str) </code>)
              –
              <div class="doc-md-description">
                <p>Unique ID for the annotation.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>      <p>Returns:
    None</p>

          <details class="quote">
            <summary>Source code in <code>cedars/app/db.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">delete_annotation_date</span><span class="p">(</span><span class="n">annotation_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Deletes the event date for an annotation.</span>

<span class="sd">    Args:</span>
<span class="sd">        annotation_id (str) : Unique ID for the annotation.</span>
<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Deleting date on annotation #</span><span class="si">{</span><span class="n">ObjectId</span><span class="p">(</span><span class="n">annotation_id</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
    <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;ANNOTATIONS&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update_one</span><span class="p">({</span><span class="s2">&quot;_id&quot;</span> <span class="p">:</span> <span class="n">ObjectId</span><span class="p">(</span><span class="n">annotation_id</span><span class="p">)},</span>
                                      <span class="p">{</span> <span class="s2">&quot;$set&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;event_date&quot;</span> <span class="p">:</span> <span class="kc">None</span> <span class="p">}</span> <span class="p">})</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="cedars.app.ops.db.drop_database" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">drop_database</span><span class="p">(</span><span class="n">name</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Clean Database</p>

          <details class="quote">
            <summary>Source code in <code>cedars/app/db.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">816</span>
<span class="normal">817</span>
<span class="normal">818</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">drop_database</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Clean Database&quot;&quot;&quot;</span>
    <span class="n">mongo</span><span class="o">.</span><span class="n">cx</span><span class="o">.</span><span class="n">drop_database</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="cedars.app.ops.db.empty_annotations" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">empty_annotations</span><span class="p">()</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Deletes all annotations from the database</p>

          <details class="quote">
            <summary>Source code in <code>cedars/app/db.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span>
<span class="normal">812</span>
<span class="normal">813</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">empty_annotations</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Deletes all annotations from the database</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Deleting all data in annotations collection.&quot;</span><span class="p">)</span>
    <span class="n">annotations</span> <span class="o">=</span> <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;ANNOTATIONS&quot;</span><span class="p">]</span>
    <span class="n">annotations</span><span class="o">.</span><span class="n">delete_many</span><span class="p">({})</span>
    <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;PINES&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">delete_many</span><span class="p">({})</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="cedars.app.ops.db.get_all_annotations" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">get_all_annotations</span><span class="p">()</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Returns a list of all annotations from the database.</p>
      <p>Returns:
    Annotations (list) : This is a list of all annotations from the database.</p>

          <details class="quote">
            <summary>Source code in <code>cedars/app/db.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_all_annotations</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a list of all annotations from the database.</span>

<span class="sd">    Args:</span>
<span class="sd">        None</span>
<span class="sd">    Returns:</span>
<span class="sd">        Annotations (list) : This is a list of all annotations from the database.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">annotations</span> <span class="o">=</span> <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;ANNOTATIONS&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">()</span>

    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">annotations</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="cedars.app.ops.db.get_all_annotations_for_note" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">get_all_annotations_for_note</span><span class="p">(</span><span class="n">note_id</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>This function is used to get all the annotations for a particular note
after removing negated annotations.
Order of annotations -
    text_date (ascending)
    note_start_index (ascending)</p>

          <details class="quote">
            <summary>Source code in <code>cedars/app/db.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span>  <span class="nf">get_all_annotations_for_note</span><span class="p">(</span><span class="n">note_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function is used to get all the annotations for a particular note</span>
<span class="sd">    after removing negated annotations.</span>
<span class="sd">    Order of annotations -</span>
<span class="sd">        text_date (ascending)</span>
<span class="sd">        note_start_index (ascending)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">annotations</span> <span class="o">=</span> <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;ANNOTATIONS&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">({</span><span class="s2">&quot;note_id&quot;</span> <span class="p">:</span> <span class="n">note_id</span><span class="p">,</span>
                                                <span class="s2">&quot;isNegated&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">})</span><span class="o">.</span><span class="n">sort</span><span class="p">([(</span><span class="s2">&quot;text_date&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),(</span><span class="s2">&quot;setence_number&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)])</span>
    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">annotations</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="cedars.app.ops.db.get_all_notes" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">get_all_notes</span><span class="p">(</span><span class="n">patient_id</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Returns all notes for that patient.</p>

          <details class="quote">
            <summary>Source code in <code>cedars/app/db.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_all_notes</span><span class="p">(</span><span class="n">patient_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns all notes for that patient.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">notes</span> <span class="o">=</span> <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;NOTES&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">({</span><span class="s2">&quot;patient_id&quot;</span><span class="p">:</span> <span class="n">patient_id</span><span class="p">})</span>
    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">notes</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="cedars.app.ops.db.get_all_patients" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">get_all_patients</span><span class="p">()</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Returns all the patients in this project</p>
      <p>Returns:
    patients (list) : List of all patients in this project</p>

          <details class="quote">
            <summary>Source code in <code>cedars/app/db.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_all_patients</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns all the patients in this project</span>

<span class="sd">    Args:</span>
<span class="sd">        None</span>
<span class="sd">    Returns:</span>
<span class="sd">        patients (list) : List of all patients in this project</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">patients</span> <span class="o">=</span> <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;PATIENTS&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">()</span>

    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">patients</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="cedars.app.ops.db.get_annotated_notes_for_patient" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">get_annotated_notes_for_patient</span><span class="p">(</span><span class="n">patient_id</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>For a given patient, list all note_ids which have matching keyword
annotations</p>



<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>patient_id</code></b>
                  (<code>int) </code>)
              –
              <div class="doc-md-description">
                <p>The patient_id for which we want to retrieve the
annotated notes</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
    <th class="field-name">Returns:</th>
    <td class="field-body">
      <ul class="first simple">
          <li>
                <code>list[str]</code>
            –
            <div class="doc-md-description">
              <p>notes (list[str]) : List of note_ids for the patient which have
matching keyword annotations</p>
            </div>
          </li>
      </ul>
    </td>
    </tr>
  </tbody>
</table>
          <details class="quote">
            <summary>Source code in <code>cedars/app/db.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_annotated_notes_for_patient</span><span class="p">(</span><span class="n">patient_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    For a given patient, list all note_ids which have matching keyword</span>
<span class="sd">    annotations</span>

<span class="sd">    Args:</span>
<span class="sd">        patient_id (int) : The patient_id for which we want to retrieve the</span>
<span class="sd">            annotated notes</span>

<span class="sd">    Returns:</span>
<span class="sd">        notes (list[str]) : List of note_ids for the patient which have</span>
<span class="sd">            matching keyword annotations</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">annotations</span> <span class="o">=</span> <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;ANNOTATIONS&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">({</span><span class="s2">&quot;patient_id&quot;</span><span class="p">:</span> <span class="n">patient_id</span><span class="p">})</span>
    <span class="n">notes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">annotation</span> <span class="ow">in</span> <span class="n">annotations</span><span class="p">:</span>
        <span class="n">notes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">annotation</span><span class="p">[</span><span class="s2">&quot;note_id&quot;</span><span class="p">])</span>

    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">notes</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="cedars.app.ops.db.get_annotation" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">get_annotation</span><span class="p">(</span><span class="n">annotation_id</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Retrives annotation from mongodb.</p>



<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>annotation_id</code></b>
                  (<code>str) </code>)
              –
              <div class="doc-md-description">
                <p>Unique ID for the annotation.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>      <p>Returns:
    annotation (dict) : Dictionary for an annotation from mongodb.
        The keys are the attribute names.
        The values are the values of the attribute in that record.</p>

          <details class="quote">
            <summary>Source code in <code>cedars/app/db.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_annotation</span><span class="p">(</span><span class="n">annotation_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrives annotation from mongodb.</span>

<span class="sd">    Args:</span>
<span class="sd">        annotation_id (str) : Unique ID for the annotation.</span>
<span class="sd">    Returns:</span>
<span class="sd">        annotation (dict) : Dictionary for an annotation from mongodb.</span>
<span class="sd">            The keys are the attribute names.</span>
<span class="sd">            The values are the values of the attribute in that record.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">annotation</span> <span class="o">=</span> <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;ANNOTATIONS&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">find_one</span><span class="p">({</span> <span class="s2">&quot;_id&quot;</span> <span class="p">:</span> <span class="n">ObjectId</span><span class="p">(</span><span class="n">annotation_id</span><span class="p">)</span> <span class="p">})</span>

    <span class="k">return</span> <span class="n">annotation</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="cedars.app.ops.db.get_annotation_date" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">get_annotation_date</span><span class="p">(</span><span class="n">annotation_id</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Retrives the event date for an annotation.</p>

          <details class="quote">
            <summary>Source code in <code>cedars/app/db.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_annotation_date</span><span class="p">(</span><span class="n">annotation_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrives the event date for an annotation.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Retriving date on annotation #</span><span class="si">{</span><span class="n">ObjectId</span><span class="p">(</span><span class="n">annotation_id</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
    <span class="n">annotation</span> <span class="o">=</span> <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;ANNOTATIONS&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">find_one</span><span class="p">({</span><span class="s2">&quot;_id&quot;</span> <span class="p">:</span> <span class="n">ObjectId</span><span class="p">(</span><span class="n">annotation_id</span><span class="p">)})</span>
    <span class="k">if</span> <span class="s2">&quot;event_date&quot;</span> <span class="ow">in</span> <span class="n">annotation</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">annotation</span><span class="p">[</span><span class="s2">&quot;event_date&quot;</span><span class="p">]</span>
    <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="cedars.app.ops.db.get_annotation_note" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">get_annotation_note</span><span class="p">(</span><span class="n">annotation_id</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Retrives note linked to a paticular annotation.</p>



<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>annotation_id</code></b>
                  (<code>str) </code>)
              –
              <div class="doc-md-description">
                <p>Unique ID for the annotation.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>      <p>Returns:
    note (dict) : Dictionary for a note from mongodb.
                  The keys are the attribute names.
                  The values are the values of the attribute in that record.</p>

          <details class="quote">
            <summary>Source code in <code>cedars/app/db.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_annotation_note</span><span class="p">(</span><span class="n">annotation_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrives note linked to a paticular annotation.</span>

<span class="sd">    Args:</span>
<span class="sd">        annotation_id (str) : Unique ID for the annotation.</span>
<span class="sd">    Returns:</span>
<span class="sd">        note (dict) : Dictionary for a note from mongodb.</span>
<span class="sd">                      The keys are the attribute names.</span>
<span class="sd">                      The values are the values of the attribute in that record.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Retriving annotation #</span><span class="si">{</span><span class="n">annotation_id</span><span class="si">}</span><span class="s2"> from database.&quot;</span><span class="p">)</span>
    <span class="n">annotation</span> <span class="o">=</span> <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;ANNOTATIONS&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">find_one_or_404</span><span class="p">({</span> <span class="s2">&quot;_id&quot;</span> <span class="p">:</span> <span class="n">ObjectId</span><span class="p">(</span><span class="n">annotation_id</span><span class="p">)</span> <span class="p">})</span>
    <span class="n">note</span> <span class="o">=</span> <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;NOTES&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">find_one</span><span class="p">({</span><span class="s2">&quot;text_id&quot;</span> <span class="p">:</span> <span class="n">annotation</span><span class="p">[</span><span class="s2">&quot;note_id&quot;</span><span class="p">]</span> <span class="p">})</span>

    <span class="k">return</span> <span class="n">note</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="cedars.app.ops.db.get_curr_stats" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">get_curr_stats</span><span class="p">()</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Returns basic statistics for the project</p>

          <details class="quote">
            <summary>Source code in <code>cedars/app/db.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">847</span>
<span class="normal">848</span>
<span class="normal">849</span>
<span class="normal">850</span>
<span class="normal">851</span>
<span class="normal">852</span>
<span class="normal">853</span>
<span class="normal">854</span>
<span class="normal">855</span>
<span class="normal">856</span>
<span class="normal">857</span>
<span class="normal">858</span>
<span class="normal">859</span>
<span class="normal">860</span>
<span class="normal">861</span>
<span class="normal">862</span>
<span class="normal">863</span>
<span class="normal">864</span>
<span class="normal">865</span>
<span class="normal">866</span>
<span class="normal">867</span>
<span class="normal">868</span>
<span class="normal">869</span>
<span class="normal">870</span>
<span class="normal">871</span>
<span class="normal">872</span>
<span class="normal">873</span>
<span class="normal">874</span>
<span class="normal">875</span>
<span class="normal">876</span>
<span class="normal">877</span>
<span class="normal">878</span>
<span class="normal">879</span>
<span class="normal">880</span>
<span class="normal">881</span>
<span class="normal">882</span>
<span class="normal">883</span>
<span class="normal">884</span>
<span class="normal">885</span>
<span class="normal">886</span>
<span class="normal">887</span>
<span class="normal">888</span>
<span class="normal">889</span>
<span class="normal">890</span>
<span class="normal">891</span>
<span class="normal">892</span>
<span class="normal">893</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_curr_stats</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns basic statistics for the project</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">stats</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1"># Aggregation pipeline to count unique patients</span>
    <span class="n">pipeline_unique_patients</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="s2">&quot;$group&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="s2">&quot;$patient_id&quot;</span><span class="p">}}</span>
    <span class="p">]</span>
    <span class="n">unique_patients</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">PATIENTS</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">pipeline_unique_patients</span><span class="p">))</span>
    <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;number_of_patients&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_patients</span><span class="p">)</span>

    <span class="n">pipeline_annotated_patients</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="s2">&quot;$match&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;isNegated&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}},</span>
        <span class="p">{</span><span class="s2">&quot;$group&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="s2">&quot;$patient_id&quot;</span><span class="p">}}</span>
    <span class="p">]</span>
    <span class="n">annotated_patients</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">ANNOTATIONS</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">pipeline_annotated_patients</span><span class="p">))</span>
    <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;number_of_annotated_patients&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">annotated_patients</span><span class="p">)</span>

    <span class="c1"># Aggregation pipeline to count reviewed annotations</span>
    <span class="n">pipeline_reviewed</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="s2">&quot;$match&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;isNegated&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;reviewed&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}},</span>
        <span class="p">{</span><span class="s2">&quot;$group&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="s2">&quot;$patient_id&quot;</span><span class="p">}}</span>
    <span class="p">]</span>
    <span class="n">reviewed_annotations</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">ANNOTATIONS</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">pipeline_reviewed</span><span class="p">))</span>
    <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;number_of_reviewed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">reviewed_annotations</span><span class="p">)</span>

    <span class="c1"># pipeline for notes and reviewed by user for notes with reviewed_by field</span>
    <span class="n">pipeline_notes</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="s2">&quot;$match&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;reviewed&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}},</span>
        <span class="p">{</span><span class="s2">&quot;$group&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="s2">&quot;$reviewed_by&quot;</span><span class="p">,</span> <span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$sum&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}}}</span>
    <span class="p">]</span>

    <span class="n">reviewed_notes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">NOTES</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">pipeline_notes</span><span class="p">))</span>
    <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;user_review_stats&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">doc</span><span class="p">[</span><span class="s2">&quot;_id&quot;</span><span class="p">]:</span> <span class="n">doc</span><span class="p">[</span><span class="s2">&quot;count&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">reviewed_notes</span><span class="p">}</span>
    <span class="c1"># Aggregation pipeline for lemma distribution</span>
    <span class="n">pipeline_lemma_dist</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="s2">&quot;$match&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;isNegated&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}},</span>
        <span class="p">{</span><span class="s2">&quot;$group&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="s2">&quot;$token&quot;</span><span class="p">,</span> <span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$sum&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}}},</span>
        <span class="p">{</span><span class="s2">&quot;$sort&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">}},</span>
        <span class="p">{</span><span class="s2">&quot;$project&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;token&quot;</span><span class="p">:</span> <span class="s2">&quot;$_id&quot;</span><span class="p">,</span> <span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}}</span>
    <span class="p">]</span>
    <span class="n">lemma_dist_results</span> <span class="o">=</span> <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">ANNOTATIONS</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">pipeline_lemma_dist</span><span class="p">)</span>
    <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;lemma_dist&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">doc</span><span class="p">[</span><span class="s1">&#39;token&#39;</span><span class="p">]:</span> <span class="n">doc</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">lemma_dist_results</span><span class="p">}</span>

    <span class="k">return</span> <span class="n">stats</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="cedars.app.ops.db.get_curr_version" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">get_curr_version</span><span class="p">()</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Returns the name of the current project.</p>
      <p>Returns:
    proj_name (str) : The name of the current CEDARS project.</p>

          <details class="quote">
            <summary>Source code in <code>cedars/app/db.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_curr_version</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the name of the current project.</span>

<span class="sd">    Args:</span>
<span class="sd">        None</span>
<span class="sd">    Returns:</span>
<span class="sd">        proj_name (str) : The name of the current CEDARS project.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">proj_info</span> <span class="o">=</span> <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;INFO&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">find_one</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">proj_info</span><span class="p">[</span><span class="s2">&quot;CEDARS_version&quot;</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="cedars.app.ops.db.get_documents_to_annotate" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">get_documents_to_annotate</span><span class="p">()</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Retrives all documents that have not been annotated.</p>

          <details class="quote">
            <summary>Source code in <code>cedars/app/db.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_documents_to_annotate</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrives all documents that have not been annotated.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Retriving all annotated documents from database.&quot;</span><span class="p">)</span>
    <span class="n">documents_to_annotate</span> <span class="o">=</span> <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;NOTES&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span>
        <span class="p">[{</span>
            <span class="s2">&quot;$lookup&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;from&quot;</span><span class="p">:</span> <span class="s2">&quot;ANNOTATIONS&quot;</span><span class="p">,</span>
                <span class="s2">&quot;localField&quot;</span><span class="p">:</span> <span class="s2">&quot;text_id&quot;</span><span class="p">,</span>
                <span class="s2">&quot;foreignField&quot;</span><span class="p">:</span> <span class="s2">&quot;text_id&quot;</span><span class="p">,</span>
                <span class="s2">&quot;as&quot;</span><span class="p">:</span> <span class="s2">&quot;annotations&quot;</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;$match&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;annotations&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$eq&quot;</span><span class="p">:</span> <span class="p">[]}</span>
            <span class="p">}</span>
        <span class="p">}])</span>

    <span class="k">return</span> <span class="n">documents_to_annotate</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="cedars.app.ops.db.get_event_date" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">get_event_date</span><span class="p">(</span><span class="n">patient_id</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Find the event date from the annotations for a patient.</p>

          <details class="quote">
            <summary>Source code in <code>cedars/app/db.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_event_date</span><span class="p">(</span><span class="n">patient_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Find the event date from the annotations for a patient.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Retriving event date for patient #</span><span class="si">{</span><span class="n">patient_id</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
    <span class="n">annotations</span> <span class="o">=</span> <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;ANNOTATIONS&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">({</span><span class="s2">&quot;patient_id&quot;</span> <span class="p">:</span> <span class="n">patient_id</span><span class="p">,</span>
                                               <span class="s2">&quot;event_date&quot;</span> <span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$ne&quot;</span> <span class="p">:</span> <span class="kc">None</span><span class="p">}})</span><span class="o">.</span><span class="n">sort</span><span class="p">([(</span><span class="s2">&quot;event_date&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)])</span>
    <span class="n">annotations</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">annotations</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">annotations</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">annotations</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;event_date&quot;</span><span class="p">]</span>

    <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="cedars.app.ops.db.get_first_note_date_for_patient" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">get_first_note_date_for_patient</span><span class="p">(</span><span class="n">patient_id</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Retrives the date of the first note for a patient.</p>



<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>patient_id</code></b>
                  (<code>int) </code>)
              –
              <div class="doc-md-description">
                <p>Unique ID for a patient.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>      <p>Returns:
    note_date (datetime) : The date of the first note for the patient.</p>

          <details class="quote">
            <summary>Source code in <code>cedars/app/db.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_first_note_date_for_patient</span><span class="p">(</span><span class="n">patient_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrives the date of the first note for a patient.</span>

<span class="sd">    Args:</span>
<span class="sd">        patient_id (int) : Unique ID for a patient.</span>
<span class="sd">    Returns:</span>
<span class="sd">        note_date (datetime) : The date of the first note for the patient.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Retriving first note date for patient #</span><span class="si">{</span><span class="n">patient_id</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
    <span class="n">note</span> <span class="o">=</span> <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;NOTES&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">find_one</span><span class="p">({</span><span class="s2">&quot;patient_id&quot;</span> <span class="p">:</span> <span class="n">patient_id</span><span class="p">},</span>
                                      <span class="n">sort</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">&quot;text_date&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)])</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">note</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="n">note</span><span class="p">[</span><span class="s2">&quot;text_date&quot;</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="cedars.app.ops.db.get_info" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">get_info</span><span class="p">()</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>This function returns the info collection in the mongodb database.</p>

          <details class="quote">
            <summary>Source code in <code>cedars/app/db.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_info</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function returns the info collection in the mongodb database.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">INFO</span><span class="o">.</span><span class="n">find_one_or_404</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="cedars.app.ops.db.get_last_note_date_for_patient" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">get_last_note_date_for_patient</span><span class="p">(</span><span class="n">patient_id</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Retrives the date of the last note for a patient.</p>



<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>patient_id</code></b>
                  (<code>int) </code>)
              –
              <div class="doc-md-description">
                <p>Unique ID for a patient.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>      <p>Returns:
    note_date (datetime) : The date of the last note for the patient.</p>

          <details class="quote">
            <summary>Source code in <code>cedars/app/db.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_last_note_date_for_patient</span><span class="p">(</span><span class="n">patient_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrives the date of the last note for a patient.</span>

<span class="sd">    Args:</span>
<span class="sd">        patient_id (int) : Unique ID for a patient.</span>
<span class="sd">    Returns:</span>
<span class="sd">        note_date (datetime) : The date of the last note for the patient.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Retriving last note date for patient #</span><span class="si">{</span><span class="n">patient_id</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
    <span class="n">note</span> <span class="o">=</span> <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;NOTES&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">find_one</span><span class="p">({</span><span class="s2">&quot;patient_id&quot;</span> <span class="p">:</span> <span class="n">patient_id</span><span class="p">},</span>
                                      <span class="n">sort</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">&quot;text_date&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)])</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">note</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="n">note</span><span class="p">[</span><span class="s2">&quot;text_date&quot;</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="cedars.app.ops.db.get_note_prediction_from_db" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">get_note_prediction_from_db</span><span class="p">(</span><span class="n">note_id</span><span class="p">,</span> <span class="n">pines_collection_name</span><span class="o">=</span><span class="s1">&#39;PINES&#39;</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Retrieve the prediction score for a given from the database</p>



<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>pines_collection_name</code></b>
                  (<code>str</code>, default:
                      <code>&#39;PINES&#39;</code>
)
              –
              <div class="doc-md-description">
                <p>The name of the collection in the database</p>
              </div>
            </li>
            <li>
              <b><code>note_id</code></b>
                  (<code>str</code>)
              –
              <div class="doc-md-description">
                <p>The note_id for which we want to retrieve the prediction</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
    <th class="field-name">Returns:</th>
    <td class="field-body">
      <ul class="first simple">
          <li>
<b><code>float</code></b>(                <code><span title="typing.Optional">Optional</span>[float]</code>
)            –
            <div class="doc-md-description">
              <p>The prediction score for the note</p>
            </div>
          </li>
      </ul>
    </td>
    </tr>
  </tbody>
</table>
          <details class="quote">
            <summary>Source code in <code>cedars/app/db.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">920</span>
<span class="normal">921</span>
<span class="normal">922</span>
<span class="normal">923</span>
<span class="normal">924</span>
<span class="normal">925</span>
<span class="normal">926</span>
<span class="normal">927</span>
<span class="normal">928</span>
<span class="normal">929</span>
<span class="normal">930</span>
<span class="normal">931</span>
<span class="normal">932</span>
<span class="normal">933</span>
<span class="normal">934</span>
<span class="normal">935</span>
<span class="normal">936</span>
<span class="normal">937</span>
<span class="normal">938</span>
<span class="normal">939</span>
<span class="normal">940</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_note_prediction_from_db</span><span class="p">(</span><span class="n">note_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                                <span class="n">pines_collection_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;PINES&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrieve the prediction score for a given from the database</span>

<span class="sd">    Args:</span>
<span class="sd">        pines_collection_name (str): The name of the collection in the database</span>
<span class="sd">        note_id (str): The note_id for which we want to retrieve the prediction</span>

<span class="sd">    Returns:</span>
<span class="sd">        float: The prediction score for the note</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pines_collection</span> <span class="o">=</span> <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="n">pines_collection_name</span><span class="p">]</span>
    <span class="n">query</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;text_id&quot;</span><span class="p">:</span> <span class="n">note_id</span><span class="p">}</span>

    <span class="n">pines_pred</span> <span class="o">=</span> <span class="n">pines_collection</span><span class="o">.</span><span class="n">find_one</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">pines_pred</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found prediction in db for : </span><span class="si">{</span><span class="n">note_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">pines_pred</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;predicted_score&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">round</span><span class="p">(</span><span class="n">pines_pred</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;predicted_score&quot;</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Prediction not found in db for : </span><span class="si">{</span><span class="n">note_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="cedars.app.ops.db.get_patient" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">get_patient</span><span class="p">()</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Retrives a single patient ID who has not yet been reviewed and is not currently locked.
The chosen patient is simply the first one in the database that has not yet been reviewed.</p>
      <p>Returns:
    patient_id (int) : Unique ID for a patient.</p>

          <details class="quote">
            <summary>Source code in <code>cedars/app/db.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_patient</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrives a single patient ID who has not yet been reviewed and is not currently locked.</span>
<span class="sd">    The chosen patient is simply the first one in the database that has not yet been reviewed.</span>

<span class="sd">    Args:</span>
<span class="sd">        None</span>
<span class="sd">    Returns:</span>
<span class="sd">        patient_id (int) : Unique ID for a patient.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">patient</span> <span class="o">=</span> <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;PATIENTS&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">find_one</span><span class="p">({</span><span class="s2">&quot;reviewed&quot;</span> <span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                                             <span class="s2">&quot;locked&quot;</span> <span class="p">:</span> <span class="kc">False</span><span class="p">})</span>

    <span class="k">if</span> <span class="n">patient</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s2">&quot;patient_id&quot;</span> <span class="ow">in</span> <span class="n">patient</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Retriving patient #</span><span class="si">{</span><span class="n">patient</span><span class="p">[</span><span class="s1">&#39;patient_id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> from database.&quot;</span><span class="p">,</span> <span class="p">)</span>
        <span class="k">return</span> <span class="n">patient</span><span class="p">[</span><span class="s2">&quot;patient_id&quot;</span><span class="p">]</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Failed to retrive any further un-reviewed patients from the database.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="cedars.app.ops.db.get_patient_annotation_ids" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">get_patient_annotation_ids</span><span class="p">(</span><span class="n">p_id</span><span class="p">,</span> <span class="n">reviewed</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;_id&#39;</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Retrives all annotation IDs for annotations linked to a patient.</p>



<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>p_id</code></b>
                  (<code>int) </code>)
              –
              <div class="doc-md-description">
                <p>Unique ID for a patient.</p>
              </div>
            </li>
            <li>
              <b><code>reviewed</code></b>
                  (<code>bool) </code>, default:
                      <code>False</code>
)
              –
              <div class="doc-md-description">
                <p>True if we want to get reviewed annotations.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>      <p>Returns:
    annotations (list) : A list of all annotation IDs linked to that patient.</p>

          <details class="quote">
            <summary>Source code in <code>cedars/app/db.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_patient_annotation_ids</span><span class="p">(</span><span class="n">p_id</span><span class="p">,</span> <span class="n">reviewed</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;_id&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrives all annotation IDs for annotations linked to a patient.</span>

<span class="sd">    Args:</span>
<span class="sd">        p_id (int) : Unique ID for a patient.</span>
<span class="sd">        reviewed (bool) : True if we want to get reviewed annotations.</span>
<span class="sd">    Returns:</span>
<span class="sd">        annotations (list) : A list of all annotation IDs linked to that patient.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Retriving annotations for patient #</span><span class="si">{</span><span class="n">p_id</span><span class="si">}</span><span class="s2"> from database.&quot;</span><span class="p">)</span>
    <span class="n">annotation_ids</span> <span class="o">=</span> <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;ANNOTATIONS&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">({</span><span class="s2">&quot;patient_id&quot;</span><span class="p">:</span> <span class="n">p_id</span><span class="p">,</span>
                                                   <span class="s2">&quot;reviewed&quot;</span> <span class="p">:</span> <span class="n">reviewed</span><span class="p">,</span>
                                                   <span class="s2">&quot;isNegated&quot;</span> <span class="p">:</span> <span class="kc">False</span><span class="p">})</span><span class="o">.</span><span class="n">sort</span><span class="p">([(</span><span class="s2">&quot;note_id&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                                                                               <span class="p">(</span><span class="s1">&#39;text_date&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                                                                               <span class="p">(</span><span class="s2">&quot;sentence_number&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)])</span>

    <span class="k">return</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="nb">id</span><span class="p">[</span><span class="n">key</span><span class="p">])</span> <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">annotation_ids</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="cedars.app.ops.db.get_patient_by_id" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">get_patient_by_id</span><span class="p">(</span><span class="n">patient_id</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Retrives a single patient from mongodb.</p>



<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>patient_id</code></b>
                  (<code>int) </code>)
              –
              <div class="doc-md-description">
                <p>Unique ID for a patient.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>      <p>Returns:
    patient (dict) : Dictionary for a patient from mongodb.
                     The keys are the attribute names.
                     The values are the values of the attribute in that record.</p>

          <details class="quote">
            <summary>Source code in <code>cedars/app/db.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_patient_by_id</span><span class="p">(</span><span class="n">patient_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrives a single patient from mongodb.</span>

<span class="sd">    Args:</span>
<span class="sd">        patient_id (int) : Unique ID for a patient.</span>
<span class="sd">    Returns:</span>
<span class="sd">        patient (dict) : Dictionary for a patient from mongodb.</span>
<span class="sd">                         The keys are the attribute names.</span>
<span class="sd">                         The values are the values of the attribute in that record.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Retriving patient #</span><span class="si">{</span><span class="n">patient_id</span><span class="si">}</span><span class="s2"> from database.&quot;</span><span class="p">)</span>
    <span class="n">patient</span> <span class="o">=</span> <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;PATIENTS&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">find_one</span><span class="p">({</span><span class="s2">&quot;patient_id&quot;</span> <span class="p">:</span> <span class="n">patient_id</span><span class="p">})</span>

    <span class="k">return</span> <span class="n">patient</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="cedars.app.ops.db.get_patient_ids" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">get_patient_ids</span><span class="p">()</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Returns all the patient IDs in this project</p>
      <p>Returns:
    patient_ids (list) : List of all patient IDs in this project</p>

          <details class="quote">
            <summary>Source code in <code>cedars/app/db.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_patient_ids</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns all the patient IDs in this project</span>

<span class="sd">    Args:</span>
<span class="sd">        None</span>
<span class="sd">    Returns:</span>
<span class="sd">        patient_ids (list) : List of all patient IDs in this project</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">patients</span> <span class="o">=</span> <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;PATIENTS&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">()</span>

    <span class="k">return</span> <span class="p">[</span><span class="n">patient</span><span class="p">[</span><span class="s2">&quot;patient_id&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">patient</span> <span class="ow">in</span> <span class="n">patients</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="cedars.app.ops.db.get_patient_lock_status" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">get_patient_lock_status</span><span class="p">(</span><span class="n">patient_id</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Updates the status of the patient to be locked or unlocked.</p>



<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>patient_id</code></b>
                  (<code>int) </code>)
              –
              <div class="doc-md-description">
                <p>ID for the patient we are locking / unlocking</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>      <p>Returns:
    status (bool) : True if the patient is locked, False otherwise.
        If no such patient is found, we return None.</p>

          <details class="quote">
            <summary>Source code in <code>cedars/app/db.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_patient_lock_status</span><span class="p">(</span><span class="n">patient_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Updates the status of the patient to be locked or unlocked.</span>

<span class="sd">    Args:</span>
<span class="sd">        patient_id (int) : ID for the patient we are locking / unlocking</span>
<span class="sd">    Returns:</span>
<span class="sd">        status (bool) : True if the patient is locked, False otherwise.</span>
<span class="sd">            If no such patient is found, we return None.</span>

<span class="sd">    Raises:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">patient</span> <span class="o">=</span> <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;PATIENTS&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">find_one</span><span class="p">({</span><span class="s2">&quot;patient_id&quot;</span> <span class="p">:</span> <span class="n">patient_id</span><span class="p">})</span>
    <span class="k">return</span> <span class="n">patient</span><span class="p">[</span><span class="s2">&quot;locked&quot;</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="cedars.app.ops.db.get_patient_notes" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">get_patient_notes</span><span class="p">(</span><span class="n">patient_id</span><span class="p">,</span> <span class="n">reviewed</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Returns all notes for that patient.</p>



<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>patient_id</code></b>
                  (<code>int) </code>)
              –
              <div class="doc-md-description">
                <p>ID for the patient</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>      <p>Returns:
    notes (list) : A list of all notes for that patient</p>

          <details class="quote">
            <summary>Source code in <code>cedars/app/db.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_patient_notes</span><span class="p">(</span><span class="n">patient_id</span><span class="p">,</span> <span class="n">reviewed</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns all notes for that patient.</span>

<span class="sd">    Args:</span>
<span class="sd">        patient_id (int) : ID for the patient</span>
<span class="sd">    Returns:</span>
<span class="sd">        notes (list) : A list of all notes for that patient</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mongodb_search_query</span> <span class="o">=</span> <span class="p">{</span> <span class="s2">&quot;patient_id&quot;</span><span class="p">:</span> <span class="n">patient_id</span><span class="p">,</span> <span class="s2">&quot;reviewed&quot;</span><span class="p">:</span> <span class="n">reviewed</span> <span class="p">}</span>
    <span class="n">notes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;NOTES&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">mongodb_search_query</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">notes</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="cedars.app.ops.db.get_patients_to_annotate" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">get_patients_to_annotate</span><span class="p">()</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Retrieves a patient that have not been reviewed</p>
      <p>Returns:
    patient_to_annotate: A single patient that needs to manually reviewed</p>

          <details class="quote">
            <summary>Source code in <code>cedars/app/db.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_patients_to_annotate</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrieves a patient that have not been reviewed</span>

<span class="sd">    Args:</span>
<span class="sd">        None</span>
<span class="sd">    Returns:</span>
<span class="sd">        patient_to_annotate: A single patient that needs to manually reviewed </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Retriving all un-reviewed patients from database.&quot;</span><span class="p">)</span>
    <span class="n">patients_to_annotate</span> <span class="o">=</span> <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;PATIENTS&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">({</span><span class="s2">&quot;reviewed&quot;</span> <span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                                                      <span class="s2">&quot;locked&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">})</span>

    <span class="c1"># check is this patient has any unreviewed annotations</span>
    <span class="k">for</span> <span class="n">patient</span> <span class="ow">in</span> <span class="n">patients_to_annotate</span><span class="p">:</span>
        <span class="n">patient_id</span> <span class="o">=</span> <span class="n">patient</span><span class="p">[</span><span class="s2">&quot;patient_id&quot;</span><span class="p">]</span>
        <span class="n">annotations</span> <span class="o">=</span> <span class="n">get_patient_annotation_ids</span><span class="p">(</span><span class="n">patient_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">annotations</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">patient_id</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">continue</span>

    <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="cedars.app.ops.db.get_prediction" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">get_prediction</span><span class="p">(</span><span class="n">note</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <h6 id="cedars.app.ops.db.get_prediction--pines-predictions">PINES predictions</h6>
<p>Get prediction from endpoint. Text goes in the POST request.</p>

          <details class="quote">
            <summary>Source code in <code>cedars/app/db.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">895</span>
<span class="normal">896</span>
<span class="normal">897</span>
<span class="normal">898</span>
<span class="normal">899</span>
<span class="normal">900</span>
<span class="normal">901</span>
<span class="normal">902</span>
<span class="normal">903</span>
<span class="normal">904</span>
<span class="normal">905</span>
<span class="normal">906</span>
<span class="normal">907</span>
<span class="normal">908</span>
<span class="normal">909</span>
<span class="normal">910</span>
<span class="normal">911</span>
<span class="normal">912</span>
<span class="normal">913</span>
<span class="normal">914</span>
<span class="normal">915</span>
<span class="normal">916</span>
<span class="normal">917</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_prediction</span><span class="p">(</span><span class="n">note</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ##### PINES predictions</span>

<span class="sd">    Get prediction from endpoint. Text goes in the POST request.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;PINES_API_URL&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1">/predict&#39;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="n">note</span><span class="p">}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s2">&quot;prediction&quot;</span><span class="p">]</span>
        <span class="n">score</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;score&quot;</span><span class="p">)</span>
        <span class="n">label</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;label&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">score</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">score</span> <span class="k">if</span> <span class="s2">&quot;0&quot;</span> <span class="ow">in</span> <span class="n">label</span> <span class="k">else</span> <span class="n">score</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">score</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">score</span> <span class="k">if</span> <span class="n">label</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">score</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Got prediction for note: </span><span class="si">{</span><span class="n">note</span><span class="si">}</span><span class="s2"> with score: </span><span class="si">{</span><span class="n">score</span><span class="si">}</span><span class="s2"> and label: </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">score</span>
    <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">RequestException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to get prediction for note: </span><span class="si">{</span><span class="n">note</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">e</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="cedars.app.ops.db.get_proj_name" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">get_proj_name</span><span class="p">()</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Returns the name of the current project.</p>
      <p>Returns:
    proj_name (str) : The name of the current CEDARS project.</p>

          <details class="quote">
            <summary>Source code in <code>cedars/app/db.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_proj_name</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the name of the current project.</span>

<span class="sd">    Args:</span>
<span class="sd">        None</span>
<span class="sd">    Returns:</span>
<span class="sd">        proj_name (str) : The name of the current CEDARS project.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">proj_info</span> <span class="o">=</span> <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;INFO&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">find_one_or_404</span><span class="p">()</span>
    <span class="n">proj_name</span> <span class="o">=</span> <span class="n">proj_info</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">proj_name</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="cedars.app.ops.db.get_project_users" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">get_project_users</span><span class="p">()</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Returns all the usernames for approved users (including the admin) for this project</p>
      <p>Returns:
    usernames (list) : List of all usernames for approved users
                       (including the admin) for this project</p>

          <details class="quote">
            <summary>Source code in <code>cedars/app/db.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_project_users</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns all the usernames for approved users (including the admin) for this project</span>

<span class="sd">    Args:</span>
<span class="sd">        None</span>
<span class="sd">    Returns:</span>
<span class="sd">        usernames (list) : List of all usernames for approved users</span>
<span class="sd">                           (including the admin) for this project</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">users</span> <span class="o">=</span> <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;USERS&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">({})</span>

    <span class="k">return</span> <span class="p">[</span><span class="n">user</span><span class="p">[</span><span class="s2">&quot;user&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">users</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="cedars.app.ops.db.get_search_query" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">get_search_query</span><span class="p">()</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>This function is used to get the current search query from the database.
All this data is kept in the QUERY collection.</p>

          <details class="quote">
            <summary>Source code in <code>cedars/app/db.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_search_query</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function is used to get the current search query from the database.</span>
<span class="sd">    All this data is kept in the QUERY collection.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;QUERY&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">find_one</span><span class="p">({</span><span class="s2">&quot;current&quot;</span> <span class="p">:</span> <span class="kc">True</span><span class="p">})</span>

    <span class="k">if</span> <span class="n">query</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">query</span><span class="p">[</span><span class="s2">&quot;query&quot;</span><span class="p">]</span>

    <span class="k">return</span> <span class="s2">&quot;&quot;</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="cedars.app.ops.db.get_total_counts" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">get_total_counts</span><span class="p">(</span><span class="n">collection_name</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Returns the total number of documents in a collection.</p>



<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>collection_name</code></b>
                  (<code>str) </code>)
              –
              <div class="doc-md-description">
                <p>The name of the collection to search.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>      <p>Returns:
    count (int) : The number of documents in the collection.</p>

          <details class="quote">
            <summary>Source code in <code>cedars/app/db.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_total_counts</span><span class="p">(</span><span class="n">collection_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the total number of documents in a collection.</span>

<span class="sd">    Args:</span>
<span class="sd">        collection_name (str) : The name of the collection to search.</span>
<span class="sd">    Returns:</span>
<span class="sd">        count (int) : The number of documents in the collection.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="n">collection_name</span><span class="p">]</span><span class="o">.</span><span class="n">count_documents</span><span class="p">({})</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="cedars.app.ops.db.get_user" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">get_user</span><span class="p">(</span><span class="n">username</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>This function is used to get a user from the database.</p>



<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>username</code></b>
                  (<code>str) </code>)
              –
              <div class="doc-md-description">
                <p>The name of the user to get.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>      <p>Returns:
    user (dict) : The user object from the database.</p>

          <details class="quote">
            <summary>Source code in <code>cedars/app/db.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_user</span><span class="p">(</span><span class="n">username</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function is used to get a user from the database.</span>

<span class="sd">    Args:</span>
<span class="sd">        username (str) : The name of the user to get.</span>
<span class="sd">    Returns:</span>
<span class="sd">        user (dict) : The user object from the database.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;USERS&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">find_one</span><span class="p">({</span><span class="s2">&quot;user&quot;</span> <span class="p">:</span> <span class="n">username</span><span class="p">})</span>
    <span class="k">return</span> <span class="n">user</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="cedars.app.ops.db.insert_one_annotation" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">insert_one_annotation</span><span class="p">(</span><span class="n">annotation</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Adds an annotation to the database.</p>



<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>annotation</code></b>
                  (<code>dict) </code>)
              –
              <div class="doc-md-description">
                <p>The annotation we are inserting</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>      <p>Returns:
    None</p>

          <details class="quote">
            <summary>Source code in <code>cedars/app/db.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">insert_one_annotation</span><span class="p">(</span><span class="n">annotation</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Adds an annotation to the database.</span>

<span class="sd">    Args:</span>
<span class="sd">        annotation (dict) : The annotation we are inserting</span>
<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">annotations_collection</span> <span class="o">=</span> <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;ANNOTATIONS&quot;</span><span class="p">]</span>

    <span class="n">annotations_collection</span><span class="o">.</span><span class="n">insert_one</span><span class="p">(</span><span class="n">annotation</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="cedars.app.ops.db.is_admin_user" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">is_admin_user</span><span class="p">(</span><span class="n">username</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>check if the user is admin</p>

          <details class="quote">
            <summary>Source code in <code>cedars/app/db.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">837</span>
<span class="normal">838</span>
<span class="normal">839</span>
<span class="normal">840</span>
<span class="normal">841</span>
<span class="normal">842</span>
<span class="normal">843</span>
<span class="normal">844</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">is_admin_user</span><span class="p">(</span><span class="n">username</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;check if the user is admin&quot;&quot;&quot;</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;USERS&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">find_one</span><span class="p">({</span><span class="s1">&#39;user&#39;</span> <span class="p">:</span> <span class="n">username</span><span class="p">})</span>

    <span class="k">if</span> <span class="n">user</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">user</span><span class="p">[</span><span class="s2">&quot;is_admin&quot;</span><span class="p">]:</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">return</span> <span class="kc">False</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="cedars.app.ops.db.mark_annotation_reviewed" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">mark_annotation_reviewed</span><span class="p">(</span><span class="n">annotation_id</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Updates the annotation in the database to mark it as reviewed.</p>



<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>annotation_id</code></b>
                  (<code>str) </code>)
              –
              <div class="doc-md-description">
                <p>Unique ID for the annotation.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>      <p>Returns:
    None</p>

          <details class="quote">
            <summary>Source code in <code>cedars/app/db.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">mark_annotation_reviewed</span><span class="p">(</span><span class="n">annotation_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Updates the annotation in the database to mark it as reviewed.</span>

<span class="sd">    Args:</span>
<span class="sd">        annotation_id (str) : Unique ID for the annotation.</span>
<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Marking annotation #</span><span class="si">{</span><span class="n">annotation_id</span><span class="si">}</span><span class="s2"> as reviewed.&quot;</span><span class="p">)</span>
    <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;ANNOTATIONS&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update_one</span><span class="p">({</span><span class="s2">&quot;_id&quot;</span> <span class="p">:</span> <span class="n">ObjectId</span><span class="p">(</span><span class="n">annotation_id</span><span class="p">)},</span>
                                       <span class="p">{</span><span class="s2">&quot;$set&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;reviewed&quot;</span><span class="p">:</span> <span class="kc">True</span> <span class="p">}</span> <span class="p">})</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="cedars.app.ops.db.mark_note_reviewed" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">mark_note_reviewed</span><span class="p">(</span><span class="n">note_id</span><span class="p">,</span> <span class="n">reviewed_by</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Updates the note's status to reviewed in the database.</p>

          <details class="quote">
            <summary>Source code in <code>cedars/app/db.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">mark_note_reviewed</span><span class="p">(</span><span class="n">note_id</span><span class="p">,</span> <span class="n">reviewed_by</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Updates the note&#39;s status to reviewed in the database.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Marking note #</span><span class="si">{</span><span class="n">note_id</span><span class="si">}</span><span class="s2"> as reviewed.&quot;</span><span class="p">)</span>
    <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;NOTES&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update_one</span><span class="p">({</span><span class="s2">&quot;text_id&quot;</span> <span class="p">:</span> <span class="n">note_id</span><span class="p">},</span>
                                 <span class="p">{</span> <span class="s2">&quot;$set&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;reviewed&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                                             <span class="s2">&quot;reviewed_by&quot;</span><span class="p">:</span> <span class="n">reviewed_by</span><span class="p">}</span> <span class="p">})</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="cedars.app.ops.db.mark_patient_reviewed" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">mark_patient_reviewed</span><span class="p">(</span><span class="n">patient_id</span><span class="p">,</span> <span class="n">reviewed_by</span><span class="p">,</span> <span class="n">is_reviewed</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Updates the patient's status to reviewed in the database.</p>



<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>patient_id</code></b>
                  (<code>int) </code>)
              –
              <div class="doc-md-description">
                <p>Unique ID for a patient.</p>
              </div>
            </li>
            <li>
              <b><code>reviewed_by</code></b>
                  (<code>str) </code>)
              –
              <div class="doc-md-description">
                <p>The name of the user who reviewed the patient.</p>
              </div>
            </li>
            <li>
              <b><code>is_reviewed</code></b>
                  (<code>bool) </code>, default:
                      <code>True</code>
)
              –
              <div class="doc-md-description">
                <p>True if patient's annotations have been reviewed.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>      <p>Returns:
    None</p>

          <details class="quote">
            <summary>Source code in <code>cedars/app/db.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">mark_patient_reviewed</span><span class="p">(</span><span class="n">patient_id</span><span class="p">,</span> <span class="n">reviewed_by</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">is_reviewed</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Updates the patient&#39;s status to reviewed in the database.</span>

<span class="sd">    Args:</span>
<span class="sd">        patient_id (int) : Unique ID for a patient.</span>
<span class="sd">        reviewed_by (str) : The name of the user who reviewed the patient.</span>
<span class="sd">        is_reviewed (bool) : True if patient&#39;s annotations have been reviewed.</span>
<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Marking patient #</span><span class="si">{</span><span class="n">patient_id</span><span class="si">}</span><span class="s2"> as reviewed.&quot;</span><span class="p">)</span>
    <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;PATIENTS&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update_one</span><span class="p">({</span><span class="s2">&quot;patient_id&quot;</span> <span class="p">:</span> <span class="n">patient_id</span><span class="p">},</span>
                                                    <span class="p">{</span> <span class="s2">&quot;$set&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;reviewed&quot;</span><span class="p">:</span> <span class="n">is_reviewed</span><span class="p">,</span>
                                                               <span class="s2">&quot;reviewed_by&quot;</span><span class="p">:</span> <span class="n">reviewed_by</span> <span class="p">}</span> <span class="p">})</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="cedars.app.ops.db.populate_annotations" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">populate_annotations</span><span class="p">()</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>This function creates the annotations and patients collections in the mongodb database.
The annotations collection is used to store the NLP annotations generated by our NLP model.
The patients collection is used to store the patient ids as well as their current status.</p>

          <details class="quote">
            <summary>Source code in <code>cedars/app/db.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">populate_annotations</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function creates the annotations and patients collections in the mongodb database.</span>
<span class="sd">    The annotations collection is used to store the NLP annotations generated by our NLP model.</span>
<span class="sd">    The patients collection is used to store the patient ids as well as their current status.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">annotations</span> <span class="o">=</span> <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;ANNOTATIONS&quot;</span><span class="p">]</span>


    <span class="n">annotations</span><span class="o">.</span><span class="n">create_index</span><span class="p">(</span><span class="s2">&quot;patient_id&quot;</span><span class="p">,</span> <span class="n">unique</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">annotations</span><span class="o">.</span><span class="n">create_index</span><span class="p">(</span><span class="s2">&quot;note_id&quot;</span><span class="p">,</span> <span class="n">unique</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">annotations</span><span class="o">.</span><span class="n">create_index</span><span class="p">(</span><span class="s2">&quot;text_id&quot;</span><span class="p">,</span> <span class="n">unique</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">annotations</span><span class="o">.</span><span class="n">create_index</span><span class="p">(</span><span class="s2">&quot;sentence_number&quot;</span><span class="p">,</span> <span class="n">unique</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">annotations</span><span class="o">.</span><span class="n">create_index</span><span class="p">(</span><span class="s2">&quot;start_index&quot;</span><span class="p">,</span> <span class="n">unique</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Created ANNOTATIONS collection.&quot;</span><span class="p">)</span>

    <span class="c1"># This statement is used to create a collection.</span>
    <span class="n">patients</span> <span class="o">=</span> <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;PATIENTS&quot;</span><span class="p">]</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Created </span><span class="si">{</span><span class="n">patients</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> collection.&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="cedars.app.ops.db.populate_notes" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">populate_notes</span><span class="p">()</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>This function creates the notes collection in the mongodb database.
The notes collection is used to store the patient's medical records.</p>

          <details class="quote">
            <summary>Source code in <code>cedars/app/db.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span>
<span class="normal">94</span>
<span class="normal">95</span>
<span class="normal">96</span>
<span class="normal">97</span>
<span class="normal">98</span>
<span class="normal">99</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">populate_notes</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function creates the notes collection in the mongodb database.</span>
<span class="sd">    The notes collection is used to store the patient&#39;s medical records.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">notes</span> <span class="o">=</span> <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;NOTES&quot;</span><span class="p">]</span>

    <span class="n">notes</span><span class="o">.</span><span class="n">create_index</span><span class="p">(</span><span class="s2">&quot;patient_id&quot;</span><span class="p">,</span> <span class="n">unique</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">notes</span><span class="o">.</span><span class="n">create_index</span><span class="p">(</span><span class="s2">&quot;doc_id&quot;</span><span class="p">,</span> <span class="n">unique</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">notes</span><span class="o">.</span><span class="n">create_index</span><span class="p">(</span><span class="s2">&quot;text_id&quot;</span><span class="p">,</span> <span class="n">unique</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Created NOTES collection.&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="cedars.app.ops.db.populate_patients" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">populate_patients</span><span class="p">()</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>This function creates the notes collection in the mongodb database.
The notes collection is used to store the patient's medical records.</p>

          <details class="quote">
            <summary>Source code in <code>cedars/app/db.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">populate_patients</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function creates the notes collection in the mongodb database.</span>
<span class="sd">    The notes collection is used to store the patient&#39;s medical records.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">notes</span> <span class="o">=</span> <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;Patients&quot;</span><span class="p">]</span>

    <span class="n">notes</span><span class="o">.</span><span class="n">create_index</span><span class="p">(</span><span class="s2">&quot;patient_id&quot;</span><span class="p">,</span> <span class="n">unique</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Created Patients collection.&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="cedars.app.ops.db.populate_query" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">populate_query</span><span class="p">()</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>This function creates the query collection in the mongodb database.
The query collection is used to store the regex queries that researchrs are using.</p>

          <details class="quote">
            <summary>Source code in <code>cedars/app/db.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">populate_query</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function creates the query collection in the mongodb database.</span>
<span class="sd">    The query collection is used to store the regex queries that researchrs are using.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Pylint disabled for pointless statement.</span>
    <span class="c1"># This statement is used to create a collection.</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;QUERY&quot;</span><span class="p">]</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Created </span><span class="si">%s</span><span class="s2"> collection.&quot;</span><span class="p">,</span> <span class="n">query</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="cedars.app.ops.db.populate_users" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">populate_users</span><span class="p">()</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>This function creates the users collection in the mongodb database.
The users collection is used to store the credentials of users of the CEDARS system.</p>

          <details class="quote">
            <summary>Source code in <code>cedars/app/db.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">populate_users</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function creates the users collection in the mongodb database.</span>
<span class="sd">    The users collection is used to store the credentials of users of the CEDARS system.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">users</span> <span class="o">=</span> <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;USERS&quot;</span><span class="p">]</span>

    <span class="n">users</span><span class="o">.</span><span class="n">create_index</span><span class="p">(</span><span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="n">unique</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Created USERS collection.&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="cedars.app.ops.db.predict_and_save" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">predict_and_save</span><span class="p">(</span><span class="n">text_ids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">note_collection_name</span><span class="o">=</span><span class="s1">&#39;NOTES&#39;</span><span class="p">,</span> <span class="n">pines_collection_name</span><span class="o">=</span><span class="s1">&#39;PINES&#39;</span><span class="p">,</span> <span class="n">force_update</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <h6 id="cedars.app.ops.db.predict_and_save--save-pines-predictions">Save PINES predictions</h6>
<p>Predict and save the predictions for the given text_ids.</p>

          <details class="quote">
            <summary>Source code in <code>cedars/app/db.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">943</span>
<span class="normal">944</span>
<span class="normal">945</span>
<span class="normal">946</span>
<span class="normal">947</span>
<span class="normal">948</span>
<span class="normal">949</span>
<span class="normal">950</span>
<span class="normal">951</span>
<span class="normal">952</span>
<span class="normal">953</span>
<span class="normal">954</span>
<span class="normal">955</span>
<span class="normal">956</span>
<span class="normal">957</span>
<span class="normal">958</span>
<span class="normal">959</span>
<span class="normal">960</span>
<span class="normal">961</span>
<span class="normal">962</span>
<span class="normal">963</span>
<span class="normal">964</span>
<span class="normal">965</span>
<span class="normal">966</span>
<span class="normal">967</span>
<span class="normal">968</span>
<span class="normal">969</span>
<span class="normal">970</span>
<span class="normal">971</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">predict_and_save</span><span class="p">(</span><span class="n">text_ids</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                     <span class="n">note_collection_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;NOTES&quot;</span><span class="p">,</span>
                     <span class="n">pines_collection_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;PINES&quot;</span><span class="p">,</span>
                     <span class="n">force_update</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ##### Save PINES predictions</span>

<span class="sd">    Predict and save the predictions for the given text_ids.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">notes_collection</span> <span class="o">=</span> <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="n">note_collection_name</span><span class="p">]</span>
    <span class="n">pines_collection</span> <span class="o">=</span> <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="n">pines_collection_name</span><span class="p">]</span>
    <span class="n">query</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">text_ids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">query</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;text_id&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$in&quot;</span><span class="p">:</span> <span class="n">text_ids</span><span class="p">}}</span>

    <span class="n">cedars_notes</span> <span class="o">=</span> <span class="n">notes_collection</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">note</span> <span class="ow">in</span> <span class="n">cedars_notes</span><span class="p">:</span>
        <span class="n">note_id</span> <span class="o">=</span> <span class="n">note</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;text_id&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">force_update</span> <span class="ow">or</span> <span class="n">get_note_prediction_from_db</span><span class="p">(</span><span class="n">note_id</span><span class="p">,</span> <span class="n">pines_collection_name</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Predicting for note: </span><span class="si">{</span><span class="n">note_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">prediction</span> <span class="o">=</span> <span class="n">get_prediction</span><span class="p">(</span><span class="n">note</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">))</span>
            <span class="n">pines_collection</span><span class="o">.</span><span class="n">insert_one</span><span class="p">({</span>
                <span class="s2">&quot;text_id&quot;</span><span class="p">:</span> <span class="n">note_id</span><span class="p">,</span>
                <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">note</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">),</span>
                <span class="s2">&quot;patient_id&quot;</span><span class="p">:</span> <span class="n">note</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;patient_id&quot;</span><span class="p">),</span>
                <span class="s2">&quot;predicted_score&quot;</span><span class="p">:</span> <span class="n">prediction</span><span class="p">,</span>
                <span class="s2">&quot;report_type&quot;</span><span class="p">:</span> <span class="n">note</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;text_tag_3&quot;</span><span class="p">),</span>
                <span class="s2">&quot;document_type&quot;</span><span class="p">:</span> <span class="n">note</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;text_tag_1&quot;</span><span class="p">)</span>
                <span class="p">})</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="cedars.app.ops.db.remove_all_locked" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">remove_all_locked</span><span class="p">()</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Sets the locked status of all patients to False.
This is done when the server is shutting down.</p>

          <details class="quote">
            <summary>Source code in <code>cedars/app/db.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">remove_all_locked</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sets the locked status of all patients to False.</span>
<span class="sd">    This is done when the server is shutting down.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">patients_collection</span> <span class="o">=</span> <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;PATIENTS&quot;</span><span class="p">]</span>
    <span class="n">patients_collection</span><span class="o">.</span><span class="n">update_many</span><span class="p">({},</span>
                                    <span class="p">{</span> <span class="s2">&quot;$set&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;locked&quot;</span><span class="p">:</span> <span class="kc">False</span> <span class="p">}</span> <span class="p">})</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="cedars.app.ops.db.reset_patient_reviewed" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">reset_patient_reviewed</span><span class="p">()</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Update all patients, notes to be un-reviewed.</p>

          <details class="quote">
            <summary>Source code in <code>cedars/app/db.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">reset_patient_reviewed</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Update all patients, notes to be un-reviewed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;PATIENTS&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update_many</span><span class="p">({},</span>
                                     <span class="p">{</span> <span class="s2">&quot;$set&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;reviewed&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                                                <span class="s2">&quot;reviewed_by&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                                                 <span class="s2">&quot;comments&quot;</span><span class="p">:</span> <span class="p">[]</span> <span class="p">}</span> <span class="p">})</span>
    <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;NOTES&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update_many</span><span class="p">({},</span> <span class="p">{</span> <span class="s2">&quot;$set&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;reviewed&quot;</span><span class="p">:</span> <span class="kc">False</span> <span class="p">}</span> <span class="p">})</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="cedars.app.ops.db.save_query" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">save_query</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">exclude_negated</span><span class="p">,</span> <span class="n">hide_duplicates</span><span class="p">,</span> <span class="n">skip_after_event</span><span class="p">,</span> <span class="n">tag_query</span><span class="p">,</span> <span class="n">date_min</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">date_max</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>This function is used to save a regex query to the database.
All this data is kept in the QUERY collection.</p>



<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>query</code></b>
                  (<code>str) </code>)
              –
              <div class="doc-md-description">
                <p>The regex query.</p>
              </div>
            </li>
            <li>
              <b><code>exclude_negated</code></b>
                  (<code>bool) </code>)
              –
              <div class="doc-md-description">
                <p>True if we want to exclude negated tokens.</p>
              </div>
            </li>
            <li>
              <b><code>hide_duplicates</code></b>
                  (<code>bool) </code>)
              –
              <div class="doc-md-description">
                <p>True if we want to restrict duplicate queries.</p>
              </div>
            </li>
            <li>
              <b><code>skip_after_event</code></b>
                  (<code>bool) </code>)
              –
              <div class="doc-md-description">
                <p>True if sentences occurring
                        after a recorded clinical event are to be skipped.</p>
              </div>
            </li>
            <li>
              <b><code>tag_query</code></b>
                  (<code>dict of mapping [str </code>)
              –
              <div class="doc-md-description">
                <p>list]) :
                        Key words to include or exclude in the search.</p>
              </div>
            </li>
            <li>
              <b><code>date_min</code></b>
                  (<code>str) </code>, default:
                      <code>None</code>
)
              –
              <div class="doc-md-description">
                <p>Smallest date for valid query.</p>
              </div>
            </li>
            <li>
              <b><code>date_max</code></b>
                  (<code>str) </code>, default:
                      <code>None</code>
)
              –
              <div class="doc-md-description">
                <p>Greatest date for valid query.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>      <p>Returns:
    None</p>

          <details class="quote">
            <summary>Source code in <code>cedars/app/db.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">save_query</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">exclude_negated</span><span class="p">,</span> <span class="n">hide_duplicates</span><span class="p">,</span> <span class="c1">#pylint: disable=R0913</span>
                <span class="n">skip_after_event</span><span class="p">,</span> <span class="n">tag_query</span><span class="p">,</span> <span class="n">date_min</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">date_max</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function is used to save a regex query to the database.</span>
<span class="sd">    All this data is kept in the QUERY collection.</span>

<span class="sd">    Args:</span>
<span class="sd">        query (str) : The regex query.</span>
<span class="sd">        exclude_negated (bool) : True if we want to exclude negated tokens.</span>
<span class="sd">        hide_duplicates (bool) : True if we want to restrict duplicate queries.</span>
<span class="sd">        skip_after_event (bool) : True if sentences occurring</span>
<span class="sd">                                    after a recorded clinical event are to be skipped.</span>
<span class="sd">        tag_query (dict of mapping [str : list]) :</span>
<span class="sd">                                    Key words to include or exclude in the search.</span>
<span class="sd">        date_min (str) : Smallest date for valid query.</span>
<span class="sd">        date_max (str) : Greatest date for valid query.</span>
<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">info</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;query&quot;</span> <span class="p">:</span> <span class="n">query</span><span class="p">,</span>
        <span class="s2">&quot;exclude_negated&quot;</span> <span class="p">:</span> <span class="n">exclude_negated</span><span class="p">,</span>
        <span class="s2">&quot;hide_duplicates&quot;</span> <span class="p">:</span> <span class="n">hide_duplicates</span><span class="p">,</span>
        <span class="s2">&quot;skip_after_event&quot;</span> <span class="p">:</span> <span class="n">skip_after_event</span><span class="p">,</span>
        <span class="s2">&quot;tag_query&quot;</span> <span class="p">:</span> <span class="n">tag_query</span><span class="p">,</span>
        <span class="s2">&quot;date_min&quot;</span> <span class="p">:</span> <span class="n">date_min</span><span class="p">,</span>
        <span class="s2">&quot;date_max&quot;</span> <span class="p">:</span> <span class="n">date_max</span>
    <span class="p">}</span>

    <span class="n">collection</span> <span class="o">=</span> <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;QUERY&quot;</span><span class="p">]</span>
    <span class="c1"># only one query is current at a time.</span>
    <span class="c1"># TODO: make a query history and enable multiple queries.</span>
    <span class="n">info</span><span class="p">[</span><span class="s2">&quot;current&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">collection</span><span class="o">.</span><span class="n">update_one</span><span class="p">({</span><span class="s2">&quot;current&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span> <span class="p">{</span><span class="s2">&quot;$set&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;current&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}})</span>
    <span class="n">collection</span><span class="o">.</span><span class="n">insert_one</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved query : </span><span class="si">{</span><span class="n">query</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="cedars.app.ops.db.set_patient_lock_status" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">set_patient_lock_status</span><span class="p">(</span><span class="n">patient_id</span><span class="p">,</span> <span class="n">status</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Updates the status of the patient to be locked or unlocked.</p>



<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>patient_id</code></b>
                  (<code>int) </code>)
              –
              <div class="doc-md-description">
                <p>ID for the patient we are locking / unlocking</p>
              </div>
            </li>
            <li>
              <b><code>status</code></b>
                  (<code>bool) </code>)
              –
              <div class="doc-md-description">
                <p>True if the patient is being locked, False otherwise.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
    <th class="field-name">Returns:</th>
    <td class="field-body">
      <ul class="first simple">
          <li>
            –
            <div class="doc-md-description">
              <p>None</p>
            </div>
          </li>
      </ul>
    </td>
    </tr>
  </tbody>
</table>
          <details class="quote">
            <summary>Source code in <code>cedars/app/db.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">set_patient_lock_status</span><span class="p">(</span><span class="n">patient_id</span><span class="p">,</span> <span class="n">status</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Updates the status of the patient to be locked or unlocked.</span>

<span class="sd">    Args:</span>
<span class="sd">        patient_id (int) : ID for the patient we are locking / unlocking</span>
<span class="sd">        status (bool) : True if the patient is being locked, False otherwise.</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>


    <span class="n">patients_collection</span> <span class="o">=</span> <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;PATIENTS&quot;</span><span class="p">]</span>
    <span class="n">patients_collection</span><span class="o">.</span><span class="n">update_one</span><span class="p">({</span><span class="s2">&quot;patient_id&quot;</span> <span class="p">:</span> <span class="n">patient_id</span><span class="p">},</span>
                                   <span class="p">{</span> <span class="s2">&quot;$set&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;locked&quot;</span><span class="p">:</span> <span class="n">status</span> <span class="p">}</span> <span class="p">})</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="cedars.app.ops.db.terminate_project" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">terminate_project</span><span class="p">()</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <h6 id="cedars.app.ops.db.terminate_project--terminate-the-project">Terminate the Project</h6>
<p>Reset the database to the initial state.</p>

          <details class="quote">
            <summary>Source code in <code>cedars/app/db.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">974</span>
<span class="normal">975</span>
<span class="normal">976</span>
<span class="normal">977</span>
<span class="normal">978</span>
<span class="normal">979</span>
<span class="normal">980</span>
<span class="normal">981</span>
<span class="normal">982</span>
<span class="normal">983</span>
<span class="normal">984</span>
<span class="normal">985</span>
<span class="normal">986</span>
<span class="normal">987</span>
<span class="normal">988</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">terminate_project</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ##### Terminate the Project</span>

<span class="sd">    Reset the database to the initial state.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Terminating project.&quot;</span><span class="p">)</span>
    <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">drop_collection</span><span class="p">(</span><span class="s2">&quot;ANNOTATIONS&quot;</span><span class="p">)</span>
    <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">drop_collection</span><span class="p">(</span><span class="s2">&quot;NOTES&quot;</span><span class="p">)</span>
    <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">drop_collection</span><span class="p">(</span><span class="s2">&quot;PATIENTS&quot;</span><span class="p">)</span>
    <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">drop_collection</span><span class="p">(</span><span class="s2">&quot;USERS&quot;</span><span class="p">)</span>
    <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">drop_collection</span><span class="p">(</span><span class="s2">&quot;QUERY&quot;</span><span class="p">)</span>
    <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">drop_collection</span><span class="p">(</span><span class="s2">&quot;PINES&quot;</span><span class="p">)</span>
    <span class="n">create_project</span><span class="p">(</span><span class="n">project_name</span><span class="o">=</span><span class="n">fake</span><span class="o">.</span><span class="n">slug</span><span class="p">(),</span>
                   <span class="n">investigator_name</span><span class="o">=</span><span class="n">fake</span><span class="o">.</span><span class="n">name</span><span class="p">())</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="cedars.app.ops.db.update_annotation_date" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">update_annotation_date</span><span class="p">(</span><span class="n">annotation_id</span><span class="p">,</span> <span class="n">new_date</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Enters a new event date for an annotation.</p>



<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>annotation_id</code></b>
                  (<code>str) </code>)
              –
              <div class="doc-md-description">
                <p>Unique ID for the annotation.</p>
              </div>
            </li>
            <li>
              <b><code>new_date</code></b>
                  (<code>str) </code>)
              –
              <div class="doc-md-description">
                <p>The new value to update the event date of an annotation with.
Must be in the format YYYY-MM-DD .</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>      <p>Returns:
    None</p>

          <details class="quote">
            <summary>Source code in <code>cedars/app/db.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">update_annotation_date</span><span class="p">(</span><span class="n">annotation_id</span><span class="p">,</span> <span class="n">new_date</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Enters a new event date for an annotation.</span>

<span class="sd">    Args:</span>
<span class="sd">        annotation_id (str) : Unique ID for the annotation.</span>
<span class="sd">        new_date (str) : The new value to update the event date of an annotation with.</span>
<span class="sd">            Must be in the format YYYY-MM-DD .</span>
<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO: UTC dates</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Updating date on annotation #</span><span class="si">{</span><span class="n">annotation_id</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">new_date</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
    <span class="n">date_format</span> <span class="o">=</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span>
    <span class="n">datetime_obj</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">new_date</span><span class="p">,</span> <span class="n">date_format</span><span class="p">)</span>
    <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;ANNOTATIONS&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update_one</span><span class="p">({</span><span class="s2">&quot;_id&quot;</span> <span class="p">:</span> <span class="n">ObjectId</span><span class="p">(</span><span class="n">annotation_id</span><span class="p">)},</span>
                                       <span class="p">{</span> <span class="s2">&quot;$set&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;event_date&quot;</span> <span class="p">:</span> <span class="n">datetime_obj</span> <span class="p">}</span> <span class="p">})</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="cedars.app.ops.db.update_annotation_reviewed" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">update_annotation_reviewed</span><span class="p">(</span><span class="n">note_id</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Mark all annotations for a note as reviewed.</p>



<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>note_id</code></b>
                  (<code>str) </code>)
              –
              <div class="doc-md-description">
                <p>The note_id for which we want to mark all annotations as reviewed.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>      <p>Returns:
    count (int) : The number of annotations that were marked as reviewed.</p>

          <details class="quote">
            <summary>Source code in <code>cedars/app/db.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span>
<span class="normal">799</span>
<span class="normal">800</span>
<span class="normal">801</span>
<span class="normal">802</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">update_annotation_reviewed</span><span class="p">(</span><span class="n">note_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Mark all annotations for a note as reviewed.</span>

<span class="sd">    Args:</span>
<span class="sd">        note_id (str) : The note_id for which we want to mark all annotations as reviewed.</span>
<span class="sd">    Returns:</span>
<span class="sd">        count (int) : The number of annotations that were marked as reviewed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">annotations_collection</span> <span class="o">=</span> <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;ANNOTATIONS&quot;</span><span class="p">]</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">annotations_collection</span><span class="o">.</span><span class="n">update_many</span><span class="p">({</span><span class="s2">&quot;note_id&quot;</span><span class="p">:</span> <span class="n">note_id</span><span class="p">},</span>
                                               <span class="p">{</span><span class="s2">&quot;$set&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;reviewed&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}})</span>
    <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">modified_count</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="cedars.app.ops.db.update_project_name" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">update_project_name</span><span class="p">(</span><span class="n">new_name</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Updates the project name in the INFO collection of the database.</p>



<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>new_name</code></b>
                  (<code>str) </code>)
              –
              <div class="doc-md-description">
                <p>New name of the project.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>      <p>Returns:
    None</p>

          <details class="quote">
            <summary>Source code in <code>cedars/app/db.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">update_project_name</span><span class="p">(</span><span class="n">new_name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Updates the project name in the INFO collection of the database.</span>

<span class="sd">    Args:</span>
<span class="sd">        new_name (str) : New name of the project.</span>
<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Updating project name to #</span><span class="si">{</span><span class="n">new_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;INFO&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update_one</span><span class="p">({},</span> <span class="p">{</span> <span class="s2">&quot;$set&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;project&quot;</span><span class="p">:</span> <span class="n">new_name</span> <span class="p">}</span> <span class="p">})</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="cedars.app.ops.db.upload_notes" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">upload_notes</span><span class="p">(</span><span class="n">documents</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>This function is used to take a dataframe of patient records
and save it to the mongodb database.</p>



<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>documents</code></b>
                  (<code>pandas dataframe) </code>)
              –
              <div class="doc-md-description">
                <p>Dataframe with all the records of a paticular patient.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>      <p>Returns:
    None</p>

          <details class="quote">
            <summary>Source code in <code>cedars/app/db.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">upload_notes</span><span class="p">(</span><span class="n">documents</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function is used to take a dataframe of patient records</span>
<span class="sd">    and save it to the mongodb database.</span>

<span class="sd">    Args:</span>
<span class="sd">        documents (pandas dataframe) : Dataframe with all the records of a paticular patient.</span>
<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">notes_collection</span> <span class="o">=</span> <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;NOTES&quot;</span><span class="p">]</span>
    <span class="n">patient_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">documents</span><span class="p">)):</span>
        <span class="n">note_info</span> <span class="o">=</span> <span class="n">documents</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>

        <span class="n">date_format</span> <span class="o">=</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span>
        <span class="n">datetime_obj</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">note_info</span><span class="p">[</span><span class="s2">&quot;text_date&quot;</span><span class="p">],</span> <span class="n">date_format</span><span class="p">)</span>
        <span class="n">note_info</span><span class="p">[</span><span class="s2">&quot;text_date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime_obj</span>
        <span class="n">note_info</span><span class="p">[</span><span class="s2">&quot;reviewed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># text_id should be unique</span>
        <span class="n">notes_collection</span><span class="o">.</span><span class="n">insert_one</span><span class="p">(</span><span class="n">note_info</span><span class="p">)</span>
        <span class="n">patient_ids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">note_info</span><span class="p">[</span><span class="s2">&quot;patient_id&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Uploaded </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">documents</span><span class="p">)</span><span class="si">}</span><span class="s2"> notes&quot;</span><span class="p">)</span>

    <span class="n">patients_collection</span> <span class="o">=</span> <span class="n">mongo</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s2">&quot;PATIENTS&quot;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">p_id</span> <span class="ow">in</span> <span class="n">patient_ids</span><span class="p">:</span>
        <span class="n">patient_info</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;patient_id&quot;</span><span class="p">:</span> <span class="n">p_id</span><span class="p">,</span>
                        <span class="s2">&quot;reviewed&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                        <span class="s2">&quot;locked&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                        <span class="s2">&quot;updated&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                        <span class="s2">&quot;admin_locked&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">patients_collection</span><span class="o">.</span><span class="n">find_one</span><span class="p">({</span><span class="s2">&quot;patient_id&quot;</span><span class="p">:</span> <span class="n">p_id</span><span class="p">}):</span>
            <span class="n">patients_collection</span><span class="o">.</span><span class="n">insert_one</span><span class="p">(</span><span class="n">patient_info</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>



  </div>

  </div>

</div>
              
            </div>
          </div><footer>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
